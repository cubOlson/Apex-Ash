<head>
  <title>Lost ark Production</title>
  <meta description="Effects for Lost Ark" />
  <meta publisher="SignalRGB" />

  <meta property="keyScreenBrightness" label="Ambience brightness" type="number" min="0" max="100" default="100" />
  <meta property="playerClass" label="Main Class" type="combobox"
    values="Warrior,Martial Artist,Gunner,Mage,Assassin"
    default="Warrior" />
  <meta property="healthToggle" label="enable Health effects" type="boolean" default="1" />
  <meta property="manaToggle" label="enable Mana effects" type="boolean" default="1" />
  <meta property="skillToggle" label="enable skill effects" type="boolean" default="1" />
  <meta property="dialogueToggle" label="enable dialogue effects" type="boolean" default="1" />
  <meta property="levelToggle" label="enable leveling effects" type="boolean" default="1" />
  <meta property="mountToggle" label="enable mounted effects" type="boolean" default="1" />
  <meta property="questToggle" label="enable quest effects" type="boolean" default="1" />
  <meta property="adjToggle" label="Adjustment Toggle (turn off in-game)" type="boolean" default="0" />
  <meta property="healthColor" label="Health Bar Color" type="color" default="#ff0000" min="0" max="360" />
  <meta property="healthBarX" label="HealthBarX" type="number" min="0" max="320" default="0" />
  <meta property="healthBarY" label="HealthBarY" type="number" min="0" max="200" default="55" />
  <meta property="healthBarWidth" label="HealthBarWidth" type="number" min="0" max="320" default="320" />
  <meta property="healthBarHeight" label="HealthBarHeight" type="number" min="0" max="200" default="20" />
  <meta property="manaColor" label="Health Bar Color" type="color" default="#00a8ff" min="0" max="360" />
  <meta property="manaBarX" label="HealthBarX" type="number" min="0" max="320" default="0" />
  <meta property="manaBarY" label="HealthBarY" type="number" min="0" max="200" default="75" />
  <meta property="manaBarWidth" label="HealthBarWidth" type="number" min="0" max="320" default="320" />
  <meta property="manaBarHeight" label="HealthBarHeight" type="number" min="0" max="200" default="20" />

  <meta meter="healthBar" tags="VLC,Lost" type="area" x="0.328" y="0.8999" width=".123" height="0.0001" h="0-360"
    s="30-100" l="20-100">
  </meta>

  <meta meter="manaBar" tags="VLC,Lost" type="area" x="0.5492" y="0.8996" width=".1235" height="0.0001" h="190-242"
    s="36-100" l="25-95">
  </meta>

  <meta meter="levelBarCombat" tags="VLC,Lost" type="area" x="0.0012" y="0.9944" width=".9968" height="0.0001"
    h="170-242" s="0-100" l="25-100">
  </meta>

  <meta meter="levelBarRoster" tags="VLC,Lost" type="area" x="0.0012" y="0.9944" width=".9968" height="0.0001"
    h="251-271" s="68-98" l="43-100">
  </meta>

  <meta meter="inGame" tags="VLC,Lost" type="linear" x="0.8430" y="0.9549" width="" height="" h="0-360" s="0-34"
    l="62-100">
  </meta>

  <meta meter="dismountGreenArrow" tags="VLC,Lost" type="area" x="0.4473" y="0.9271" width="0.001" height="0.001"
    h="130-150" s="35-75" l="56-100">
  </meta>

  <meta meter="mountBlack" tags="VLC,Lost" type="area" x="0.4906" y="0.8889" width="0.001" height="0.001" h="0-360"
    s="0-30" l="0-25">
  </meta>

  <meta meter="speakCharacter" tags="VLC,Lost" type="area" x="0.5035" y="0.9049" width="0.001" height="0.001" h="51-71"
    s="0-77" l="75-100">
  </meta>

  <meta meter="speakCharacterLeave" tags="VLC,Lost" type="area" x="0.9381" y="0.9556" width="0.001" height="0.0001"
    h="0-360" s="0-30" l="75-100">
  <resolution size="2560x1440" x="0.9371" y="0.9549" width="0.001" height="0.0001" />
  </meta>

  <meta meter="swordQuestComplete" tags="VLC,Lost" type="area" x="0.5000" y="0.0583" width=".001" height=".001"
    h="44-64" s="43-80" l="62-100">
  </meta>

  <meta meter="questCompleteConfirmationBrown" tags="VLC,Lost" type="area" x="0.5184" y="0.1944" width=".001"
    height=".001" h="25-45" s="20-60" l="0-45">
  </meta>

  <meta meter="questCompleteConfirmationYellow" tags="VLC,Lost" type="area" x="0.5508" y="0.1132" width=".001"
    height=".001" h="31-51" s="39-59" l="53-100">
  </meta>

  <meta meter="skill1" tags="VLC,Lost" type="colormean" x="0.3557" y="0.9065" width="0.0073" height="0.0111" h="0-10" s="0-20" l="88-100" >
  </meta> 
  <meta meter="skill2" tags="VLC,Lost" type="colormean" x="0.3813" y="0.9065" width="0.0073" height="0.0111" h="0-10" s="0-20" l="88-100" >
  </meta> 
  <meta meter="skill3" tags="VLC,Lost" type="colormean" x="0.4052" y="0.9065" width="0.0073" height="0.0111" h="0-10" s="0-20" l="88-100" >
  </meta> 
  <meta meter="skill4" tags="VLC,Lost" type="colormean" x="0.4302" y="0.9065" width="0.0073" height="0.0111" h="0-10" s="0-20" l="88-100" >
  </meta> 
  <meta meter="skill5" tags="VLC,Lost" type="colormean" x="0.3682" y="0.9509" width="0.0073" height="0.0111" h="0-10" s="0-20" l="88-100" >
  </meta> 
  <meta meter="skill6" tags="VLC,Lost" type="colormean" x="0.3927" y="0.9509" width="0.0073" height="0.0111" h="0-10" s="0-20" l="88-100" >
  </meta> 
  <meta meter="skill7" tags="VLC,Lost" type="colormean" x="0.4172" y="0.9509" width="0.0073" height="0.0111" h="0-10" s="0-20" l="88-100" >
  </meta> 
  <meta meter="skill8" tags="VLC,Lost" type="colormean" x="0.4417" y="0.9509" width="0.0073" height="0.0111" h="0-10" s="0-20" l="88-100" >
  </meta> 


</head>

<body style="margin: 0; padding: 0; background: #000;">
  <canvas id="exCanvas" width="320" height="200"></canvas>
</body>

<script>
  var canvas, ctx;
  canvas = document.getElementById('exCanvas');
  ctx = canvas.getContext('2d');
  var width = 320;
  var height = 200;
  var mountActive = false;
  var stateHdlr = new StateHandler();
  var effects = [];
  var playingGame = false;
  var speakingActive = false;
  var questPlaying = false;
  var skillCount = 0;
  var healthMeter = new Meter(5, inGameChanged)
  var manaMeter = new Meter(5, () => "")
  var inGameMeter = new Meter(5, inGameChanged)
  var dismountGreenArrowMeter = new Meter(5, mountChanged)
  var mountBlackMeter = new Meter(5, mountChanged)
  var speakCharacterMeter = new Meter(5, speakChanged)
  var speakCharacterLeaveMeter = new Meter(5, speakChanged)
  var swordQuestCompleteMeter = new Meter(5, questComplete)
  var questCompleteConfirmationBrownMeter = new Meter(5, questComplete)
  var questCompleteConfirmationYellowMeter = new Meter(5, questComplete)
  var skill1Meter = new Meter(3, skillHandler)
  var skill2Meter = new Meter(3, skillHandler)
  var skill3Meter = new Meter(3, skillHandler)
  var skill4Meter = new Meter(3, skillHandler)
  var skill5Meter = new Meter(3, skillHandler)
  var skill6Meter = new Meter(3, skillHandler)
  var skill7Meter = new Meter(3, skillHandler)
  var skill8Meter = new Meter(3, skillHandler)
  var skill1HueMeter = new Meter(8, ()=>"")
  var skill2HueMeter = new Meter(8, ()=>"")
  var skill3HueMeter = new Meter(8, ()=>"")
  var skill4HueMeter = new Meter(8, ()=>"")
  var skill5HueMeter = new Meter(8, ()=>"")
  var skill6HueMeter = new Meter(8, ()=>"")
  var skill7HueMeter = new Meter(8, ()=>"")
  var skill8HueMeter = new Meter(8, ()=>"")
  var skill1SatMeter = new Meter(3, skillHandler)
  var skill2SatMeter = new Meter(3, skillHandler)
  var skill3SatMeter = new Meter(3, skillHandler)
  var skill4SatMeter = new Meter(3, skillHandler)
  var skill5SatMeter = new Meter(3, skillHandler)
  var skill6SatMeter = new Meter(3, skillHandler)
  var skill7SatMeter = new Meter(3, skillHandler)
  var skill8SatMeter = new Meter(3, skillHandler)
  var wing = "M12.35,121.46c-8.01-9.72-11.92-19.29-12.31-28.71C-0.78,73.01,10.92,58.28,28.3,47.67 c18.28-11.16,37.08-13.93,55.36-22.25C92.79,21.27,103.68,14.47,121.8,0c5.92,15.69-12.92,40.9-43.52,54.23 c9.48,0.37,19.69-2.54,30.85-9.74c-0.76,19.94-16.46,32.21-51.3,36.95c7.33,2.45,16.09,2.58,27.27-0.58 C74.33,116.81,29.9,91.06,12.35,121.46L12.35,121.46z";
  var assassinIcon = "M48.15,6.45S66.82,21.34,64.59,41.34c0,0-13.11-16.22-1.77,8,0,0-2.45,30,25.77,45.11l-3.77,17.78L87,115.34S97.93,113.78,94.59,93c0,0-22.25-8.55-22.9-25.88s9.79-25.78,12.46-26.45c0,0-13.33,27.78,10,33.33,0,0,5.49-8,1.08-26.22l-2.41,5.56s-4.67-13.11-9.34-18c0,0,2.45-10,.45-12.45a20.88,20.88,0,0,1,6.44,12.89s8.89-7.33,10.11-14c0,0,5,12.22,9.45,14.67,0,0,4.44-13.33,7.55-14a24.29,24.29,0,0,0,0,12.89s-7.78,12.22-9.55,18.44l-2.67-8.89s-4,25.56-.44,29.11,15.55-6.66,15.33-15.11S118.82,41.48,117,40.23c0,0,16.89,12.22,10.66,30S111.26,91.56,107,91.78c0,0-4.22,17.78,5.55,23.56l2.89-4.89L112.59,94s26.67-13.55,25.34-43.77c0,0,12-22.67-1.56-9.56,0,0-3.33-20.78,16.45-34.22,0,0-21.56,29.33,47.66-5.56,0,0-59,32-14.33,36.45,0,0-37,3.78-11.33,15.33H153S140.75,78,128.15,85.12c0,0,17.7-5.09,19.33-15.12,0,0,18.67-8.44,21.11-12.88,0,0-.66,10.88-5.55,15.11s8.44,8.22,8.44,8.22l-14,.89L159,85.12l8.44-.45,3.78,30.67L150.82,91.78,157,86.23l-1.78-4.45S142.37,91.56,145.93,98,155,115.34,155,115.34l-10.45-9.78-.89,2.89,4.89,6.89-16,16.66,4.67-29.55,4.67,4,1.11-3.56s-13.45-11.77-18.72-2S117,115.34,117,115.34l-4,3-12.56,66.33L86.67,117.86l-3.56-3.41S80,98.45,69.33,96.67c0,0-9.77,4-12,7.56l1.93,2.07,5.19-4.3,4.29,30.52L52.3,114.3l5.48-6.52-2.37-2.37-9,10.82s12-21.49,6.37-27.41-6.37-4.74-6.37-4.74l-1.78,3.26,5.34,5.44L29.78,116.52l4.59-32.29L42.67,86,45,82.15s-9.34-3-15.26-1.48c0,0,9.33-5.18,6.81-10.52s-5.92-7.7-4.89-13c0,0,17.34,12.14,20.75,12.29,0,0,1.43,9,20.74,15.85,0,0-21.19-20-24.15-31.7l-23.11-.15S51.85,40.23,15.11,36.82c0,0,46-2.52-14.63-35.93C.48.89,62.22,34.6,48.15,6.45Z";
  var gunnerIcon = "M182.59,128c-41.77,11.56-20.74-22.22-20.74-22.22C138.74,116.41,150,82.34,150,82.34c-33.18-5.93-3.26-48-3.26-48-36.44,32.88-24.59.88-24.59.88C113,54.48,93.59,2.93,93.59,2.93c-19.66,56-28,31.41-28,31.41C73.26,66,41.85,34,41.85,34c28.74,46.52-4.44,47.41-4.44,47.41C48.67,115.52,26.74,106,26.74,106c17.78,32-21.92,21.63-21.92,21.63,17.77,13,16.88,26.07,16.88,26.07,37-18.37,22.82,22.82,22.82,22.82,16.3-27,49.07,0,49.07,0,39.3-27.26,50.48,0,50.48,0-10.37-45,21.93-21.34,21.93-21.34C163.93,145.45,182.59,128,182.59,128Zm-65.48-55.4C148.82,97.15,113,112,113,112,92.82,90,117.11,72.56,117.11,72.56ZM93.7,39.37l14.52,22.52L93.7,84.41,79.78,62.48ZM70.59,72.56S97.26,95.08,73.85,112C73.85,112,40.81,95.39,70.59,72.56ZM52.52,146.35c-7.11,0-12.45-10.35-8.59-18.66,3.69-8,13.38-4.49,14.16-4.19-.92-.36-14-5.53-8.83-11.54,5.33-6.22,11.56-7.11,15.7,5.78S59.63,146.37,52.52,146.35Zm55.7,14.21c-4.44.59-28.74,1.48-29.63,0S63.92,156.71,70.81,141s9.56-8.89,15.19-6.52c0,0-11-16,8-24.29,0,0,21.63,10.07,7.11,24.29,0,0,12.8-9.18,16.48,6.52S112.67,160,108.22,160.56Zm23.89-16c-13.74-8.3-8.48-27.26-8.48-27.26s5-12.45,14.22-6.82-7.65,13.63-7.65,13.63c12.8-3.85,15.06,5.63,15.06,5.63S145.85,152.85,132.11,144.56Z";
  var mageIcon = "M178.54,81.35C178.09,64,162.76,57.79,151.42,56s-22,7.75-22,7.75c-2.89-2.48-.23-5.53,0-12S120.54,38,115.2,36.9s-12.89-5.55-12.89-5.55c-4.92-8.58.45-5.56.45-5.56l-.45,1.78c-.44,1.78,3.11,5.33,7.78,3.11s3.33-6-.44-11.56-12,1.56-12,1.56c-3.34,14,.89,12.22,1.33,14.44s11.33,6,15.11,7.34,6.22,10,6.22,12.22-2.66,7.11-6.44,8.64-8.22-1.31-10-3.75-1.33-5.34,1.33-9.11,4.22.44,3.56,2.66.44,7.34,5.11,5.78,4.89-6.89,1.78-11.11-5.78-3.33-11.11-2.44S98.31,54,98.31,54L95.2,50c-1.11-3.11-.89-27.33-.89-27.33,6.23-13.33,0-17.33,0-17.33-3.55-9.78-8.44,0-8.44,0-6.45,6.88,0,17.11,0,17.11V40.3c-1.33,15.18-4.45,12.82-4.45,12.82-1.33-7.55-2.88-6.89-9.33-8.44S63.65,49.79,63,51.79s1.11,7.33,5,7.33,3.88-4.89,3-6.22.44-3.33.44-3.33,8-.89,5.12,8.22-12,4.22-12,4.22-7.34-6.22-2.67-15.33,11.55-2.45,20.22-12.45-4.44-17.77-8.44-16.88S61,23.79,69.2,29.57s8.89-5.11,8.89-5.11c2.67,5.77-2.67,9.11-2.67,9.11C54.09,37.12,51,48.23,51,48.23c-.55,1.29,1.56,12.89-.44,14.45s-9.34-4.89-9.34-4.89S26.09,50.23,10.76,62.9,3,88.68,2.09,94.23s14.22,26.45,25.56,30.89,12.89,7.78,11.77,13.34-7.11,2.44-7.11,2.44,4.23-10.44-4-6.22,0,12.67,0,12.67C41.87,153.35,51,142,51,142c-2.24,16.09,7.52,21.32,9.31,19.29s-1.93-1.74-1.75-10.4c.22-10.89,4.88-5.11,4.88-5.11-2.66,12.44,7.56,20,7.56,20s14.89,9.56,8,14.22,2,5.11,4.44,4,7-6.65,7-6.65S93,182,97.2,183.57,109,182,102.76,180.9s-2.45-6.22-2.45-6.22l16.89-20.45c-1.33-9.33.22-10.22.22-10.22,6.67.22,2.67,17.34,2.67,17.34,12.45-4.45,8.67-18.89,8.67-18.89s6.22,4.89,12.22,6.22,9.33.44,13.11-4,1.33-8.89-3.11-10.22-4,6.66-4,6.66c-7.78,1.11-9.56-8.22-3.56-10.89S161.2,118.9,166.76,114,179,98.68,178.54,81.35Zm-162.37,3c12.22-16,27-1,27-1l-9.19,17.18L45.35,118C37.35,123.35,3.94,100.43,16.17,84.38Zm105.7-.15c-1.33-6-12.22-12.22-12.22-12.22C136.54,55.79,123.2,90.23,121.87,84.23ZM70.09,72S57.42,81,58.54,84.94,41.2,56.9,70.09,72ZM58.76,118.8c.89,7.23,13.11,12.1,13.11,12.1C43.2,147.79,57.87,111.57,58.76,118.8Zm46,38.54-15,14.45c-1.65-2.67-14.8-14-14.8-14-8.44-28.89,9.56-6.89,9.56-6.89,5.55,18,11.33-.22,11.33-.22C115.87,128.68,104.76,157.34,104.76,157.34Zm3.11-26.66s12.22-4.81,13.78-12.85S137.2,149.57,107.87,130.68ZM118,107.35c-4.54,18-21.62,20.66-21.62,20.66.51,10.22-6.6,7.82-6.6,7.82-7.65.7-6.13-8-6.13-8-18-2.89-21.73-20.67-21.73-20.67s-11.38,2-10.72-6.89,10.72-7.47,10.72-7.47c5.83-18.59,22-19,22-19s-1.33-9.11,6.55-9.33,5.67,8,5.67,8c3.78-.23,11.75,5.55,11.75,5.55l-5.08,3.56c-1.78-3.34-5.56-1.78-5.56-1.78-7.55-8.67-14.44,0-14.44,0-6.45-2.44-10,7.56-10,7.56C66.47,86,66.54,98.9,66.54,98.9c-11.12,9.33,23.74,26,23.74,26,34-16.67,23.37-25.78,23.37-25.78,1.33-10.22-5.78-12-5.78-12l-2.45-3.77,4.23-4c4,4.66,7.46,13.41,7.46,13.41s11.43-1.41,11.43,7.5S118,107.35,118,107.35Zm17.2,10.48,11.11-17.37-9.77-15.52s18.66-21.44,29.11,7.82C165.65,92.76,163.2,116.32,135.2,117.83Z";
  var martialIcon = "M10.81,95H1s.3-46.82,33.48-72.3S100-3.33,126.36,8.22s46.52,33.48,51.26,50.37S191,89.41,182.36,122.3s-24.29,40.88-47.7,58.66S55.84,188.37,44,178,6.66,141.56,4,124.67A237.42,237.42,0,0,1,1,98.15l10.22-.45S11,111,12.73,117.18l4.67-2S15,104.52,15,101.41H33.84l-.22-10H14.51s.89-21.34,8.89-28.89L40.73,96.41,23.84,131s-6-7.78-5.77-12.44L13.4,121s9.11,27.34,21.11,35.56L39.18,151,28.07,136.74,35,121s11.77,27.78,35.11,36.45l-13.34,8.22L40.51,152.52l-4.44,5.78s24,19.77,37.55,21.55l.89-5.11L61.4,169.85l32.13-18.22,33,17.33-12.44,5.34-16.89,1.55-.45-18.22-6.89.44v17.78l-13.11-.67-.89,5.34s51.34,6.66,75.34-21.78L145.4,153l-14.67,12.22-14.44-9.55s28.89-13.33,32.89-32.89l10.22,12.67-11.78,15.33,6.22,6.44s18.23-24.88,20-34.88l-6-3.12L165,129.41l-17.34-27.56-.22-13.33L164.51,62.3l6,18.66,1.11,11.11-18.89.45.89,7.78h17.11l-.44,16.88,4.67,2.67s11.11-55.78-20.23-82.22l-4.44,7.11L160.07,57l-9.34,16s-11.11-29.78-34.44-36.22l14.22-9.11,17.56,15.11,4.89-8S132.73,17,113,13l-1.12,6.22,14,4.45-28,16.67-9.77.44-28-17.56,17.77-6.44H89.4l1.33,17.11,6.89-.67V16.3l12,1.11,1.11-6.23S67.84,4.3,40.51,29.85l5.56,5.33,9.55-7.77L71,35.85S51.18,43.85,47.4,53L58.29,65.63l10.89-6.45s-19.78,49.34-5.34,56.45,15.56-1.56,15.56-4.22-4-2.23-5.78.44c0,0-6.89,3.11-8.44-7.11S75,93,79.18,93.63l3.11-7.11S66.07,80.3,75.84,59s40.23-6.22,42.89-4.44S145.18,73.63,139,91.41c0,0-21.12-29.34-33.34-26.67s-12.22,2-10,7.78c0,0,17.34-8,13.34,10.22l-2.89,4.89,2.89,4s17.55-11.45,25.77,4.16,8,26.73-9.33,38.73-24.67,12.22-44.22,7.55c0,0,33.33-9.11,36.44-20.44s.89-14.89-1.33-16c0,0,2.44,11.11-8,12s-11.78-11.56-7.11-18.45,6-6.22,6-6.22l-4-4.44A25.18,25.18,0,0,1,84.51,89l-3.33,5.56s16-.45,14.44,16.89-10.22,24-23.11,24.22S48.07,125,46.73,110.07s1.78-36,9.11-40.66L57,68.18l-11.78-14S35.84,67.41,36,71.52L27.84,56l17-19.33-6.33-6.22S7,59.89,10.81,95Z";
  var warriorIcon = "M162.4,29.86S190,5.56,198.85,3.49,243.59-1,238.25,36.67s-2.37,56.3,8.89,65.49-6.81,0-6.81,0S214.25,83.78,219,37.27c0,0-6.81-31.71-23.7,7.11,0,0-8.59,13.63-24.3,14.22l-4.74,4.74,4.45.89-3.56,3.55,5,6.52,12.74-12.44S181.66,84.67,200,87.64c0,0-16.89,16.75-20.15,18.6l2.67,4.51,6.22-4.15,5.93,10.07s-14.22,0-13.63,14.52L162.4,121.12l16-7.71-3.26-5.63L155.59,119s8.89-20.14,9.48-31.11l-7.71-3.26-3.55,5.82s-.89-9.76-7.71,1.69,6.52,7.9,6.52,7.9l2.67,7.41-8.3,5.92-4.14-7.11V103s-11.26-2.37-8.89,16l6.52-8.59,4.44,8.3,1.18,15.7s-10.66,8.89-8.29,29.63L131,181.56s-4.74-31.4-10.07,0l-7.11-15.11s1.18-28.15-8-33.18V115.49l4.44-5.33,6.82,8.59s5.92-13-6.82-15.41l-7.11,8.59-5.92-4.74v-7.7s11.26,3.17,8.59-7.31S96,85.93,97.22,90.49l-3.56-7.3L86.85,92l9.77,28.2L77.36,109.86l-2.07,4.74L88,120.53,71.14,132.08s-.29-14.52-13.63-16L61.66,106l9.19,6.52,2.37-7.41L51,87.93S72,82.3,66.1,62.45L78.85,75.19l5.63-8-4.75-3.55,5.93-.6-3.85-5.33S62.25,60.08,55.44,45.56c0,0-7.11-31.7-22.82-15.11,0,0,5.34,54.82-23.4,72.3,0,0-15.12,10.07,0-7.71s3.85-58.37,3.85-58.37S6.55,7.64,31.73,4.08s23.12-.59,32.6,6.52,24,19,24,19,7.4,16.89-.6,25.48l1.49,6.82,2.66-1.19.6,5,3.85-1.48V58.9S110.25,52.38,99,27.19l7.71-2.07s14.81,29.63,4.74-3c0,0,13.63-16,28.74-.3,0,0-10.37,33.48,3.55,3.55l8.3,2.37s-11,20.69,2.67,31.12v5l4.44-.59.89-3.56L162.4,61l2.67-5.33S154.4,50.9,162.4,29.86Z";

  function update() {
    if (!mountActive) {
      copyScreen(1);
    }

    inGameMeter.setValue(engine.vision.inGame)
    healthMeter.setValue(engine.vision.healthBar)
    manaMeter.setValue(engine.vision.manaBar)
    dismountGreenArrowMeter.setValue(engine.vision.dismountGreenArrow)
    mountBlackMeter.setValue(engine.vision.mountBlack)
    speakCharacterMeter.setValue(engine.vision.speakCharacter)
    speakCharacterLeaveMeter.setValue(engine.vision.speakCharacterLeave)
    swordQuestCompleteMeter.setValue(engine.vision.swordQuestComplete)
    questCompleteConfirmationBrownMeter.setValue(engine.vision.questCompleteConfirmationBrown)
    questCompleteConfirmationYellowMeter.setValue(engine.vision.questCompleteConfirmationYellow)
    if(playingGame){
      skill1Meter.setValue(engine.vision.skill1[2])
      skill2Meter.setValue(engine.vision.skill2[2])
      skill3Meter.setValue(engine.vision.skill3[2])
      skill4Meter.setValue(engine.vision.skill4[2])
      skill5Meter.setValue(engine.vision.skill5[2])
      skill6Meter.setValue(engine.vision.skill6[2])
      skill7Meter.setValue(engine.vision.skill7[2])
      skill8Meter.setValue(engine.vision.skill8[2])
      skill1SatMeter.setValue(engine.vision.skill1[1])
      skill2SatMeter.setValue(engine.vision.skill2[1])
      skill3SatMeter.setValue(engine.vision.skill3[1])
      skill4SatMeter.setValue(engine.vision.skill4[1])
      skill5SatMeter.setValue(engine.vision.skill5[1])
      skill6SatMeter.setValue(engine.vision.skill6[1])
      skill7SatMeter.setValue(engine.vision.skill7[1])
      skill8SatMeter.setValue(engine.vision.skill8[1])
      skill1HueMeter.setValue(engine.vision.skill1[0])
      skill2HueMeter.setValue(engine.vision.skill2[0])
      skill3HueMeter.setValue(engine.vision.skill3[0])
      skill4HueMeter.setValue(engine.vision.skill4[0])
      skill5HueMeter.setValue(engine.vision.skill5[0])
      skill6HueMeter.setValue(engine.vision.skill6[0])
      skill7HueMeter.setValue(engine.vision.skill7[0])
      skill8HueMeter.setValue(engine.vision.skill8[0])
    }

    skillCount > 1000 ? skillCount = 1000 : null;
    skillCount > 0 ? skillCount-=2 : null;
    if(playingGame && skillToggle){
      drawSkill()
    }

    if (!mountActive) {
      DrawHud();
    }

    for (let i = 0; i < effects.length; i++) {
      effects[i].draw();
      if (effects[i].lifetime <= 0) {
        effects.splice(i, 1);
      }
    };

    //use TimebarMeter for HUD effect?

    stateHdlr.Process();
    window.requestAnimationFrame(update);
  };


  //callbacks


  function DrawHud() {
    ctx.beginPath();

    if (playingGame) {
      if (healthToggle) {
        ctx.fillStyle = healthColor;
        ctx.fillRect(healthBarX, healthBarY, healthMeter.value * healthBarWidth, healthBarHeight)
      }
      if (manaToggle) {
        ctx.fillStyle = manaColor;
        ctx.fillRect(manaBarX, manaBarY, manaMeter.value * manaBarWidth, manaBarHeight)
      }
    } else if (adjToggle) {
      ctx.fillStyle = healthColor;
      ctx.fillRect(healthBarX, healthBarY, healthBarWidth, healthBarHeight)
      ctx.fillStyle = manaColor;
      ctx.fillRect(manaBarX, manaBarY, manaBarWidth, manaBarHeight)
    }
  }

  function skillHandler(){
    if(playingGame && !speakingActive && !questPlaying && engine.vision.inGame == 1 && skillToggle){
      if(skill1Meter.decreased && !skill1Meter.increased && skill1SatMeter.decreased && skill1Meter.diff > 10){
        skillCount += 50;
        effects.push(new skillEffect(skill1HueMeter.value))
      } else if(skill2Meter.decreased && !skill2Meter.increased && skill2SatMeter.decreased && skill2Meter.diff > 10){
        skillCount += 50;
        effects.push(new skillEffect(skill2HueMeter.value))
      } else if(skill3Meter.decreased && !skill3Meter.increased && skill3SatMeter.decreased && skill3Meter.diff > 10){
        skillCount += 50;
        effects.push(new skillEffect(skill3HueMeter.value))
      } else if(skill4Meter.decreased && !skill4Meter.increased && skill4SatMeter.decreased && skill4Meter.diff > 10){
        skillCount += 50;
        effects.push(new skillEffect(skill4HueMeter.value))
      } else if(skill5Meter.decreased && !skill5Meter.increased && skill5SatMeter.decreased && skill5Meter.diff > 10){
        skillCount += 50;
        effects.push(new skillEffect(skill5HueMeter.value))
      } else if(skill6Meter.decreased && !skill6Meter.increased && skill6SatMeter.decreased && skill6Meter.diff > 10){
        skillCount += 50;
        effects.push(new skillEffect(skill6HueMeter.value))
      } else if(skill7Meter.decreased && !skill7Meter.increased && skill7SatMeter.decreased && skill7Meter.diff > 10){
        skillCount += 50;
        effects.push(new skillEffect(skill7HueMeter.value))
      } else if(skill8Meter.decreased && !skill8Meter.increased && skill8SatMeter.decreased && skill8Meter.diff > 10){
        skillCount += 50;
        effects.push(new skillEffect(skill8HueMeter.value))
      }
    }
  }

  function inGameChanged() {
    if (inGameMeter.value == 1 && healthMeter.value != 0) {
      setTimeout(() => {
        playingGame = true;
        console.log("inGame")
      }, 200);
    } else {
      playingGame = false;
      console.log("outGame")
    }
  }

  function speakChanged() {
    if (speakCharacterLeaveMeter.value == 1 && speakCharacterMeter.value == 1 && !speakingActive && dialogueToggle) {
      console.log("Speak effect")
      effects.push(new speakEffect())
      speakingActive = true;
    } else if (speakCharacterLeaveMeter.value != 1 && speakCharacterMeter.value != 1 && speakingActive) {
      console.log("Stop speak effect")
      speakingActive = false;
    }
  }

  function mountChanged() {
    if (dismountGreenArrowMeter.value == 1 && mountBlackMeter.value == 1 && mountToggle) {
      mountActive = true;
      effects.push(new mountEffect())
    } else {
      mountActive = false;
    }
  }

  function questComplete() {
    if (swordQuestCompleteMeter.value == 1 && questCompleteConfirmationBrownMeter.value > 0.7 && questCompleteConfirmationYellowMeter.value == 1 && !questPlaying && questToggle) {

      effects.push(new questCompleteEffect())
      questPlaying = true;
      setTimeout(() => {
        questPlaying = false;
      }, 6000);
    }
  }

  function drawSkill(){
    ctx.globalAlpha = skillCount / 1000;
    var skillColor;
    var mod = Math.sin(Date.now() / 1000) * 10
    switch(playerClass){
      case "Warrior":
        skillColor = `hsl(${220 + mod / 2}, ${95 + mod/2}%, ${50 + mod}%)`
        break;
      case "Martial Artist":
      skillColor = `hsl(${160 + mod / 2}, ${95 + mod/2}%, ${50 + mod}%)`
        break;
      case "Gunner":
      skillColor = `hsl(${40 + mod / 2}, ${95 + mod/2}%, ${50 + mod}%)`
        break;
      case "Mage":
      skillColor = `hsl(${10 + mod / 2}, ${95 + mod/2}%, ${50 + mod}%)`
        break;
      case "Assassin":
      skillColor = `hsl(${290 + mod / 2}, ${95 + mod/2}%, ${50 + mod}%)`
        break;
      default:
        break;
      }
    drawRect(0, 0, 320, 200, skillColor)
    ctx.globalAlpha = 1;
  }

  function DrawPath(x, y, path, color) {
    ctx.fillStyle = color;
    ctx.save();
    ctx.translate(x, y);
    let ex = new Path2D(path);
    ctx.fill(ex);
    ctx.restore();
  };

  function hexToHSL(H) {
  // Convert hex to RGB first
  let r = 0, g = 0, b = 0;
  if (H.length == 4) {
    r = "0x" + H[1] + H[1];
    g = "0x" + H[2] + H[2];
    b = "0x" + H[3] + H[3];
  } else if (H.length == 7) {
    r = "0x" + H[1] + H[2];
    g = "0x" + H[3] + H[4];
    b = "0x" + H[5] + H[6];
  }
  // Then to HSL
  r /= 255;
  g /= 255;
  b /= 255;
  let cmin = Math.min(r,g,b),
      cmax = Math.max(r,g,b),
      delta = cmax - cmin,
      h = 0,
      s = 0,
      l = 0;

  if (delta == 0)
    h = 0;
  else if (cmax == r)
    h = ((g - b) / delta) % 6;
  else if (cmax == g)
    h = (b - r) / delta + 2;
  else
    h = (r - g) / delta + 4;

  h = Math.round(h * 60);

  if (h < 0)
    h += 360;

  l = (cmax + cmin) / 2;
  s = delta == 0 ? 0 : delta / (1 - Math.abs(2 * l - 1));
  s = +(s * 100).toFixed(1);
  l = +(l * 100).toFixed(1);

  return [h, s, l];
}

function skillEffect(color){
  this.radius = 1;
  this.color = color;
  this.lifetime = 10;
  this.draw = function(){
    DrawStrokeCircle(160, 100, this.radius, `hsl(${this.color}, 100%, 50%)`, 30);
    this.radius < 250 ? this.radius+=5 : this.lifetime = 0;
    if(speakingActive || questPlaying){
      this.lifetime = 0;
    }
  }
}

  function questCompleteEffect() {
    this.elapsed;
    this.start = GetTime();
    this.draw = function () {
      ctx.beginPath()
      ctx.fillStyle = "black"
      ctx.fillRect(0, 0, 320, 200)
      this.elapsed = GetTime() - this.start
      if (this.elapsed > 2000) {
        let circleGradient = ctx.createRadialGradient(160, 100, 0, 160, 100, (this.elapsed - 2000) / 7)
        circleGradient.addColorStop(0, "yellow");
        circleGradient.addColorStop(1, "black")
        DrawCircle(160, 100, 200, circleGradient)
      }
      if (this.elapsed < 1000) {
        drawExclamationMark(160, 50, 200 - this.elapsed / 7);
      } else {
        let gradient = ctx.createLinearGradient(0, 0, 0 + ((this.elapsed - 1000) / 6), 0);
        gradient.addColorStop(0, "yellow");
        gradient.addColorStop(0, "white");
        gradient.addColorStop(1, "black")
        drawExclamationMark(160, 50, 50)
        ctx.beginPath();
        ctx.save()
        ctx.translate(210, 10)
        ctx.rotate(15 * (Math.PI / 180))
        renderPath(0, 0, wing, gradient, 10, 10)
        ctx.restore()
        ctx.beginPath()
        ctx.save()
        ctx.translate(80, -137)
        ctx.rotate(-15 * (Math.PI / 180))
        renderPath(0, 0, wing, gradient, -10, 10)
        ctx.restore()
      }
      if (this.elapsed > 3000) {
        copyScreen((this.elapsed - 3000) / 1000)
        if (this.elapsed > 4000) {
          this.lifetime = 0;
        }
      }
    }
  }


  function speakEffect() {
    this.elapsed;
    this.start = GetTime();
    this.exitTime = 0;
    this.textArray = [];
    this.draw = function () {
      this.elapsed = GetTime() - this.start
      if (questPlaying) {
        this.lifetime = 0;
      }
      if (this.elapsed < 800) {
        ctx.beginPath()
        let circleGradient = ctx.createRadialGradient(160, 100, 0, 160, 100, 200 - (this.elapsed) / 5)
        circleGradient.addColorStop(0, "hsla(20,30%,30%, 0)")
        circleGradient.addColorStop(1, "hsla(20,50%,20%, 1)")
        DrawCircle(160, 100, 200, circleGradient)
        this.exitTime = this.elapsed;
      } else if (speakCharacterLeaveMeter.value == 1 && speakCharacterMeter.value == 1) {
        ctx.beginPath()
        ctx.fillStyle = "hsla(20,50%,10%, 1)"
        ctx.fillRect(0, 0, 320, 200)
        this.exitTime = this.elapsed;
        if (this.textArray.length < 5) {
          this.textArray.push(new randomText())
        }
        this.textArray.forEach((text, index) => {
          text.draw();
          if (text.x > 200 + 100 && text.speed > 0 || text.x < 0 - 100 && text.speed < 0) {
            this.textArray.splice(index, 1)
          }
        });
      } else if (!questPlaying) {
        let circleGradient = ctx.createRadialGradient(160, 100, 0, 160, 100, (this.elapsed - this.exitTime) / 5)
        circleGradient.addColorStop(0, "hsla(0,0%,0%, 0)")
        circleGradient.addColorStop(1, "hsla(0,0%,0%, 1)")
        DrawCircle(160, 100, 200, circleGradient)
        if ((this.elapsed - this.exitTime) / 7 > 200) {
          this.lifetime = 0;
        }
      } else {
        this.lifetime = 0;
      }
    }
  }

  function mountEffect() {
    this.elapsed;
    this.followPoint = new followPoint();
    this.footSteps = new footSteps();
    this.start = GetTime();
    this.holder = 1;
    this.exitTime = 0;
    this.draw = function () {
      this.elapsed = GetTime() - this.start
      if (this.elapsed < 2000) {
        let gradient = ctx.createLinearGradient(0 + (this.elapsed / 10), 0 + (this.elapsed / 10), 0 + (this.elapsed), 0 + ((this.elapsed) / 2));
        gradient.addColorStop(0, "hsla(0,0%,0%,0.1)")
        gradient.addColorStop(1, "hsla(0,0%,0%,0.1)")
        ctx.fillStyle = gradient;
      } else if (this.holder == 1) {
        ctx.fillStyle = "black";
        this.holder++;
      } else {
        ctx.fillStyle = "hsla(0,0%,0%,0.1)";
      }
      ctx.fillRect(0, 0, 320, 200)
      this.followPoint.draw();
      this.footSteps.draw(this.followPoint);

      if (!mountActive) {
        this.lifetime = 0;
      } else {
        this.exitTime = this.elapsed;
      }
    }
  }

  function ParticleExplosion(x, y, color, speed, duration, particleAmount, particleSize, fadeSpeed, notrandomY, useHearts) {
    this.start = GetTime();
    this.col = color;
    this.speed = speed;
    this.duration = duration;
    this.lifetime = 2000;
    this.amount = particleAmount;
    this.size = particleSize
    this.x = x;
    this.y = y;
    this.fadeSpeed = fadeSpeed;
    this.particles = [];
    this.useHearts = useHearts;

    while (this.particles.length < this.amount) {
      if (notrandomY) {
        this.yspeed = -this.speed / 1.5;
      } else {
        this.yspeed = ((Math.random() - 0.5) * this.speed);
      }
      if (this.useHearts == null || this.useHearts == false) {
        this.particles.push(new ExplosionParticle(this.x, this.y, this.size, this.col, this.fadeSpeed,
          {
            x: ((Math.random() - 0.5) * this.speed),
            y: this.yspeed
          }))
      } else {
        this.particles.push(new HeartParticle(this.x, this.y, this.size, this.col, this.fadeSpeed,
          {
            x: ((Math.random() - 0.5) * this.speed),
            y: this.yspeed
          }))
      }

      this.draw = function () {
        this.lifetime = this.duration - (GetTime() - this.start)
        this.particles.forEach((Particle, index) => {
          Particle.draw()
        })
      }
    }
  };


  class randomText {
    constructor() {
      this.characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      this.randomVal = Math.random();
      this.speed = this.randomVal > 0.5 ? 2 : -2
      this.y = Math.random() * 100 + 50;
      this.lettercount = Math.ceil(Math.random() * 16);
      this.x = this.randomVal > 0.5 ? 0 - this.lettercount * 40 : 200 + this.lettercount * 40
      this.start = GetTime();
    }

    draw() {
      this.elapsed = GetTime() - this.start;
      for (let i = 0; i < this.lettercount; i++) {
        ctx.font = '100px serif';
        ctx.fillStyle = this.randomVal < 0.2 || this.randomVal > 0.9 ? "white" : "yellow"
        ctx.globalAlpha = .4
        ctx.fillText(this.characters.charAt(Math.floor(this.randomVal * this.characters.length)), this.x + (this.speed * 9) * i, this.y + Math.sin(this.elapsed / 100 + i) * 30)
        ctx.globalAlpha = 1
      }
      this.x += this.speed;
    }
  }


  class followPoint {
    constructor() {
      this.x = Math.random() * 320;
      this.y = Math.random() * 200;
      this.speed = {
        x: Math.random() > 0.6 ? -1 : 1,
        y: Math.random() > 0.6 ? -1 : 1,
      }
    }
    draw() {
      this.x += this.speed.x;
      this.y += this.speed.y;
      if (this.x > 320 || this.x < 0) {
        this.speed.x = -this.speed.x;
      }
      if (this.y > 200 || this.y < 0) {
        this.speed.y = -this.speed.y;
      }
    }
  }

  class ExplosionParticle {
    constructor(x, y, radius, color, fadeSpeed, velocity) {
      this.x = x;
      this.y = y;
      this.color = color;
      this.radius = radius;
      this.velocity = velocity;
      this.alpha = 1 * fadeSpeed;
    }
    draw() {
      ctx.globalAlpha = this.alpha;
      ctx.beginPath()
      ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2, false)
      ctx.fillStyle = this.color
      ctx.fill()
      this.x += this.velocity.x
      this.y += this.velocity.y
      this.alpha -= 0.01
      ctx.globalAlpha = 1;
    }
  }

  class footSteps {
    constructor() {
      this.x = Math.random() * 320;
      this.y = Math.random() * 200;
      this.speed = {
        x: 0,
        y: 0
      }
      this.angle = 0;
      this.timer = GetTime();
      this.start = GetTime()
    }
    draw(point) {
      this.angle = Math.atan2(point.y - this.y, point.x - this.x)
      this.speed.x = Math.cos(this.angle);
      this.speed.y = Math.sin(this.angle)
      this.x += this.speed.x * 0.8;
      this.y += this.speed.y * 0.8;
      this.elapsed = GetTime() - this.start;


      ctx.fillStyle = `hsl(${30 + (Math.sin(this.elapsed / 1000) + 1) * 40},100%,50%)`
      ctx.beginPath();
      ctx.save();
      ctx.translate(this.x, this.y)
      ctx.rotate(this.angle)
      if (GetTime() - this.timer > 1000) {
        ctx.fillRect(0, -20, 50, 30)
        setTimeout(() => {
          ctx.save();
          ctx.translate(this.x, this.y)
          ctx.rotate(this.angle)
          ctx.fillRect(0, 20, 50, 30)
          ctx.restore();
        }, 500);
        this.timer = GetTime();
      }
      ctx.restore();
    }
  }


  function renderPath(x, y, path, color, xsize, ysize) {
    ctx.fillStyle = color;
    ctx.save();
    ctx.transform(xsize / 10, 0, 0, ysize / 10, 160 - 10 * 16.5, 79 - xsize * 7.5);
    ctx.translate(x, y);
    let ex = new Path2D(path);
    ctx.fill(ex);
    ctx.restore()
  }

  function drawExclamationMark(x, y, size) {
    ctx.fillStyle = "yellow"
    ctx.beginPath();
    ctx.save();
    ctx.translate(x, y)
    ctx.rotate(45 * (Math.PI / 180))
    ctx.fillRect(0, 0, size / 2, size / 2)
    ctx.restore();
    ctx.beginPath();
    ctx.fillRect(x - size / 4, y + size / 4, size / 2, size)
    ctx.beginPath();
    ctx.save();
    ctx.translate(x, y + size * 1.5)
    ctx.rotate(45 * (Math.PI / 180))
    ctx.fillRect(0, 0, size / 2, size / 2)
    ctx.restore();
  }



  function DrawCircle(x, y, radius, color) {
    ctx.beginPath();
    ctx.fillStyle = color;
    ctx.arc(x, y, radius, 0, 2 * Math.PI)
    ctx.fill();
  };

  function DrawStrokeCircle(x, y, radius, color, stroke) {
    ctx.beginPath();
    ctx.strokeStyle = color;
    ctx.lineWidth = stroke;
    ctx.arc(x, y, radius, 0, 2 * Math.PI)
    ctx.stroke();
  };

  function drawRect(x, y, height, width, color) {
    ctx.beginPath();
    ctx.fillStyle = color;
    ctx.fillRect(x, y, height, width);
  }


  function copyScreen(alpha) {
    var shine = engine.vision.ShineMeter
    let lightness = new Int8Array(engine.zone.lightness);
    let sat = new Int8Array(engine.zone.saturation);
    let hue = new Int16Array(engine.zone.hue);
    for (var iZone = 0; iZone < 560; iZone++) {
      var iRow = Math.floor(iZone / 28);
      var iCol = iZone % 28;
      var iWidth = 320 / 28;
      var iHeight = 200 / 20;
      var iZx = iCol * iWidth;
      var iZy = iRow * iHeight;
      ctx.fillStyle =
        "hsla(" +
        hue[iZone] +
        "," +
        sat[iZone] +
        "%," +
        lightness[iZone] * keyScreenBrightness / 100 +
        "%, " +
        `${alpha}` +
        ")";

      ctx.fillRect(iZx, iZy, iWidth, iHeight);
    }
  }

  function GetTime() {
    return new Date().getTime()
  }

  function StateHandler() {
    var stack = [];
    var state = null;

    var updateState = function () {
      if (stack.length > 0) {
        state = stack[stack.length - 1];
      } else {
        state = null;
      }
    };

    this.Push = function (newState) {
      stack.push(newState);
      updateState();
    };

    this.Pop = function () {
      stack.pop();
      updateState();
    };

    this.Process = function () {
      if (state != null) {
        state.Process();
      }
    };
  }

  function Meter(size, callback) {
    this.size = size;
    this.value = 0;
    this.diff = 0;
    this.increased = false;
    this.decreased = false;
    var values = [];

    this.setValue = function (updatedValue) {
      values.push(updatedValue);
      if (values.length > this.size) {
        values.shift();
      }

      for (var i = 0; i < values.length - 1; i++) {
        if (values[i] !== values[i + 1]) return;
      }
      if (this.value !== values[0]) {
        this.diff = Math.abs(this.value - values[0]);
        this.increased = this.value < values[0];
        this.decreased = this.value > values[0];
        this.value = values[0]
        callback()
      }
    }
  }
  window.requestAnimationFrame(update)
</script>