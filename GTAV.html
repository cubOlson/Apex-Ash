<head>
  <title>GTA V</title>
  <meta description="Go on an adventure with metering and ambiance effects" />
  <meta publisher="SignalRGB" />
  <meta property="enableHealth" label="Low Health effect" type="boolean" default="1" />
  <meta property="effectHex" label="Low Health effect Color" type="color" min="0" max="360" default="#ff0000" />
  <meta default="0" label="Low Health Effect Selector" max="2" min="0" property="EffectStyle" type="number" />
  <meta property="enableExp" label="Exp effect" type="boolean" default="1" />
  <meta property="effectHex1" label="Exp effect Color" type="color" min="0" max="360" default="#004cff" />
  <meta property="enableMoney" label="Money effect" type="boolean" default="1" />
  <meta property="effectHex2" label="Money effect Color" type="color" min="0" max="360" default="#0bfc03" />
  <meta property="enableWasted" label="Wasted effect" type="boolean" default="1" />

  <meta property="enableWanted" label="Wanted effect" type="boolean" default="1" />
  <meta meter="wasted" tags="GTA, Grand Theft Auto" type="area" x="0.5214" y="0.4648" height="0.0111" width="0.0005"
    h="0-5" s="50-80" l="40-70" />
  <meta meter="map" tags="GTA, Grand Theft Auto" type="area" x="0.9646" y="0.9602" height="0.0009" width="0.0042"
    h="0-0" s="0-0" l="95-100" />
  <meta meter="money3" tags="GTA, Grand Theft Auto" type="area" x="0.9807" y="0.1019" height="0.0065" width="0.0005"
    h="0-0" s="0-0" l="90-95" />
  <meta meter="money2" tags="GTA, Grand Theft Auto" type="area" x="0.9812" y="0.1" height="0.0037" width="0.001" h="0-0"
    s="0-0" l="90-95" />
  <meta meter="exp" tags="GTA, Grand Theft Auto" type="area" x="0.3932" y="0.037" height="0.0028" width="0.0141"
    h="212-212" s="70-80" l="70-80" />
  <meta meter="money" tags="GTA, Grand Theft Auto" type="area" x="0.9807" y="0.0667" height="0.0065" width="0.0016"
    h="120-122" s="20-50" l="55-60" />
  <meta meter="Star" tags="GTA, Grand Theft Auto" type="area" x="0.9797" y="0.029" height="0.0028" width="0.001" h="0-0"
    s="0-0" l="90-95" />
  <meta meter="Bullets" tags="GTA, Grand Theft Auto" type="ocr_numeric" x="0.9719" y="0.0167" width="0.0187"
    height="0.0306" confidence="70" />
  <meta meter="lowHp" tags="GTA, Grand Theft Auto" type="area" x="0.0182" y="0.9741" height="0.0019" width="0.0021"
    h="0-5" s="15-89" l="10-70" />
  <meta meter="reload" tags="GTA, Grand Theft Auto" type="ocr_numeric" x="0.9432" y="0.0185" width="0.0224"
    height="0.0287" confidence="70" />
</head>

<body style="margin: 0; padding: 0; background: #000;">
  <canvas id="exCanvas" width="320" height="200"></canvas>
</body>

<script>
  var canvas, ctx;
  var width = 320;
  var height = 200;
  var hue = 1;
  var intensity = 50;
  var pulse = false;
  var stateMgr = new StateHandler();
  var effects = [];
  var colors;
  var healthMeter = new Meter(3, healthBar);
  var expMeter = new Meter(3, expBar);
  var moneyMeter = new Meter(3, moneyBar);
  var starMeter = new Meter(3, starBar);
  var moneyMeter2 = new Meter(3, moneyBar);
  var moneyMeter3 = new Meter(3, moneyBar);
  var wastedMeter = new Meter(3, wastedBar);

  var orbs = [];
  var timing = 100;
  var speed = 5;

  function wastedBar() {
    if (enableWasted) {
      if (wastedMeter.value === 1) {
        for (let i = 0; i < 20; i++) {
          {
            setTimeout(function () {
              effects.push(
                new moveableBar(0, i * 10, 20, 320, random(-7, 7), 0, 2, 100, 50, 0.7)
              );
            }, i * 50);
          }
        }
      }
    }
  }
  function starBar() {
    if (enableWanted) {
      if (starMeter.value >= 0) {
        stateMgr.Push(new BurstRippleState("#2600ff", "#ff0000", "#2600ff"));
      }
    }
  }

  function expBar() {
    if (enableExp) {
      if (expMeter.increased) {
        var colors = hexToHSL(effectHex1);
        for (let i = 0; i < 20; i++) {
          setTimeout(function () {
            effects.push(
              new moveableBar(i * 20, 160, 100, 20, 0, -5, colors.h + random(-20, 20), colors.s + random(-20, 20), colors.l, 0.9)
            );
          }, i * 30);
          setTimeout(function () {
            effects.push(
              new moveableBar(i * 20, 160, 100, 20, 0, 5, colors.h + random(-20, 20), colors.s + random(-20, 20), colors.l, 0.9)
            );
          }, i * 30);
        }
      }
    }
  }
  function moneyBar() {
    if (enableMoney) {
      if (moneyMeter.increased || moneyMeter2.increased || moneyMeter3.increased) {
        var colors = hexToHSL(effectHex2);
        for (let i = 0; i < 20; i++) {
          setTimeout(function () {
            effects.push(
              new moveableBar(i * 20, 160, 100, 20, 0, -5, colors.h + random(-20, 20), colors.s + random(-20, 20), colors.l, 0.9)
            );
          }, i * 30);
          setTimeout(function () {
            effects.push(
              new moveableBar(i * 20, 160, 100, 20, 0, 5, colors.h + random(-20, 20), colors.s + random(-20, 20), colors.l, 0.9)
            );
          }, i * 30);
        }
      }
    }
  }
  function healthBar() {
    if (enableHealth) {
      if (healthMeter.increased) {
        var colors = hexToHSL(effectHex);
        switch (Math.round(EffectStyle)) {
          case 0:
            for (let i = 0; i < 20 * 2; i++) {
              effects.push(
                new moveableBar(
                  random(0, 360),
                  random(0, 200),
                  40,
                  40,
                  random(-5, 5),
                  random(-5, 5),
                  colors.h + random(-20, 20),
                  colors.s + random(-20, 20),
                  colors.l,
                  0.9
                )
              );
            }
            break;
          case 1:
            for (let i = 0; i < 20 * 4; i++) {
              setTimeout(function () {
                effects.push(
                  new moveableBar(
                    random(0, 360),
                    random(-100, 0),
                    20,
                    40,
                    0,
                    -10,
                    colors.h,
                    colors.s,
                    colors.l,
                    0.9
                  )
                );
              }, random(0, 1500));
            }
            break;
          case 2:
            for (let i = 0; i < 20 * 3; i++) {
              effects.push(
                new moveableBar(
                  360,
                  random(0, 200),
                  40,
                  20,
                  random(-7, -1),
                  0,
                  colors.h + random(-30, 30),
                  colors.s + random(-20, 20),
                  colors.l,
                  0.9
                )
              );
              effects.push(
                new moveableBar(
                  0,
                  random(0, 200),
                  40,
                  20,
                  random(1, 7),
                  0,
                  colors.h + random(-20, 20),
                  colors.s + random(-20, 20),
                  colors.l,
                  0.9
                )
              );
            }
            break;
        }
      }
    }
  }

  function BurstRippleState(color1, color2, color3) {
    this.start = new Date().getTime();
    this.duration = 5000;
    this.count = 2000;
    this.color1 = color1;
    this.color2 = color2;
    this.color3 = color3;
    this.size = 0;

    this.Process = function () {
      this.elapsed = new Date().getTime() - this.start;
      if (this.elapsed > this.duration) {
        stateMgr.Pop();
      }
      this.Draw();
    };

    this.Draw = function () {
      ctx.fillStyle = "black";
      ctx.fillRect(0, 0, 320, 200);

      if (timing > 60 && timing < 100) {
        ctx.fillStyle = "#ff0000";
        ctx.fillRect(0, 0, 106, 200);

        // ctx.fillStyle = color2;
        // ctx.fillRect(106, 0, 108, 200);

        ctx.fillStyle = "#0000ff";
        ctx.fillRect(214, 0, 106, 200);
      } else if (timing > 10 && timing < 50) {
        ctx.fillStyle = "#0000ff";
        ctx.fillRect(0, 0, 106, 200);

        // ctx.fillStyle = color3;
        // ctx.fillRect(106, 0, 108, 200);

        ctx.fillStyle = "#ff0000";
        ctx.fillRect(214, 0, 106, 200);
      } else {
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(106, 0, 108, 200);
      }

      if (timing > 0) {
        timing -= Math.round(speed);
      } else {
        timing = 100;
      }
    };
  }
  function colorFilter(hue, lightnessOffset = 0, milliseconds = 4000) {
    this.start = new Date().getTime();
    this.duration = milliseconds;
    this.hue = hue;
    this.lightnessOffset = lightnessOffset;
    this.Process = function () {
      this.elapsed = new Date().getTime() - this.start;
      if (this.elapsed > this.duration) {
        stateMgr.Pop();
      }
      this.draw();
    };

    this.draw = function () {
      let lightness = new Int8Array(engine.zone.lightness);
      let sat = new Int8Array(engine.zone.saturation);
      let hue = new Int16Array(engine.zone.hue);

      for (var iZone = 0; iZone < 560; iZone++) {
        var satBoost = sat[iZone] + 35;
        ctx.fillStyle =
          'hsla(' + this.hue + ',' + satBoost + '%,' + (lightness[iZone] + this.lightnessOffset) + '%, ' + 100 * 0.01 + ')';

        var iRow = Math.floor(iZone / 28);
        var iCol = iZone % 28;
        var iWidth = 320 / 28;
        var iHeight = 200 / 20;
        var iZx = iCol * iWidth;
        var iZy = iRow * iHeight;

        ctx.fillRect(iZx, iZy, iWidth, iHeight);
      }
    };
  }
  function CenterWave(hue, saturation, lightness, value) {
    this.start = new Date().getTime();
    this.duration = 2000;
    this.lifetime = 50;
    this.size = 0;
    this.value = value;
    this.hue = hue;
    this.saturation = saturation;
    this.lightness = lightness;
    this.flashing;
    this.Process = function () {
      this.elapsed = new Date().getTime() - this.start;
      if (this.elapsed > this.duration) {
        stateMgr.Pop();
      }
      this.Draw();
    };
    this.Draw = function () {
      let lightness = new Int8Array(engine.zone.lightness);
      let sat = new Int8Array(engine.zone.saturation);
      let hue = new Int16Array(engine.zone.hue);

      for (var iZone = 0; iZone < 560; iZone++) {
        ctx.fillStyle = 'hsla(' + hue[iZone] + ',' + sat[iZone] + '%,' + lightness[iZone] + '%, ' + 100 * 0.01 + ')';

        var iRow = Math.floor(iZone / 28);
        var iCol = iZone % 28;
        var iWidth = 320 / 28;
        var iHeight = 200 / 20;
        var iZx = iCol * iWidth;
        var iZy = iRow * iHeight;

        ctx.fillRect(iZx, iZy, iWidth, iHeight);
      }

      ctx.fillStyle = 'hsl(' + this.hue + ',' + this.saturation + '%,' + random(this.lightness - 10, this.lightness + 10) + '%)';

      ctx.fillRect(160, 0, this.size * 160, 200);
      ctx.fillRect(160, 0, -this.size * 160, 200);
      if (this.size < this.value) {
        this.size += 0.03;
      }
    };
    this.lifetime--;
  }
  function moveableBar(x, y, width, height, xDirection, yDirection, hue, sat, lit, alpha) {
    this.x = x;
    this.y = y;
    this.hue = hue;
    this.sat = sat;
    this.lit = lit;
    this.alpha = alpha;
    this.lifetime = 50;
    this.size = 0;
    this.ydirection = yDirection;
    this.xdirection = xDirection;
    this.width = width;
    this.height = height;

    this.draw = function () {
      ctx.fillStyle = 'hsla(' + this.hue + ',' + this.sat + '%,' + this.lit + '%,' + this.alpha + ' )';
      ctx.fillRect(this.x, this.y, this.height, this.width);
      this.lifetime--;
      this.y -= this.ydirection;
      this.x += this.xdirection;
    };
  }

  function IdleState() {
    this.Process = function () {
      let lightness = new Int8Array(engine.zone.lightness);
      let sat = new Int8Array(engine.zone.saturation);
      let hue = new Int16Array(engine.zone.hue);

      for (var iZone = 0; iZone < 560; iZone++) {
        ctx.fillStyle =
          "hsla(" +
          hue[iZone] +
          "," +
          sat[iZone] +
          "%," +
          lightness[iZone] +
          "%, " +
          100 * 0.01 +
          ")";

        var iRow = Math.floor(iZone / 28);
        var iCol = iZone % 28;
        var iWidth = 320 / 28;
        var iHeight = 200 / 20;
        var iZx = iCol * iWidth;
        var iZy = iRow * iHeight;

        ctx.fillRect(iZx, iZy, iWidth, iHeight);
      }
    };
  }

  function random(min, max) {
    // if min = 10 max = 15 random var = 0.1544465; it will return approximately 10 because of math.floor
    return Math.floor(Math.random() * (max - min)) + min;
  }

  function hexToHSL(hex) {
    var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);

    var r = parseInt(result[1], 16);
    var g = parseInt(result[2], 16);
    var b = parseInt(result[3], 16);

    (r /= 255), (g /= 255), (b /= 255);
    var max = Math.max(r, g, b),
      min = Math.min(r, g, b);
    var h,
      s,
      l = (max + min) / 2;

    if (max === min) {
      h = s = 0; // achromatic
    } else {
      var d = max - min;
      s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
      switch (max) {
        case r:
          h = (g - b) / d + (g < b ? 6 : 0);
          break;
        case g:
          h = (b - r) / d + 2;
          break;
        case b:
          h = (r - g) / d + 4;
          break;
      }
      h /= 6;
    }

    s = s * 100;
    s = Math.round(s);
    l = l * 100;
    l = Math.round(l);
    h = Math.round(360 * h);

    var colors = [];
    colors['h'] = h;
    colors['s'] = s;
    colors['l'] = l;

    return colors;
  }

  function update() {
    stateMgr.Process();
    if (engine.vision.map === 1) {
      enableWanted = false;
      enableHealth = false;
      enableMoney = false;
      enableExp = false;
    }
    starMeter.setValue(engine.vision.Star);
    wastedMeter.setValue(engine.vision.wasted);
    healthMeter.setValue(engine.vision.lowHp);
    expMeter.setValue(engine.vision.exp);
    moneyMeter.setValue(engine.vision.money);
    moneyMeter2.setValue(engine.vision.money2);
    moneyMeter3.setValue(engine.vision.money3);

    for (let i = 0; i < effects.length; i++) {
      effects[i].draw();
      if (effects[i].lifetime <= 0) {
        effects.splice(i, 1);
      }
    }
    window.requestAnimationFrame(update);
  }

  function StateHandler() {
    var stack = [];
    var state = null;

    var updateState = function () {
      if (stack.length > 0) {
        state = stack[stack.length - 1];
      } else {
        state = null;
      }
    };

    this.Push = function (newState) {
      stack.push(newState);
      updateState();
    };

    this.Pop = function () {
      stack.pop();
      updateState();
    };

    this.Process = function () {
      if (state != null) {
        state.Process();
      }
    };
  }

  function Meter(count, callback) {
    this.size = count;
    this.value = 0;
    this.diff = 0;
    this.increased = false;
    this.decreased = false;
    var values = [];

    this.setValue = function (updatedValue) {
      // Add and shift.
      values.push(updatedValue);
      if (values.length > this.size) {
        values.shift();
      }

      // Exit early if we've got a long-term match.
      for (var i = 0; i < values.length - 1; i++) {
        if (values[i] !== values[i + 1]) return;
      }

      // We got here, so we've got a matching value collection.
      if (this.value !== values[0]) {
        //var fromZero = this.value === 0;
        //var toZero = values[0] === 0;
        this.diff = Math.abs(this.value - values[0]);
        this.increased = this.value < values[0];
        this.decreased = this.value > values[0];
        this.value = values[0];
        callback();
      }
    };
  }

  function onEngineReady() {
    // Grab canvas and rendering context.
    canvas = document.getElementById('exCanvas');
    ctx = canvas.getContext('2d');
    stateMgr.Push(new IdleState());
    window.requestAnimationFrame(update);
  }
</script>