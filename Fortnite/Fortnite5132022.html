<head>
  <title>Fortnite</title>
  <meta description="Ambience and metering for Fortnite Chapter 3 Season 2" />
  <meta publisher="SignalRGB" />
  <meta property="adjToggle" label="Adjustment Toggle (turn off in-game)" type="boolean" default="0" />
  <meta property="healthColor" label="Health Bar Color" type="color" default="#12ff00" min="0" max="360" />
  <meta property="HealthBarX" label="HealthBarX" type="number" min="0" max="320" default="0" />
  <meta property="HealthBarY" label="HealthBarY" type="number" min="0" max="200" default="50" />
  <meta property="HealthBarWidth" label="HealthBarWidth" type="number" min="0" max="320" default="320" />
  <meta property="HealthBarHeight" label="HealthBarHeight" type="number" min="0" max="200" default="30" />
  <meta property="ShieldColor" label="Shield Bar Color" type="color" default="#00c3ff" min="0" max="360" />
  <meta property="ShieldBarX" label="ShieldBarX" type="number" min="0" max="320" default="0" />
  <meta property="ShieldBarY" label="ShieldBarY" type="number" min="0" max="200" default="80" />
  <meta property="ShieldBarWidth" label="ShieldBarWidth" type="number" min="0" max="320" default="320" />
  <meta property="ShieldBarHeight" label="ShieldBarHeight" type="number" min="0" max="200" default="30" />
  <meta property="myHuePicker2" label="Theme Color" type="hue" default="167" min="0" max="360">
  <meta property="myHuePicker3" label="Vehicle Hue Control" type="hue" default="30" min="0" max="360">
  <meta property="boost" label="Color Boost" type="number" min="0" max="20" default="0" />
  <meta property="enableHealing" label="Healing effect" type="boolean" default="1" />
  <meta property="enableDamage" label="Damage effect" type="boolean" default="1" />
  <meta property="enableVehicle" label="Vehicle effect" type="boolean" default="1" />
  <meta property="enableBuild" label="Building effects" type="boolean" default="1" />
  <meta property="enableCloud" label="Storm closing effect" type="boolean" default="1" />
  <meta property="enableXP" label="XP effect" type="boolean" default="1" />
  <meta property="enableKnock" label="Knocked-down effect" type="boolean" default="1" />


  <meta meter="matchLobby" tags="vlc,fortnite" type="area" x="0.0224" y="0.97430" height="0.001" width="0.01"
    h="200-260" s="75-100" l="0-40">
  </meta>

  <meta meter="playButton" tags="vlc,fortnite" type="area" x="0.7805" y="0.7122" height="0.01" width="0.05" h="50-70"
    s="75-100" l="70-100">
  <resolution size="3440x1440" x="0.8401" y="0.6563" width="0.01" height="0.01" />
  </meta>

  <meta meter="playButtonWhite" tags="vlc,fortnite" type="area" x="0.7805" y="0.7122" height="0.01" width="0.05"
    h="0-360" s="0-20" l="90-100">
  <resolution size="3440x1440" x="0.8401" y="0.6563" width="0.01" height="0.01" />
  </meta>

  <meta meter="playButtonBlue" tags="vlc,fortnite" type="area" x="0.7805" y="0.7122" height="0.01" width="0.05"
    h="190-220" s="75-100" l="70-100">
  <resolution size="3440x1440" x="0.8401" y="0.6563" width="0.01" height="0.01" />
  </meta>


  <meta meter="Building" tags="vlc,fortnite" x=".78906" y=".819444" width=".00002" height =".0001" h="0-360" s="0-30" l="70-100"
    type="linear">
  <resolution size="1680x1050" x=".78828125" y=".83680" width=".00002" height =".0001" />
  <resolution size="1280x800" x=".78828125" y=".83680" width=".00002" height =".0001" />
  <resolution size="1440x900" x=".78828125" y=".83680" width=".00002" height =".0001" />
  <resolution size="1920x1200" x=".78828125" y=".83680" width=".00002" height =".0001" />
  <resolution size="2560x1600" x=".78828125" y=".83680" width=".00002" height =".0001" />
  </meta>

  <meta meter="BuildingConfirmation" tags="vlc,fortnite" x=".815625" y=".8201388" width=".00002" height =".0001" h="170-220" s="40-100"
    l="40-100" type="linear">
  <resolution size="1680x1050" x=".815625" y=".8201388" width=".00002" height =".0001" />
  <resolution size="1280x800" x=".815625" y=".8201388" width=".00002" height =".0001" />
  <resolution size="1440x900" x=".815625" y=".8201388" width=".00002" height =".0001" />
  <resolution size="1920x1200" x=".815625" y=".8201388" width=".00002" height =".0001" />
  <resolution size="2560x1600" x=".815625" y=".8201388" width=".00002" height =".0001" />
  </meta>

  <meta meter="gameMode" tags="vlc,fortnite" type="area" x="0.895721" y="0.809722" height="0.0002" h="170-220"
    s="30-100" l="30-100">

  <resolution size="1680x1050" x="0.89648" y="0.8291667" height="0.0002" width="0.0005" />
  <resolution size="1280x800" x="0.89648" y="0.8291667" height="0.0002" width="0.0005" />
  <resolution size="1440x900" x="0.89648" y="0.8291667" height="0.0002" width="0.0005" />
  <resolution size="1920x1200" x="0.89648" y="0.8291667" height="0.0002" width="0.0005" />
  <resolution size="2560x1600" x="0.89648" y="0.8291667" height="0.0002" width="0.0005" />
  </meta>

  <meta meter="gameModeConfirmation" tags="vlc,fortnite" type="area" x="0.87929" y="0.68541666" height="0.0002"
    width="0.00005" h="36-75" s="30-80" l="80-100">
  <resolution size="1680x1050" x="0.87851" y="0.71666" height="0.0002" width="0.00005" />
  <resolution size="1280x800" x="0.87851" y="0.71666" height="0.0002" width="0.00005" />
  <resolution size="1440x900" x="0.87851" y="0.71666" height="0.0002" width="0.00005" />
  <resolution size="1920x1200" x="0.87851" y="0.71666" height="0.0002" width="0.00005" />
  <resolution size="2560x1600" x="0.87851" y="0.71666" height="0.0002" width="0.00005" />
  </meta>

  <meta meter="inGame" tags="vlc,fortnite" type="area" x="0.897218" y="0.3067" height="0.00019" width="0.01" h="0-360"
    s="0-20" l="80-100">
  <resolution size="1680x1050" x="0.9003" y="0.275" height="0.00019" width="0.01" />
  <resolution size="1280x800" x="0.9003" y="0.275" height="0.00019" width="0.01" />
  <resolution size="1440x900" x="0.9003" y="0.275" height="0.00019" width="0.01" />
  <resolution size="1920x1200" x="0.9003" y="0.275" height="0.00019" width="0.01" />
  <resolution size="2560x1600" x="0.9003" y="0.275" height="0.00019" width="0.01" />
  </meta>


  <meta meter="cloudClose" tags="vlc,fortnite" x=".847" y=".297" width=".009" height="0.001" h="290-350" s="60-100"
    l="50-90" type="area">
  <resolution size="3440x1440" x="0.17" y="0.8743" width="0.1555" height="0.001" />
  <resolution size="1920x1080" x=".849" y=".297" width=".008" height="0.001" />
  <resolution size="1280x720" x=".847" y=".297" width=".009" height="0.001" />
  </meta>



  <meta meter="zeroBuildHealth" tags="vlc,fortnite" x=".059765" y=".9055" width=".17" height =".0001" h="70-140" s="40-100" l="40-100"
    type="linear">
  <resolution size="1680x1050" x=".058965" y=".9055" width=".1718" height =".0001" />
  <resolution size="1280x800" x=".058965" y=".9055" width=".1718" height =".0001" />
  <resolution size="1440x900" x=".058965" y=".9055" width=".1718" height =".0001" />
  <resolution size="1920x1200" x=".058965" y=".9055" width=".1718" height =".0001" />
  <resolution size="2560x1600" x=".058965" y=".9055" width=".1718" height =".0001" />


  </meta>

  <meta meter="zeroBuildHealthRed" tags="vlc,fortnite " x=".059765" y=".9055" width=".17" height =".0001" h="330-360" s="40-100"
    l="40-100" type="linear">
  <resolution size="1680x1050" x=".058965" y=".9055" width=".1718" height =".0001" />
  <resolution size="1280x800" x=".058965" y=".9055" width=".1718" height =".0001" />
  <resolution size="1440x900" x=".058965" y=".9055" width=".1718" height =".0001" />
  <resolution size="1920x1200" x=".058965" y=".9055" width=".1718" height =".0001" />
  <resolution size="2560x1600" x=".058965" y=".9055" width=".1718" height =".0001" />
  </meta>


  <meta meter="zeroBuildShields" tags="vlc,fortnite" x=".059375" y=".88125" width=".17" height =".0001" h="180-212" s="70-100"
    l="60-100" type="linear">
  <resolution size="1680x1050" x=".059375" y=".891666" width=".17" height =".0001" />
  <resolution size="1280x800" x=".059375" y=".891666" width=".17" height =".0001" />
  <resolution size="1440x900" x=".059375" y=".891666" width=".17" height =".0001" />
  <resolution size="1920x1200" x=".059375" y=".891666" width=".17" height =".0001" />
  <resolution size="2560x1600" x=".059375" y=".891666" width=".17" height =".0001" />
  </meta>

  <meta meter="zeroBuildShields2" tags="vlc,fortnite" x=".059375" y=".88525" width=".17" height =".0001" h="180-212" s="70-100"
    l="60-100" type="linear">
  <resolution size="1680x1050" x=".059375" y=".891666" width=".17" height =".0001" />
  <resolution size="1280x800" x=".059375" y=".891666" width=".17" height =".0001" />
  <resolution size="1440x900" x=".059375" y=".891666" width=".17" height =".0001" />
  <resolution size="1920x1200" x=".059375" y=".891666" width=".17" height =".0001" />
  <resolution size="2560x1600" x=".059375" y=".891666" width=".17" height =".0001" />
  </meta>

  <meta meter="vehicle" tags="vlc,fortnite" x=".059" y=".86" width=".02" height=".0010" h="30-45" s="55-100" l="75-100"
    type="area" />
  <meta meter="vehicleZeroBuild" tags="vlc,fortnite" x=".0605" y=".844444" width=".02" height=".0010" h="30-45"
    s="55-100" l="75-100" type="area">
  <resolution size="1680x1050" x=".061" y=".86" width=".02" height=".0010" />
  <resolution size="1280x800" x=".061" y=".86" width=".02" height=".0010" />
  <resolution size="1440x900" x=".061" y=".86" width=".02" height=".0010" />
  <resolution size="1920x1200" x=".061" y=".86" width=".02" height=".0010" />
  <resolution size="2560x1600" x=".061" y=".86" width=".02" height=".0010" />
  </meta>

  <meta meter="xp" tags="vlc,fortnite" x=".0953" y=".4935" width=".035" height=".004" h="210-290" s="50-100" l="0-35"
    type="area">
  <resolution size="3440x1440" x="0.4971" y="0.1042" width=".08" height=".0050" />
  </meta>

  <meta meter="xp2" tags="vlc,fortnite" x=".0547" y=".5139" width=".035" height =".0001" h="1-360" s="60-100" l="50-100" type="linear">
  <resolution size="3440x1440" x="0.4971" y="0.1042" width=".08" height =".0001" />

  </meta>
</head>

<body style="margin: 0; padding: 0; background: #000;">
  <canvas id="exCanvas" width="320" height="200"></canvas>
</body>

<script>

  var canvas, ctx;
  var audio = [];
  var effects = [];
  var huez = [];
  var hue = 200;
  var sat = 100;
  var latency = 6;
  var stateMgr = new StateHandler();
  var currentBrightness = 0;
  var litPrev = 0;
  var inGame = false;

  var damageBrightness = 0;
  var vehiclePhase = 0;
  var buildGameMode = true;
  var BuildingAnim = false;
  var lobbyAnim = false;
  var cloudTimer = 0;
  var xpAnim = false;
  var move = 0;
  var cloudDiff = 0;
  var healthPrev = 0;
  var shieldPrev = 0;


  var inGameMeter = new Meter(5, onGameChanged)
  var GameModeMeter = new Meter(15, GameModeChanged);
  var GameModeConfirmationMeter = new Meter(35, GameModeChanged);
  var BuildingMeter = new Meter(25, checkBuild);
  var BuildingConfirmationMeter = new Meter(30, checkBuild);
  var inLobby = new Meter(4, lobbyAnimationPlay);
  var yellowPlayButton = new Meter(10, lobbyAnimationPlay);
  var bluePlayButton = new Meter(10, lobbyAnimationPlay)
  var whitePlayButton = new Meter(10, lobbyAnimationPlay)
  var healthM = new Meter(25, healthHelper);
  var healthDamageM = new Meter(3, healthHelper);
  var shieldsM = new Meter(20, shieldHelper);
  var shields2M = new Meter(20, shieldHelper);
  var shieldDamageM = new Meter(3, shieldHelper);
  var xpM1 = new Meter(25, xpHelper);
  var cloudCloseM = new Meter(3, cloudHelper);
  var vehicleM = new Meter(3, () => "");


  function shieldHelper() {
    if (inGame) {
      if (shieldsM.decreased && shieldsM.value != shieldPrev && healthM.value > .1 && Math.abs(shieldsM.value - shields2M.value) < .05) {
        if (enableDamage) {
          effects.push(new Wave('#ffffff', "down"));
          setTimeout(() => { effects.push(new Wave('#ff0000', "down")); }, 150);
          setTimeout(() => { effects.push(new Wave('#ff0000', "down")); }, 300);
          shieldPrev = shieldsM.value;
        }
      } else if (shieldsM.increased && shieldsM.value != shieldPrev && healthM.value > .1) {
        if (enableHealing) {
          effects.push(new Wave('#ffffff', "up"));
          setTimeout(() => { effects.push(new Wave('#00ff00', "up")); }, 150);
          setTimeout(() => { effects.push(new Wave('#00ff00', "up")); }, 300);
          shieldPrev = shieldsM.value;
        }
      };
    }
  };



  function onGameChanged() {

    if (inGameMeter.value > 0.3) {
      setTimeout(() => {
        GameModeChanged();
        inGame = true;
      }, 1000);

    } else {
      Cleareffects()
      inGame = false;
    }
  }

  function Cleareffects() {
    effects.length = 0;
    lobbyAnim = false;
    xpAnim = false;
  }

  function GameModeChanged() {
    if (vehicleM.value < 0.3) {
      if (GameModeMeter.value == 1 && GameModeConfirmationMeter.value == 1) {
        buildGameMode = true;
        console.log(" build" + GameModeConfirmationMeter.value)
        setTimeout(() => {
          Cleareffects()
        }, 100);
      } else {
        buildGameMode = false;
        setTimeout(() => {
          Cleareffects()
        }, 40);
        console.log("not build")
      }
    }
  }

  function healthHelper() {
    if (inGame) {
      if (healthM.diff > 0.95) {
        setTimeout(() => {
          Cleareffects()
        }, 300);
      } else {
        if (healthM.decreased && healthM.value != healthPrev && healthM.value > .1 && !engine.vision.battlebus) {
          if (enableDamage) {
            effects.push(new Wave('#ffffff', "down"));
            setTimeout(() => { effects.push(new Wave('#ff0000', "down")); }, 150);
            setTimeout(() => { effects.push(new Wave('#ff0000', "down")); }, 300);
            healthPrev = healthM.value;
          }
        } else if (healthM.increased && healthM.value != healthPrev && healthM.value > .1 && !engine.vision.battlebus) {
          if (enableHealing) {
            effects.push(new Wave('#ffffff', "up"));
            setTimeout(() => { effects.push(new Wave('#00ff00', "up")); }, 150);
            setTimeout(() => { effects.push(new Wave('#00ff00', "up")); }, 300);
            healthPrev = healthM.value;
          }
        };
      }
    }

  };

  function lobbyAnimationPlay() {
    if (inLobby.value == 1 && yellowPlayButton.value == 1 && !lobbyAnim || inLobby.value == 1 && bluePlayButton.value == 1 && !lobbyAnim || inLobby.value == 1 && whitePlayButton.value == 1 && !lobbyAnim) {
      stateMgr.Push(new lobbyAnimation());
      lobbyAnim = true;
    }
  };

  function xpHelper() {
    if (inGame) {


      if (xpM1.value > .9 && engine.vision.xp2 && xpAnim == false) {
        if (enableXP) {
          for (let i = 0; i < 5; i++) {
            setTimeout(() => { effects.push(new Wave("#fbd100", "down")); }, i * 100);
            setTimeout(() => { effects.push(new Wave("#ffffff", "up")); }, i * 100);
          }
        }
        xpAnim = true;
      } else if (xpM1.value == 0) {
        xpAnim = false;
      };
    }
  };

  function cloudHelper() {
    if (enableCloud) {
      cloudDiff = Date.now() - cloudTimer;
      if (cloudCloseM.value > .6 && cloudDiff > 3500) {
        cloudTimer = Date.now();
        effects.push(new effectPulse(310));
        setTimeout(() => { effects.push(new effectPulse(310)) }, 300);
      };
    }
  };

  function arrayEqual(array) {
    for (var i = 0; i < array.length - 1; i++) {
      if (array[i] !== array[i + 1]) return false;
    }
    return true;
  };

  function random(min, max) {
    var num = Math.floor(Math.random() * (max - min)) + min;
    // if min = 10 max = 15 random var = 0.1544465; it will return approzimately 10 because of math.floor
    return num;
  };

  function Wave(color, direction) {
    this.color = color;
    this.direction = direction;
    this.lifetime = 300;

    this.draw = function () {
      if (this.direction == "up") {
        ctx.fillStyle = this.color;
        ctx.beginPath();
        ctx.moveTo(160, this.lifetime - 100);
        ctx.lineTo(320, this.lifetime);
        ctx.lineTo(320, this.lifetime + 50);
        ctx.lineTo(160, this.lifetime - 50);
        ctx.lineTo(0, this.lifetime + 50);
        ctx.lineTo(0, this.lifetime);
        ctx.lineTo(160, this.lifetime - 100);
        ctx.fill();
      } else if (this.direction = "down") {
        ctx.fillStyle = this.color;
        ctx.beginPath();
        ctx.moveTo(160, 300 - this.lifetime);
        ctx.lineTo(320, 200 - this.lifetime);
        ctx.lineTo(320, 100 - this.lifetime);
        ctx.lineTo(160, 200 - this.lifetime);
        ctx.lineTo(0, 100 - this.lifetime);
        ctx.lineTo(0, 200 - this.lifetime);
        ctx.lineTo(160, 300 - this.lifetime);
        ctx.fill();
      }
      this.lifetime -= 15;
    };
  };

  function lobbyHelper(x, y, radius) {
    this.x = x;
    this.y = y;
    this.radius = radius;
    this.draw = function () {
      ctx.globalAlpha = 1 - this.radius / 360;
      ctx.beginPath();
      ctx.strokeStyle = `hsl(${myHuePicker2}, 100%, ${50 + (this.radius / 7)}%)`;
      ctx.arc(this.x, this.y, this.radius, 0, 2 * Math.PI);
      ctx.stroke();
      ctx.globalAlpha = 1;
      this.radius++;
    }
  }

  function lobbyAnimation() {
    this.start = new Date().getTime();
    this.elapsed = 0;
    this.effects = [];
    this.radius = 0;
    this.searching = 1000;

    this.Process = function () {
      if (inLobby.value == 0 && yellowPlayButton.decreased || bluePlayButton.decreased && inLobby.value == 0) {
        stateMgr.Pop();
        lobbyAnim = false;
      }
      yellowPlayButton.value == 1 ? this.searching = 1000 : this.searching = 100;
      this.Draw();
    };

    this.Draw = function () {
      this.elapsed = new Date().getTime() - this.start;
      this.radius = 50 + (Math.sin(this.elapsed / this.searching) * 10);

      ctx.fillStyle = 'black';
      ctx.fillRect(0, 0, 320, 200);
      ctx.beginPath();
      ctx.strokeStyle = `hsl(${myHuePicker2}, 100%, 50%)`;
      ctx.lineWidth = 20;
      ctx.arc(160, 100, this.radius, 0, 2 * Math.PI);
      ctx.stroke();
      if (this.radius > 59 && this.elapsed % 2 == 0) {
        this.effects.push(new lobbyHelper(160, 100, 69));
      }
      this.effects.forEach((e, i) => {
        ctx.lineWidth = 1;
        e.draw();
        if (e.radius > 360) this.effects.splice(i, 1);
      });
    }

  }

  function reversePulseRippleState(color, hollow) {
    this.start = new Date().getTime();
    this.duration = 2000;
    this.count = 2000;
    this.color = color;
    this.isHollow = hollow;

    this.Process = function () {
      this.elapsed = new Date().getTime() - this.start;
      if (this.elapsed > this.duration) {
        stateMgr.Pop();
      }
      this.Draw();
    };

    this.Draw = function () {
      ctx.fillStyle = "black";
      ctx.fillRect(0, 0, 320, 200);
      var pctUp = this.count / 2000;
      if (this.isHollow) {
        ctx.strokeStyle = this.color;
        ctx.lineWidth = 20;
        ctx.beginPath();
        ctx.arc(160, 100, 200 * pctUp, 0, 2 * Math.PI);
        ctx.stroke();
      } else {
        ctx.fillStyle = this.color;
        ctx.beginPath();
        ctx.arc(160, 100, 200 * pctUp, 0, 2 * Math.PI);
        ctx.fill();
      }

      if (this.count < 100) {
        this.count = 2000;
      } else {
        this.count -= 75;
      }
    };
  }

  function tookHit(hue) {
    this.lifetime = 25;
    this.start = new Date().getTime();
    this.elapsed = 0;

    this.draw = function () {
      this.elapsed = new Date().getTime() - this.start;
      ctx.fillStyle = `hsl(${hue}, 100%, ${Math.sin(this.elapsed / 10) * 25 + 50}%`;
      ctx.beginPath();
      ctx.fillRect(0, 0, 320, 200);
      ctx.stroke();
      this.lifetime--;
    }
  };

  function effectPulse(hue) {
    this.lifetime = 500;
    this.hue = hue;

    this.draw = function () {
      ctx.strokeStyle = `hsl(${hue}, 100%, 50%)`;
      ctx.lineWidth = 50;
      ctx.beginPath();
      ctx.arc(160, 100, this.lifetime, 0, Math.PI * 2);
      ctx.stroke();
      this.lifetime -= 10;
    }
  }

  function PulseRippleState(color, hollow, duration) {
    this.start = new Date().getTime();
    this.duration = duration;
    this.count = 2000;
    this.color = color;
    this.isHollow = hollow;

    this.Process = function () {
      this.elapsed = new Date().getTime() - this.start;
      if (this.elapsed > this.duration) {
        stateMgr.Pop();
      }
      this.Draw();
    };

    this.Draw = function () {
      ctx.fillStyle = "black";
      ctx.fillRect(0, 0, 320, 200);
      var pctUp = this.count / 2000;
      if (this.isHollow) {
        ctx.strokeStyle = this.color;
        ctx.lineWidth = 20;
        ctx.beginPath();
        ctx.arc(160, 100, 200 - 200 * pctUp, 0, 2 * Math.PI);
        ctx.stroke();
      } else {
        ctx.fillStyle = this.color;
        ctx.beginPath();
        ctx.arc(160, 100, 200 - 200 * pctUp, 0, 2 * Math.PI);
        ctx.fill();
      }

      if (this.count < 100) {
        this.count = 2000;
      } else {
        this.count -= 75;
      }
    };

  }
  function renderExtensions() {

    if (enableVehicle) {
      if (healthM.value > 0.1 && vehicleM.value > 0.3) {
        let lightness = 50 + Math.sin(Date.now() / 100) * 20;
        ctx.globalAlpha = .6;
        ctx.fillStyle = `hsl(${myHuePicker3}, 100%, ${lightness}%)`;
        ctx.fillRect(0, 0, 320, 200);
        ctx.globalAlpha = 1;

      };
    };

    if (healthM.value > .1 && healthM.value < .4) {
      for (let i = 0; i < 10; i++) {
        ctx.fillStyle = 'red';
        ctx.fillRect(Math.random() * 270, Math.random() * 150, 50, 50);
      }
    } else if (healthM.value < .1 && healthDamageM.value > .1) {
      if (enableKnock) {
        for (let i = 0; i < 10; i++) {
          ctx.fillStyle = 'red';
          ctx.fillRect(Math.random() * 270, Math.random() * 150, 100, 50);
          ctx.fillStyle = 'black';
          ctx.fillRect(Math.random() * 270, Math.random() * 150, 100, 50);
        }
      }
    };
  }
  //Fill build-item-specific zone


  function StateHandler() {
    var stack = [];
    var state = null;

    var updateState = function () {
      if (stack.length > 0) {
        state = stack[stack.length - 1];
      } else {
        state = null;
      }
    };

    this.Push = function (newState) {
      stack.push(newState);
      updateState();
    };

    this.Pop = function () {
      stack.pop();
      updateState();
    };

    this.Process = function () {
      if (state != null) {
        state.Process();
      }
    };
  }

  function onEngineReady() {
    // Grab canvas and rendering context.
    canvas = document.getElementById("exCanvas");
    ctx = canvas.getContext("2d");

    window.requestAnimationFrame(update);
  }

  function Meter(count, callback) {
    this.size = count;
    this.value = 0;
    this.diff = 0;
    this.increased = false;
    this.decreased = false;
    var values = [];

    this.setValue = function (updatedValue) {
      // Add and shift.
      values.push(updatedValue);
      if (values.length > this.size) {
        values.shift();
      }

      // Exit early if we've got a long-term match.
      for (var i = 0; i < values.length - 1; i++) {
        if (values[i] !== values[i + 1]) return;
      }

      // We got here, so we've got a matching value collection.
      if (this.value !== values[0]) {
        this.diff = Math.abs(this.value - values[0]);
        this.increased = this.value < values[0];
        this.decreased = this.value > values[0];
        this.value = values[0];
        callback();
      }
    };
  }

  function buildStepUp(x, y) {
    this.x = x;
    this.y = y;
    this.lifetime = 50;

    this.draw = function () {

      let index = 0;
      while (index < 5) {
        ctx.beginPath();
        ctx.fillStyle = 'blue';
        ctx.globalAlpha = .8;
        ctx.fillRect(this.x + (100 * index), this.y, 100, 50);
        ctx.globalAlpha = 1;
        ctx.strokeStyle = 'white';
        ctx.lineWidth = 15;
        ctx.strokeRect(this.x + (100 * index), this.y, 100, 50);
        index++;
      }
      this.lifetime--;
    }
  }
  var prevBuilding;

  function checkBuild() {
    if (inGame && vehicleM.value != 1) {

      if (BuildingMeter.value == 1 && !BuildingAnim && BuildingConfirmationMeter.value > 0.9) {
        if (enableBuild) {
          let index = 0;
          var intr = setInterval(function () {
            effects.push(new buildStepUp(0 - (index % 2 * 50), 200 - (50 * index)));
            if (++index == 6) clearInterval(intr);
          }, 150);
          BuildingAnim = true;
        }

      } else if (BuildingMeter.decreased && prevBuilding - BuildingMeter.value == 1 && BuildingAnim == true) {
        if (enableBuild) {
          effects.push(new effectPulse(160));
          BuildingAnim = false;
        }
      }
    }
    prevBuilding = BuildingMeter.value

  }

  function DrawHUD() {
    if (inGame) {
      ctx.beginPath()
      ctx.fillStyle = healthColor;
      ctx.fillRect(HealthBarX, HealthBarY, healthM.value * HealthBarWidth, HealthBarHeight)

      //shield
      ctx.beginPath()
      ctx.fillStyle = ShieldColor;
      ctx.fillRect(ShieldBarX, ShieldBarY, shieldsM.value * ShieldBarWidth, ShieldBarHeight)
    } else if (adjToggle) {
      ctx.beginPath()
      ctx.fillStyle = healthColor;
      ctx.fillRect(HealthBarX, HealthBarY, HealthBarWidth, HealthBarHeight)

      //shield
      ctx.beginPath()
      ctx.fillStyle = ShieldColor;
      ctx.fillRect(ShieldBarX, ShieldBarY, ShieldBarWidth, ShieldBarHeight)
    }
    //health

  }

  function update() {
    inGameMeter.setValue(engine.vision.inGame)

    healthM.setValue(engine.vision.zeroBuildHealth);
    healthDamageM.setValue(engine.vision.zeroBuildHealthRed);
    shieldsM.setValue(engine.vision.zeroBuildShields);
    shields2M.setValue(engine.vision.zeroBuildShields2);
    if (buildGameMode) {
      BuildingMeter.setValue(engine.vision.Building);
      BuildingConfirmationMeter.setValue(engine.vision.BuildingConfirmation)
      vehicleM.setValue(engine.vision.vehicle);
    } else {
      vehicleM.setValue(engine.vision.vehicleZeroBuild);
    }

    if (!inGame) {
      inLobby.setValue(engine.vision.matchLobby);
      yellowPlayButton.setValue(engine.vision.playButton);
      bluePlayButton.setValue(engine.vision.playButtonBlue)
      whitePlayButton.setValue(engine.vision.playButtonWhite)
    }
    xpM1.setValue(engine.vision.xp);
    cloudCloseM.setValue(engine.vision.cloudClose);

    GameModeConfirmationMeter.setValue(engine.vision.gameModeConfirmation)
    GameModeMeter.setValue(engine.vision.gameMode)


    if (engine.vision.battlebus || engine.vision.exit) {
      enableVehicle = false;
    }

    var brightness = (engine.audio.level + 20) / 20;

    if (brightness > currentBrightness + 0.25) {
      currentBrightness = brightness;
    }

    audio.push(brightness);
    if (audio.length > latency) {
      audio.shift();
    }

    var average = 0;
    for (var iIdx = 0; iIdx < audio.length; iIdx++) {
      average += audio[iIdx];
    }
    average /= audio.length;

    // Range limit the average.
    if (average < 0.1) {
      average = 0.1;
    } else if (average > 1) {
      average = 1;
    }

    var lit = average * 40;
    let lightness = new Int8Array(engine.zone.lightness);
    let sat = new Int8Array(engine.zone.saturation);
    let zhue = new Int16Array(engine.zone.hue);

    for (var iZone = 0; iZone < 560; iZone++) {
      var xZoneBrightness = lightness[iZone];
      var hue = zhue[iZone] + boost;
      //Removed if !exit conditional for big pixel bug. Probably not a bad idea.
      ctx.fillStyle =
        `hsl(${hue},${sat[iZone]}%,${xZoneBrightness}%)`;

      var iRow = Math.floor(iZone / 28);
      var iCol = iZone % 28;
      var iWidth = 320 / 28;
      var iHeight = 200 / 20;
      var zx = iCol * iWidth;
      var zy = iRow * iHeight;

      ctx.fillRect(zx, zy, iWidth, iHeight);
    }


    renderExtensions();

    currentBrightness -= 0.01;

    for (let i = 0; i < effects.length; i++) {
      effects[i].draw();
      if (effects[i].lifetime <= 0) {
        effects.splice(i, 1);
      }
    }
    DrawHUD();
    stateMgr.Process();
    window.requestAnimationFrame(update);
  }
</script>