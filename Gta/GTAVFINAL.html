<head>
  <title>GTA V Final Copy</title>
  <meta description="Go on an adventure with metering and ambiance effects" />
  <meta publisher="SignalRGB" />
  <meta property="enableHealth" label="Low Health effect" type="boolean" default="1" />
  <meta property="enableMoney" label="Money effect" type="boolean" default="1" />
  <meta property="enableWasted" label="Wasted effect" type="boolean" default="1" />
  <meta property="enableWanted" label="Wanted effect" type="boolean" default="1" />

  <meta meter="wastedW" tags="GTA, Grand Theft Auto" type="area" x="0.387" y="0.5037" width="0.04" height=".001"
    h="0-25" s="30-100" l="0-100">
  <resolution size="3440x1440" x="0.4128" y="0.5" width="0.02" height=".001" />
  <resolution size="2560x1600" x="0.3771" y="0.4981" width="0.04" height=".001" />
  <resolution size="1920x1200" x="0.3771" y="0.4981" width="0.04" height=".001" />
  <resolution size="1680x1050" x="0.3771" y="0.4981" width="0.04" height=".001" />
  <resolution size="1440x900" x="0.3771" y="0.4981" width="0.04" height=".001" />
  <resolution size="1280x800" x="0.3771" y="0.4981" width="0.04" height=".001" />
  </meta>
  <meta meter="wastedT" tags="GTA, Grand Theft Auto" type="area" x="0.5125" y="0.4657" width="0.035" height=".001"
    h="0-25" s="30-100" l="0-100">
  <resolution size="3440x1440" x="0.5093" y="0.4639" width="0.02" height=".001" />
  <resolution size="2560x1600" x="0.5156" y="0.4639" width="0.035" height=".001" />
  <resolution size="1920x1200" x="0.5156" y="0.4639" width="0.035" height=".001" />
  <resolution size="1680x1050" x="0.5156" y="0.4639" width="0.035" height=".001" />
  <resolution size="1440x900" x="0.5156" y="0.4639" width="0.035" height=".001" />
  <resolution size="1280x800" x="0.5156" y="0.4639" width="0.035" height=".001" />
  </meta>
  <meta meter="wastedD" tags="GTA, Grand Theft Auto" type="area" x="0.59" y="0.51" width="0.03" height=".001" h="0-25"
    s="30-100" l="0-100">
  <resolution size="3440x1440" x="0.5677" y="0.5181" width="0.02" height=".001" />
  <resolution size="2560x1600" x="0.5995" y="0.5194" width="0.03" height=".001" />
  <resolution size="1920x1200" x="0.5995" y="0.5194" width="0.03" height=".001" />
  <resolution size="1680x1050" x="0.5995" y="0.5194" width="0.03" height=".001" />
  <resolution size="1440x900" x="0.5995" y="0.5194" width="0.03" height=".001" />
  <resolution size="1280x800" x="0.5995" y="0.5194" width="0.03" height=".001" />
  </meta>
  <meta meter="firstStar" tags="GTA, Grand Theft Auto" type="area" x="0.977" y="0.0269" width="0.004" height=".006"
    h="0-360" s="0-100" l="90-100">
  <resolution size="3440x1440" x="0.8619" y="0.026" width="0.004" height=".0005" />
  <resolution size="2560x1600" x="0.9765" y="0.0259" width="0.004" height=".006" />
  <resolution size="1920x1200" x="0.9765" y="0.0259" width="0.004" height=".006" />
  <resolution size="1680x1050" x="0.9765" y="0.0259" width="0.004" height=".006" />
  <resolution size="1440x900" x="0.9765" y="0.0259" width="0.004" height=".006" />
  <resolution size="1280x800" x="0.9765" y="0.0259" width="0.004" height=".006" />
  <resolution size="1920x1440" x="0.973" y="0.0269" width="0.004" height=".006" />
  </meta>
  <meta meter="firstStarBlack1" tags="GTA, Grand Theft Auto" type="area" x="0.971875" y="0.025" width="0.0035"
    height=".001" h="0-360" s="0-100" l="0-10">
  <resolution size="3440x1440" x="0.8575" y="0.025" width="0.0009" height=".001" />
  <resolution size="2560x1600" x="0.9698" y="0.0241" width="0.0035" height=".001" />
  <resolution size="1920x1200" x="0.9698" y="0.0241" width="0.0035" height=".001" />
  <resolution size="1680x1050" x="0.9698" y="0.0241" width="0.0035" height=".001" />
  <resolution size="1440x900" x="0.9698" y="0.0241" width="0.0035" height=".001" />
  <resolution size="1280x800" x="0.9698" y="0.0241" width="0.0035" height=".001" />
  <resolution size="1920x1440" x="0.969875" y="0.025" width="0.0035" height=".001" />
  </meta>
  <meta meter="firstStarBlack2" tags="GTA, Grand Theft Auto" type="area" x="0.980875" y="0.025" width="0.0035"
    height=".001" h="0-360" s="0-100" l="0-10">
  <resolution size="3440x1440" x="0.8659" y="0.0248" width="0.0009" height=".001" />
  <resolution size="2560x1600" x="0.9797" y="0.0241" width="0.0035" height=".001" />
  <resolution size="1920x1200" x="0.9797" y="0.0241" width="0.0035" height=".001" />
  <resolution size="1680x1050" x="0.9797" y="0.0241" width="0.0035" height=".001" />
  <resolution size="1440x900" x="0.9797" y="0.0241" width="0.0035" height=".001" />
  <resolution size="1280x800" x="0.9797" y="0.0241" width="0.0035" height=".001" />
  </meta>
  <meta meter="blueBar" tags="GTA, Grand Theft Auto" type="area" x="0.087109" y="0.979166" width="0.0631" height=".001"
    h="190-240" s="10-100" l="30-85">
  <resolution size="3440x1440" x="0.1881" y="0.9729" width="0.05" height=".001" />
  <resolution size="2560x1600" x="0.0938" y="0.9731" width="0.0631" height=".001" />
  <resolution size="1920x1200" x="0.0938" y="0.9731" width="0.0631" height=".001" />
  <resolution size="1680x1050" x="0.0938" y="0.9731" width="0.0631" height=".001" />
  <resolution size="1440x900" x="0.0938" y="0.9731" width="0.0631" height=".001" />
  <resolution size="1280x800" x="0.0938" y="0.9731" width="0.0631" height=".001" />
  <resolution size="1920x1440" x="0.12" y="0.979166" width="0.0631" height=".001" />

  </meta>
  <meta meter="moneyGreen" tags="GTA, Grand Theft Auto" type="area" x="0.9485" y="0.0611" width="0.037" height=".0259"
    h="110-130" s="25-40" l="35-65">
  <resolution size="3440x1440" x="0.8412" y="0.059" width="0.028" height=".005" />
  <resolution size="2560x1600" x="0.9443" y="0.0583" width="0.041" height=".0259" />
  <resolution size="1920x1200" x="0.9443" y="0.0583" width="0.041" height=".0259" />
  <resolution size="1680x1050" x="0.9443" y="0.0583" width="0.041" height=".0259" />
  <resolution size="1440x900" x="0.9443" y="0.0583" width="0.041" height=".0259" />
  <resolution size="1280x800" x="0.9443" y="0.0583" width="0.041" height=".0259" />
  </meta>
  <meta meter="moneyGreen2" tags="GTA, Grand Theft Auto" type="area" x="0.9485" y="0.0935" width="0.037" height=".0259"
    h="110-130" s="25-40" l="35-65">
  <resolution size="3440x1440" x="0.8412" y="0.0924" width="0.028" height=".005" />
  <resolution size="2560x1600" x="0.9443" y="0.092" width="0.041" height=".0265" />
  <resolution size="1920x1200" x="0.9443" y="0.092" width="0.041" height=".0265" />
  <resolution size="1680x1050" x="0.9443" y="0.092" width="0.041" height=".0265" />
  <resolution size="1440x900" x="0.9443" y="0.092" width="0.041" height=".0265" />
  <resolution size="1280x800" x="0.9443" y="0.092" width="0.041" height=".0265" />
  </meta>
  <meta meter="moneyBlack" tags="GTA, Grand Theft Auto" type="area" x="0.9485" y="0.0611" width="0.037" height=".0259"
    h="0-360" s="0-100" l="0-10">
  <resolution size="3440x1440" x="0.8412" y="0.059" width="0.028" height=".005" />
  <resolution size="2560x1600" x="0.9443" y="0.0583" width="0.041" height=".0259" />
  <resolution size="1920x1200" x="0.9443" y="0.0583" width="0.041" height=".0259" />
  <resolution size="1680x1050" x="0.9443" y="0.0583" width="0.041" height=".0259" />
  <resolution size="1440x900" x="0.9443" y="0.0583" width="0.041" height=".0259" />
  <resolution size="1280x800" x="0.9443" y="0.0583" width="0.041" height=".0259" />
  </meta>
  <meta meter="moneyBlack2" tags="GTA, Grand Theft Auto" type="area" x="0.9485" y="0.0935" width="0.037" height=".0259"
    h="0-360" s="0-100" l="0-10">
  <resolution size="3440x1440" x="0.8412" y="0.0924" width="0.028" height=".005" />
  <resolution size="2560x1600" x="0.9443" y="0.092" width="0.041" height=".0265" />
  <resolution size="1920x1200" x="0.9443" y="0.092" width="0.041" height=".0265" />
  <resolution size="1680x1050" x="0.9443" y="0.092" width="0.041" height=".0265" />
  <resolution size="1440x900" x="0.9443" y="0.092" width="0.041" height=".0265" />
  <resolution size="1280x800" x="0.9443" y="0.092" width="0.041" height=".0265" />
  </meta>
  <meta meter="moneyRed" tags="GTA, Grand Theft Auto" type="area" x="0.9485" y="0.0611" width="0.037" height=".0259"
    h="0-5" s="20-100" l="20-85">
  <resolution size="3440x1440" x="0.8412" y="0.059" width="0.028" height=".005" />
  <resolution size="2560x1600" x="0.9443" y="0.0583" width="0.041" height=".0259" />
  <resolution size="1920x1200" x="0.9443" y="0.0583" width="0.041" height=".0259" />
  <resolution size="1680x1050" x="0.9443" y="0.0583" width="0.041" height=".0259" />
  <resolution size="1440x900" x="0.9443" y="0.0583" width="0.041" height=".0259" />
  <resolution size="1280x800" x="0.9443" y="0.0583" width="0.041" height=".0259" />
  </meta>
  <meta meter="lowHp" tags="GTA, Grand Theft Auto" type="area" x="0.0156" y="0.979" height="0.0019" width="0.075"
    h="0-10" s="15-100" l="10-70">
  <resolution size="3440x1440" x="0.1343" y="0.9729" width="0.04" height=".001" />
  <resolution size="2560x1600" x="0.0156" y="0.978" height="0.0019" width="0.075" />
  <resolution size="1920x1200" x="0.0156" y="0.978" height="0.0019" width="0.075" />
  <resolution size="1680x1050" x="0.0156" y="0.978" height="0.0019" width="0.075" />
  <resolution size="1440x900" x="0.0156" y="0.978" height="0.0019" width="0.075" />
  <resolution size="1280x800" x="0.0156" y="0.978" height="0.0019" width="0.075" />
  <resolution size="1920x1440" x="0.0150" y="0.978" height="0.0019" width="0.075" />
  </meta>
  <meta meter="tLCorner" tags="GTA, Grand Theft Auto" type="area" x="0.01" y="0.01" height="0.1" width="0.1" h="0-360"
    s="0-100" l="0-10">
  </meta>
  <meta meter="bRCorner" tags="GTA, Grand Theft Auto" type="area" x="0.89" y="0.89" height="0.1" width="0.1" h="0-360"
    s="0-100" l="0-10">
  </meta>

</head>

<body style="margin: 0; padding: 0; background: #000;">
  <canvas id="exCanvas" width="320" height="200"></canvas>
</body>

<script>
  var canvas, ctx;
  var width = 320;
  var height = 200;
  var stateHdlr = new StateHandler();
  var effects = [];
  var Freezebackground = false;
  var wastedGoing = false;
  var copTimer = 0;
  var lowHealthGoing = false;
  var playingGame = false;

  var lowHpMeter = new Meter(5, lowHpHandler);
  var redMoneyMeter = new Meter(25, moneyHandler);
  var green1MoneyMeter = new Meter(20, moneyHandler);
  var green2MoneyMeter = new Meter(20, moneyHandler);
  var black1MoneyMeter = new Meter(20, moneyHandler);
  var black2MoneyMeter = new Meter(20, moneyHandler);
  var firstStarMeter = new Meter(8, policeEffect);
  var inGameMeter = new Meter(10, inGame);
  var topLeftBlackMeter = new Meter(10, wastedEffect);
  var bottomRightBlackMeter = new Meter(10, wastedEffect);

  function update() {
    inGameMeter.setValue(engine.vision.blueBar)
    if (playingGame == true) {

      lowHpMeter.setValue(engine.vision.lowHp);
      green1MoneyMeter.setValue(engine.vision.moneyGreen);
      green2MoneyMeter.setValue(engine.vision.moneyGreen2);
      black1MoneyMeter.setValue(engine.vision.moneyBlack);
      black2MoneyMeter.setValue(engine.vision.moneyBlack2);
      redMoneyMeter.setValue(engine.vision.moneyRed);
      firstStarMeter.setValue(engine.vision.firstStar);
    }
    topLeftBlackMeter.setValue(engine.vision.tLCorner);
    bottomRightBlackMeter.setValue(engine.vision.bRCorner);
    wastedEffect();
    if (!Freezebackground) {
      copyScreen(1);
    }

    for (let i = 0; i < effects.length; i++) {
      effects[i].draw();
      if (effects[i].lifetime <= 0) {
        effects.splice(i, 1);
      }
    }

    stateHdlr.Process();
    window.requestAnimationFrame(update);
  }

  function lowHpHandler() {
    if (lowHpMeter.value > .1 && !lowHealthGoing && enableHealth) {
      effects.push(new LowHpEffect());
      lowHealthGoing = true;
    } else if (lowHpMeter.value < .1) {
      lowHealthGoing = false;
    }
  };

  function inGame() {
    if (inGameMeter.value > 0.1) {
      playingGame = true;
    } else {
      playingGame = false;
    }
  }

  function moneyHandler() {
    if (enableMoney) {
      if (redMoneyMeter.value > .2 && black1MoneyMeter.value > .1) {
        effects.push(new MoneyEffect("red"));
      } else if ((green1MoneyMeter.value > .2 || green2MoneyMeter.value > .2) && (black1MoneyMeter.value > .1 || black2MoneyMeter.value > .1)) {
        effects.push(new MoneyEffect("green"));
      }
    }
  };

  var activePolice = false;
  function policeEffect() {
    if (firstStarMeter.value > 0.8 && engine.vision.firstStarBlack1 > .9 && engine.vision.firstStarBlack2 > .9 && activePolice == false) {
      effects.push(new PoliceEffect());
      activePolice = true;
    }
  }

  function wastedEffect() {
    if (engine.vision.wastedW > .2 && engine.vision.wastedT > .2 && engine.vision.wastedD > .2) {
      if (topLeftBlackMeter.value > 0.9 || bottomRightBlackMeter.value > 0.9 || lowHealthGoing == true) {
        if (!wastedGoing && enableWasted) {
          stateHdlr.Push(new WastedEffect());
          wastedGoing = true;
        }
      }
    }
  }

  //Effects
  function LowHpEffect() {
    this.lifetime = 10;
    this.start = GetTime();
    this.explosionEffect = new ParticleExplosion(160, 100, "red", 14, 1500, 50, 10, 2, false, false, true);
    this.draw = function () {
      this.elapsed = GetTime();
      this.explosionEffect.draw();
      DrawHeart(160, 90, (Math.sin(this.elapsed / 300) + 1) * 50, (Math.sin(this.elapsed / 300) + 1) * 25)
      if ((Math.sin(this.elapsed / 300)) >= 0.99) {
        this.explosionEffect = new ParticleExplosion(160, 100, "red", 14, 1500, 50, 10, 2, false, false, true);
      }
      if (lowHealthGoing == false) {
        this.lifetime = 0
        lowHealthGoing = false;
      }
    }
  }

  function MoneyEffect(color) {
    this.start = GetTime();
    this.money = [];
    this.color = color;

    for (let i = 0; i < 35; i++) {
      this.money.push(new fallingMoney(Math.random() * 320, Math.random() + 5, this.color))
    }
    this.draw = function () {
      this.money.forEach(money => {
        money.draw();
      });
      if (GetTime() - this.start > 8000) {
        this.lifetime = 0;
      }
    }
  }

  function WastedEffect() {
    console.log("Wasted")
    Freezbackground = true;
    this.start = GetTime();
    this.bloodDrip = [];
    this.bloodHeight = 0;
    this.Process = function () {
      if (Math.random() > 0.8) {
        this.bloodDrip.push(new blood(Math.random() * 320, 0, "red", 0.01))
      }
      this.elapsed = GetTime() - this.start;
      if (this.bloodHeight < -200) {
        stateHdlr.Pop();
        Freezbackground = false;
        wastedGoing = false;
      }
      this.Draw();
    }
    this.Draw = function () {
      copyScreen(0.1)
      this.bloodDrip.forEach((blood, index) => {
        blood.Draw();
        if (blood.y > 200 - this.bloodHeight) {
          this.bloodHeight -= blood.size;
          this.bloodDrip.splice(index, 1)
        }
      });
      ctx.fillStyle = "red";
      ctx.fillRect(0, 200, 320, this.bloodHeight)
    }
  }

  //We could use the arrow effect as XP effect( something like this:      effects.push(new ArrowEffect("up", "blue", 3, 5, 1500));)

  function ArrowEffect(direction, color, amount, speed, duration) {
    this.start = GetTime();
    this.speed = speed;
    this.duration = duration;
    this.lifetime = this.duration;
    this.direction = direction;
    this.color = color;
    this.amount = amount;
    this.draw = function () {
      if (this.direction == 'up') {
        this.speed = -this.speed;
        ctx.fillStyle = this.color;
        for (let i = 0; i < this.amount; i++) {
          ctx.beginPath();
          ctx.moveTo(160, this.lifetime / 1.5 - 150 - (200 * i));
          ctx.lineTo(320, this.lifetime / 1.5 - (200 * i));
          ctx.lineTo(320, this.lifetime / 1.5 - (200 * i) + 100);
          ctx.lineTo(160, this.lifetime / 1.5 - (200 * i) - 100);
          ctx.lineTo(0, this.lifetime / 1.5 - (200 * i) + 100);
          ctx.lineTo(0, this.lifetime / 1.5 - (200 * i));
          ctx.lineTo(160, this.lifetime / 1.5 - (200 * i) - 150);
          ctx.fill();
        }
      } else {
        ctx.fillStyle = this.color;
        for (let i = 0; i < this.amount; i++) {
          ctx.beginPath();
          ctx.moveTo(160, 300 - this.lifetime / 1.5 + (200 * i));
          ctx.lineTo(320, 240 - this.lifetime / 1.5 + (200 * i));
          ctx.lineTo(320, 180 - this.lifetime / 1.5 + (200 * i));
          ctx.lineTo(160, 240 - this.lifetime / 1.5 + (200 * i));
          ctx.lineTo(0, 180 - this.lifetime / 1.5 + (200 * i));
          ctx.lineTo(0, 240 - this.lifetime / 1.5 + (200 * i));
          ctx.lineTo(160, 300 - this.lifetime / 1.5 + (200 * i));
          ctx.fill();
        }
      }
      this.Ymin += this.speed;
      this.elapsed = new Date().getTime() - this.start;
      this.lifetime = this.duration - this.elapsed;
      if (this.lifetime <= 0) {
        speedAnim = false
      }
    }
  }

  function ParticleExplosion(x, y, color, speed, duration, particleAmount, particleSize, fadeSpeed, notrandomY, useHearts, hasPhysics) {
    this.start = GetTime();
    this.col = color;
    this.speed = speed;
    this.duration = duration;
    this.lifetime = 2000;
    this.amount = particleAmount;
    this.size = particleSize
    this.x = x;
    this.y = y;
    this.fadeSpeed = fadeSpeed;
    this.particles = [];
    this.useHearts = useHearts;
    this.hasPhysics = hasPhysics;

    while (this.particles.length < this.amount) {
      if (notrandomY) {
        this.yspeed = -this.speed / 1.5;
      } else {
        this.yspeed = ((Math.random() - 0.5) * this.speed);
      }
      if (this.useHearts == null || this.useHearts == false) {
        this.particles.push(new ExplosionParticle(this.x, this.y, this.size, this.col, this.fadeSpeed,
          {
            x: ((Math.random() - 0.5) * this.speed),
            y: this.yspeed
          }, this.hasPhysics))
      } else {
        this.particles.push(new HeartParticle(this.x, this.y, this.size, this.col, this.fadeSpeed,
          {
            x: ((Math.random() - 0.5) * this.speed),
            y: this.yspeed
          }))
      }

      this.draw = function () {
        this.lifetime = this.duration - (GetTime() - this.start)
        this.particles.forEach((Particle, index) => {
          Particle.draw()
        })
      }
    }
  };

  function PoliceEffect() {
    this.start = new Date().getTime();
    this.duration = 1500;
    this.timing = 100;
    this.speed = 4;
    this.lifetime = 10;

    this.draw = function () {
      this.elapsed = new Date().getTime() - this.start;
      ctx.globalAlpha = .6;
      if (this.timing > 30 && this.timing < 110) {
        ctx.fillStyle = "#ff0000";
        ctx.fillRect(0, 0, 106, 200);

        ctx.fillStyle = "#0000ff";
        ctx.fillRect(214, 0, 106, 200);
      } else {
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(106, 0, 108, 200);
      }
      if (this.timing > 0) {
        this.timing -= this.speed;
      } else {
        this.timing = 110;
      }
      ctx.globalAlpha = 1;
      if (engine.vision.firstStarBlack1 != 1 || engine.vision.firstStarBlack1 != 1) {
        activePolice = false;
        this.lifetime = 0;
      }
    };
  }

  //Helper effects


  function DrawHeart(x, y, xSize, Ysize, color) {
    ctx.save();
    ctx.beginPath();
    ctx.fillStyle = color;
    ctx.moveTo(x, y);
    // top left curve
    ctx.bezierCurveTo(
      x,
      y,
      x - xSize / 2,
      y - Ysize,
      x - xSize / 2,
      y + Ysize / 4
    );
    ctx.bezierCurveTo(
      x - xSize / 2,
      y + Ysize / 4,
      x - xSize / 2,
      y + Ysize / 4,
      x,
      y + Ysize
    );
    ctx.bezierCurveTo(
      x + xSize / 2,
      y + Ysize / 4,
      x + xSize / 2,
      y + Ysize / 4,
      x + xSize / 2,
      y + Ysize / 4
    );
    ctx.bezierCurveTo(
      x + xSize / 2,
      y + Ysize / 4,
      x + xSize / 2,
      y - Ysize,
      x,
      y
    );

    ctx.fill()
    ctx.restore()
  };

  function GetTime() {
    return new Date().getTime();
  }

  //classes
  class ExplosionParticle {
    constructor(x, y, radius, color, fadeSpeed, velocity, hasPhysics) {
      this.x = x;
      this.y = y;
      this.color = color;
      this.radius = radius;
      this.velocity = velocity;
      this.alpha = 1 * fadeSpeed;
      this.hasPhysics = hasPhysics;
    }
    draw() {
      ctx.globalAlpha = this.alpha;
      ctx.beginPath()
      ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2, false)
      ctx.fillStyle = this.color
      ctx.fill()
      this.x += this.velocity.x
      this.y += this.velocity.y
      if (this.hasPhysics != null || this.hasPhysics != false) {
        this.velocity.y += 0.3;
      }
      this.alpha -= 0.01
      ctx.globalAlpha = 1;
    }
  }

  class fallingMoney {
    constructor(x, speed, color) {
      this.speed = speed / 5;
      this.x = x;
      this.y = 0 - (Math.random() * 250);
      this.startVal = (Math.random() * 50);
      this.start = GetTime();
      this.color = color;
    }
    draw() {
      this.elapsed = GetTime() - this.start;
      this.moveVal = (this.elapsed / 1000);
      ctx.fillStyle = this.color;
      ctx.save();
      ctx.translate(this.x + Math.sin(this.startVal + this.moveVal) * 100, this.y);
      ctx.rotate(-Math.sin(this.moveVal + this.startVal) / 5);
      ctx.fillRect(this.x, this.y, 100, 35);
      ctx.restore();
      this.y += this.speed;
    }
  }

  class blood {
    constructor(x, y, color, fade) {
      this.x = x;
      this.y = y;
      this.color = color;
      this.fade = fade;
      this.speed = (Math.random() + 0.1) * 6
      this.size = (Math.random() * 5) + 5;
    }
    Draw() {
      ctx.beginPath();
      ctx.arc(this.x, this.y, this.size, 0, 2 * Math.PI)
      ctx.fillStyle = this.color;
      ctx.fill();
      this.y += this.speed * Math.random();
      this.x += (Math.random() - 0.5) * 8;
    }

  }

  function copyScreen(alpha) {

    var shine = engine.vision.ShineMeter
    let lightness = new Int8Array(engine.zone.lightness);
    let sat = new Int8Array(engine.zone.saturation);
    let hue = new Int16Array(engine.zone.hue);
    for (var iZone = 0; iZone < 560; iZone++) {
      var iRow = Math.floor(iZone / 28);
      var iCol = iZone % 28;
      var iWidth = 320 / 28;
      var iHeight = 200 / 20;
      var iZx = iCol * iWidth;
      var iZy = iRow * iHeight;
      ctx.fillStyle =
        "hsla(" +
        hue[iZone] +
        "," +
        sat[iZone] +
        "%," +
        lightness[iZone] +
        "%, " +
        `${alpha}` +
        ")";

      ctx.fillRect(iZx, iZy, iWidth, iHeight);
    }

  }

  function StateHandler() {
    var stack = [];
    var state = null;

    var updateState = function () {
      if (stack.length > 0) {
        state = stack[stack.length - 1];
      } else {
        state = null;
      }
    };

    this.Push = function (newState) {
      stack.push(newState);
      updateState();
    };

    this.Pop = function () {
      stack.pop();
      updateState();
    };

    this.Process = function () {
      if (state != null) {
        state.Process();
      }
    };
  }

  function Meter(size, callback) {
    this.size = size;
    this.value = 0;
    this.diff = 0;
    this.increased = false;
    this.decreased = false;
    var values = [];

    this.setValue = function (updatedValue) {
      values.push(updatedValue);
      if (values.length > this.size) {
        values.shift();
      }

      for (var i = 0; i < values.length - 1; i++) {
        if (values[i] !== values[i + 1]) return;
      }
      if (this.value !== values[0]) {
        this.diff = Math.abs(this.value - values[0]);
        this.increased = this.value < values[0];
        this.decreased = this.value > values[0];
        this.value = values[0];
        callback();
      }
    };
  }

  function onEngineReady() {
    // Grab canvas and rendering context.
    canvas = document.getElementById('exCanvas');
    ctx = canvas.getContext('2d');
    window.requestAnimationFrame(update);
  }

  onEngineReady();
</script>