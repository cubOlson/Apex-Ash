<head>
  <title>Rocket League Production</title>
  <meta description="Zoom zoom." />
  <meta publisher="SignalRGB" />

  <meta property="keyScreenBrightness" label="Ambience brightness" type="number" min="0" max="100" default="100" />
  <meta property="hpOn" label="HP Effects" type="boolean" default="1" />

  <meta meter="inGameBlack" tags="rocket league" type="area" x="0.4974" y="0.0076" width="0.01"
    height=".0001" h="0-360" s="0-70" l="0-25">
  </meta>
  <meta meter="inGameBlue" tags="rocket league" type="area" x="0.9317" y="0.8528" width="0.01"
    height=".0001" h="200-260" s="50-100" l="30-90">
  </meta>
  <meta meter="inGameOrange" tags="rocket league" type="area" x="0.9317" y="0.8528" width="0.01"
  height=".0001" h="0-60" s="50-100" l="30-90">
  </meta>
  <meta meter="boost1" tags="rocket league" type="area" x="0.9313" y="0.9458" width="0.001"
  height=".0001" h="0-60" s="60-100" l="50-80">
  </meta>
  <meta meter="boost2" tags="rocket league" type="area" x="0.9061" y="0.9188" width="0.001"
  height=".0001" h="0-60" s="60-100" l="50-100">
  </meta>
  <meta meter="boost3" tags="rocket league" type="area" x="0.9029" y="0.9125" width="0.001"
  height=".0001" h="0-60" s="60-100" l="50-100">
  </meta>
  <meta meter="boost4" tags="rocket league" type="area" x="0.8901" y="0.8396" width="0.001"
  height=".0001" h="0-60" s="60-100" l="50-100">
  </meta>
  <meta meter="boost5" tags="rocket league" type="area" x="0.904" y="0.766" width="0.001"
  height=".0001" h="0-60" s="50-100" l="50-100">
  </meta>
  <meta meter="boost6" tags="rocket league" type="area" x="0.9355" y="0.7271" width="0.001"
  height=".0001" h="0-360" s="0-10" l="90-100">
  </meta>
  <meta meter="boost7" tags="rocket league" type="area" x="0.9688" y="0.7616" width="0.001"
  height=".0001" h="0-360" s="0-10" l="90-100">
  </meta>
  <meta meter="ballCamB" tags="rocket league" type="area" x="0.0378" y="0.9319" width="0.001"
  height=".0001" h="0-30" s="40-75" l="75-100">
  </meta>
  <meta meter="ballCamB2" tags="rocket league" type="area" x="0.0378" y="0.9319" width="0.001"
  height=".0001" h="330-360" s="40-75" l="75-100">
  </meta>
  <meta meter="ballCamA" tags="rocket league" type="area" x="0.0875" y="0.9368" width="0.001"
  height=".0001" h="0-30" s="40-75" l="75-100">
  </meta>
  <meta meter="ballCamA2" tags="rocket league" type="area" x="0.0875" y="0.9368" width="0.001"
  height=".0001" h="330-360" s="40-75" l="75-100">
  </meta>
  <meta meter="win" tags="rocket league" type="area" x="0.9826" y="0.0382" width="0.002"
  height=".001" h="0-360" s="0-10" l="90-100">
  </meta>
  <meta meter="scoreLeft" tags="rocket league" type="area" x="0.4352" y="0.0403" width="0.002"
  height=".01" h="0-360" s="0-50" l="90-100">
  </meta>
  <meta meter="scoreRight" tags="rocket league" type="area" x="0.5642" y="0.0383" width="0.002"
  height=".01" h="0-360" s="0-50" l="90-100">
  </meta>
  <meta meter="scoreBall" tags="rocket league" type="area" x="0.9845" y="0.0743" width="0.0012"
  height=".005" h="0-50" s="0-100" l="0-100">
  </meta>
</head>

<body style="margin: 0; padding: 0; background: #000;">
  <canvas id="exCanvas" width="320" height="200"></canvas>
</body>

<script>
  //engine.zone
  var canvas, ctx;
  canvas = document.getElementById('exCanvas');
  ctx = canvas.getContext('2d');
  var width = 320;
  var height = 200;
  var stateHdlr = new StateHandler();
  var effects = [];
  var inGame = false;
  var boostPushed = false;
  var boostState = 1;
  var oldBoostState = 1;

  var InGameBlackMeter = new Meter(15, inGameHandler);
  var InGameBlueMeter = new Meter(15, inGameHandler);
  var InGameOrangeMeter = new Meter(15, inGameHandler);
  var Boost1Meter = new Meter(5, boostHandler);
  var Boost2Meter = new Meter(5, boostHandler);
  var Boost3Meter = new Meter(5, boostHandler);
  var Boost4Meter = new Meter(5, boostHandler);
  var Boost5Meter = new Meter(5, boostHandler);
  var Boost6Meter = new Meter(5, boostHandler);
  var Boost7Meter = new Meter(5, boostHandler);
  var WinMeter = new Meter(5, inGameHandler);
  var ScoreLeftMeter = new Meter(5, inGameHandler);
  var ScoreRightMeter = new Meter(5, inGameHandler);
  var ScoreBallMeter = new Meter(5, inGameHandler);

  function update() {

    InGameBlackMeter.setValue(engine.vision.inGameBlack)
    InGameBlueMeter.setValue(engine.vision.inGameBlue)
    InGameOrangeMeter.setValue(engine.vision.inGameOrange)

    if(inGame){
      Boost1Meter.setValue(engine.vision.boost1)
      Boost2Meter.setValue(engine.vision.boost2)
      Boost3Meter.setValue(engine.vision.boost3)
      Boost4Meter.setValue(engine.vision.boost4)
      Boost5Meter.setValue(engine.vision.boost5)
      Boost6Meter.setValue(engine.vision.boost6)
      Boost7Meter.setValue(engine.vision.boost7)
      WinMeter.setValue(engine.vision.win)
      ScoreLeftMeter.setValue(engine.vision.scoreLeft)
      ScoreRightMeter.setValue(engine.vision.scoreRight)
      ScoreBallMeter.setValue(engine.vision.scoreBall)
    }

    ballCamHandler()

    drawRect(0, 0, 320, 200, "black");

    if (keyScreenBrightness > 0) {
      copyScreen(1);
    }

    for (let i = 0; i < effects.length; i++) {
      effects[i].draw();
      if (effects[i].lifetime <= 0) {
        effects.splice(i, 1);
      }
    };

    stateHdlr.Process();
    window.requestAnimationFrame(update);
  };

  function inGameHandler() {
    if(InGameBlackMeter.value == 1 && (InGameBlueMeter.value == 1 || InGameOrangeMeter.value == 1)){
      inGame = true;
    } else {
      effects = [];
      inGame = false;
    }
  };

  function ballCamHandler(){
    if(engine.vision.ballCamB + engine.vision.ballCamB2 > .75 && engine.vision.ballCamA + engine.vision.ballCamA2 > .75){
      console.log("IN BALL CAM")
    } else {
      console.log("NOT BALL CAM")
    }
  }

  function boostHandler(){
    if(Boost7Meter.value == 1){
      console.log("Boost Stage 7")
      boostState = 7;
    } else if(Boost6Meter.value == 1){
      console.log("Boost Stage 6")
      boostState = 6;
    } else if(Boost5Meter.value == 1){
      console.log("Boost Stage 5")
      boostState = 5;
    } else if(Boost4Meter.value == 1){
      console.log("Boost Stage 4")
      boostState = 4;
    } else if(Boost3Meter.value == 1){
      console.log("Boost Stage 3")
      boostState = 3;
    } else if(Boost2Meter.value == 1){
      console.log("Boost Stage 2")
      boostState = 2;
    } else if(Boost1Meter.value == 1){
      console.log("Boost Stage 1")
      boostState = 1;
    } else {
      console.log("No Boost")
      boostState = 0;
    }
    if(boostState > oldBoostState){
      console.log("Boost Up");
    }
    oldBoostState = boostState;
  }

  function winHandler(){
    if(WinMeter.value == 1 && ScoreBallMeter.value == 1){
      console.log("Win")
    }
  }

  function scoreHandler(){
    if(ScoreBallMeter.value == 1 && (ScoreLeftMeter.value == 1 || ScoreRightMeter.value == 1)){
      console.log("Score Increase")
    }
  }

  function renderPath(x, y, path, color) {
    ctx.fillStyle = color;
    ctx.save();
    ctx.translate(x, y);
    let ex = new Path2D(path);
    ctx.fill(ex);
    ctx.restore();
  }

  function DrawCircle(x, y, radius, color) {
    ctx.beginPath();
    ctx.fillStyle = color;
    ctx.arc(x, y, radius, 0, 2 * Math.PI)
    ctx.fill();
  };

  function DrawStroke(x, y, radius, color, stroke) {
    ctx.beginPath();
    ctx.strokeStyle = color;
    ctx.lineWidth = stroke;
    ctx.arc(x, y, radius, 0, 2 * Math.PI)
    ctx.stroke();
  };

  function drawRect(x, y, height, width, color) {
    ctx.beginPath();
    ctx.fillStyle = color;
    ctx.fillRect(x, y, height, width);
  }

  function copyScreen(alpha) {
    var shine = engine.vision.ShineMeter
    let lightness = new Int8Array(engine.zone.lightness);
    let sat = new Int8Array(engine.zone.saturation);
    let hue = new Int16Array(engine.zone.hue);
    for (var iZone = 0; iZone < 560; iZone++) {
      var iRow = Math.floor(iZone / 28);
      var iCol = iZone % 28;
      var iWidth = 320 / 28;
      var iHeight = 200 / 20;
      var iZx = iCol * iWidth;
      var iZy = iRow * iHeight;
      ctx.fillStyle =
        "hsla(" +
        hue[iZone] +
        "," +
        sat[iZone] +
        "%," +
        lightness[iZone] * keyScreenBrightness / 100 +
        "%, " +
        `${alpha}` +
        ")";

      ctx.fillRect(iZx, iZy, iWidth, iHeight);
    }

  }

  function StateHandler() {
    var stack = [];
    var state = null;

    var updateState = function () {
      if (stack.length > 0) {
        state = stack[stack.length - 1];
      } else {
        state = null;
      }
    };

    this.Push = function (newState) {
      stack.push(newState);
      updateState();
    };

    this.Pop = function () {
      stack.pop();
      updateState();
    };

    this.Process = function () {
      if (state != null) {
        state.Process();
      }
    };
  }

  function Meter(size, callback) {
    this.size = size;
    this.value = 0;
    this.diff = 0;
    this.increased = false;
    this.decreased = false;
    var values = [];

    this.setValue = function (updatedValue) {
      values.push(updatedValue);
      if (values.length > this.size) {
        values.shift();
      }

      for (var i = 0; i < values.length - 1; i++) {
        if (values[i] !== values[i + 1]) return;
      }
      if (this.value !== values[0]) {
        this.diff = Math.abs(this.value - values[0]);
        this.increased = this.value < values[0];
        this.decreased = this.value > values[0];
        this.value = values[0];
        callback();
      }
    };
  }

  function timedMeter(size, callback) {
    this.size = size;
    this.value = 0;
    this.diff = 0;
    this.increased = false;
    this.decreased = false;
    this.start = Date.now();
    this.elapsed = 0;
    var values = [];

    this.setValue = function (updatedValue) {
      values.push(updatedValue);
      this.elapsed = Date.now() - this.start;
      if (values.length > this.size) {
        values.shift();
      }

      for (var i = 0; i < values.length - 1; i++) {
        if (values[i] !== values[i + 1]) return;
      }
      if (this.value !== values[0]) {
        this.diff = Math.abs(this.value - values[0]);
        this.increased = this.value < values[0];
        this.decreased = this.value > values[0];
        this.value = values[0];
        this.start = Date.now();
        callback();
      }
    };
  }
  window.requestAnimationFrame(update)
</script>