<head>
    <title>Elden Ring</title>
    <meta description="HUD and effects for Elden Ring." />
    <meta publisher="SignalRgb" />

    <meta
    property="keyScreenBrightness"
    label="Ambiance brightness"
    type="number"
    min="0"
    max="100"
    default="100"
    />
    <meta
    property="healthY"
    label="Health y-value"
    type="number"
    min="0"
    max="200"
    default="100"
    />
    <meta
    property="healthHeight"
    label="Health bar height"
    type="number"
    min="0"
    max="100"
    default="100"
    />
    <meta
    property="manaY"
    label="Mana y-value"
    type="number"
    min="0"
    max="200"
    default="100"
    />
    <meta
    property="manaHeight"
    label="Mana bar height"
    type="number"
    min="0"
    max="100"
    default="100"
    />
    <meta
    property="staminaY"
    label="Stamina y-value"
    type="number"
    min="0"
    max="200"
    default="100"
    />
    <meta
    property="staminaHeight"
    label="Stamina bar height"
    type="number"
    min="0"
    max="100"
    default="100"
    />
    <meta
    property="itemY"
    label="Item Charge y-value"
    type="number"
    min="0"
    max="200"
    default="100"
    />
    <meta
    property="itemRadius"
    label="Item charge size"
    type="number"
    min="0"
    max="100"
    default="100"
    />

    <meta meter="hpRed" tags="vlc,ELDEN RING" type="linear" x= "0.0818" y= "0.0481" width= "0.3" h="0-20" s="40-90" l="0-60">
    </meta>
    <meta meter="hpConfirm" tags="vlc,ELDEN RING" type="linear" x= "0.0818" y= "0.0551" width= "0.3" h="30-80" s="0-35" l="20-100">
    </meta>
    <meta meter="hpYellow" tags="vlc,ELDEN RING" type="area" x= "0.0818" y= "0.0481" height= "0.001" width= "0.3" h="30-50" s="75-100" l="50-75">
    </meta>
    <meta meter="manaBlue" tags="vlc,ELDEN RING" type="linear" x= "0.0818" y= "0.0639" width= "0.3" h="190-210" s="40-90" l="0-60">
    </meta>
    <meta meter="manaConfirm" tags="vlc,ELDEN RING" type="linear" x= "0.0818" y= "0.0713" width= "0.3" h="40-80" s="0-35" l="20-100">
    </meta>
    <meta meter="manaYellow" tags="vlc,ELDEN RING" type="area" x= "0.0818" y= "0.0639" height= "0.001" width= "0.3" h="30-50" s="75-100" l="50-75">
    </meta>
    <meta meter="staminaGreen" tags="vlc,ELDEN RING" type="linear" x= "0.0818" y= "0.0806" width= "0.3" h="130-160" s="40-90" l="0-60">
    </meta>
    <meta meter="staminaConfirm" tags="vlc,ELDEN RING" type="linear" x= "0.0818" y= "0.088" width= "0.3" h="40-80" s="0-35" l="20-100">
    </meta>
    <meta meter="staminaYellow" tags="vlc,ELDEN RING" type="area" x= "0.0818" y= "0.0806" height= "0.001" width= "0.3" h="30-50" s="75-100" l="50-75">
    </meta>
    <meta meter="greatRune" tags="vlc,ELDEN RING" type="linear" x= "0.0443" y= "0.1037" width= "0.01" h="40-80" s="0-35" l="40-75">
    </meta>
    <meta meter="leftItemFrame" tags="vlc,ELDEN RING" type="linear" x= "0.0281" y= "0.7944" width= "0.014" h="40-80" s="0-35" l="40-75">
    </meta>
    <meta meter="rightSouls" tags="vlc,ELDEN RING" type="area" x= "0.9734" y= "0.9417" height= "0.0025" width= "0.001" h="40-80" s="0-35" l="40-75">
    </meta>
    <meta meter="compassMark" tags="vlc,ELDEN RING" type="area" x= "0.499" y= "0.1231" height= "0.008" width= "0.003" h="40-80" s="0-35" l="40-75">
    </meta>
    <meta meter="itemCharges" tags="vlc,ELDEN RING" type="ocr_numeric" confidence="70" x=".1068" y=".9222" width=".013" height=".0194"> 
    </meta>
    <meta meter="diedRed" tags="vlc,ELDEN RING" type="area" x= "0.507" y= "0.4694" height= "0.02" width= "0.0033" h="340-360" s="75-100" l="25-50">
    </meta>
    <meta meter="discoveredOrange1" tags="vlc,ELDEN RING" type="area" x= "0.224" y= "0.47" height= "0.02" width= "0.0033" h="30-40" s="65-90" l="75-100">
    </meta>
    <meta meter="discoveredOrange2" tags="vlc,ELDEN RING" type="area" x= "0.507" y= "0.47" height= "0.02" width= "0.0033" h="30-40" s="65-90" l="75-100">
    </meta>
    <meta meter="discoveredOrange3" tags="vlc,ELDEN RING" type="area" x= "0.7547" y= "0.47" height= "0.02" width= "0.0033" h="30-40" s="65-90" l="75-100">
    </meta>
    <meta meter="legendD" tags="vlc,ELDEN RING" type="area" x= "0.499" y= "0.4796" height= "0.02" width= "0.003" h="45-60" s="60-90" l="75-100">
    </meta>
    <meta meter="legendE" tags="vlc,ELDEN RING" type="area" x= "0.6213" y= "0.4722" height= "0.02" width= "0.0033" h="45-60" s="60-90" l="75-100">
    </meta>
    <meta meter="enemyE" tags="vlc,ELDEN RING" type="area" x= "0.3442" y= "0.4731" height= "0.02" width= "0.003" h="45-60" s="60-90" l="75-100">
    </meta>
    <meta meter="enemyE2" tags="vlc,ELDEN RING" type="area" x= "0.6095" y= "0.4731" height= "0.02" width= "0.0033" h="45-60" s="60-90" l="75-100">
    </meta>

</head>
<body style="margin: 0; padding: 0; background: #000;">
  <canvas id="exCanvas" width="320" height="200"></canvas>
</body>
<script>
  canvas = document.getElementById('exCanvas');
  ctx = canvas.getContext('2d');
  var effects = [];
  var inGame = false;
  var oldHealthY = 0;
  var oldHealthHeight = 0;
  var oldStaminaY = 0;
  var oldStaminaHeight = 0;
  var oldManaY = 0;
  var oldManaHeight = 0;
  var blockUpdates = false;
  var itemAnim = false;
  var compass = false;
  var discAnim = false;
  var diedAnim = false;
  var enemyAnim = false;
  var legendAnim = false;

  var inGame1Meter = new Meter(10, inGameCheck);
  var inGame2Meter = new Meter(10, inGameCheck);
  var inGame3Meter = new Meter(10, inGameCheck);
  var inGame4Meter = new Meter(10, inGameCheck);
  
  var healthLengthMeter = new Meter(20, ()=>"");
  var healthRedMeter = new Meter(3, ()=>"");
  var healthYellowMeter = new Meter(2, healthEffect);
  var manaLengthMeter = new Meter(20, ()=>"");
  var manaBlueMeter = new Meter(3, ()=>"");
  var manaYellowMeter = new Meter(2, manaEffect);
  var staminaLengthMeter = new Meter(20, ()=>"");
  var staminaGreenMeter = new Meter(3, ()=>"");
  var staminaYellowMeter = new Meter(2, staminaEffect);

//   var itemChargeMeter = new Meter(3, itemEffects);

  var discOrange1Meter = new Meter(3, discoveryEffect);
  var discOrange2Meter = new Meter(3, discoveryEffect);
  var discOrange3Meter = new Meter(3, discoveryEffect);
  var diedRedMeter = new Meter(3, deathEffect);
  var legendDMeter = new Meter(3, legendEffect);
  var legendEMeter = new Meter(3, legendEffect);
  var enemyEMeter = new Meter(3, enemyEffect);
  var enemyE2Meter = new Meter(3, enemyEffect);

  function update(){
    copyScreen(1);
    
    inGame1Meter.setValue(engine.vision.greatRune);
    inGame2Meter.setValue(engine.vision.leftItemFrame);
    inGame3Meter.setValue(engine.vision.rightSouls);
    inGame4Meter.setValue(engine.vision.compassMark);
    diedRedMeter.setValue(engine.vision.diedRed);
    discOrange1Meter.setValue(engine.vision.discoveredOrange1);
    discOrange2Meter.setValue(engine.vision.discoveredOrange2);
    discOrange3Meter.setValue(engine.vision.discoveredOrange3);
    legendDMeter.setValue(engine.vision.legendD);
    legendEMeter.setValue(engine.vision.legendE);
    enemyEMeter.setValue(engine.vision.enemyE);
    enemyE2Meter.setValue(engine.vision.enemyE2);

    if(!blockUpdates){
      if(inGame4Meter.value > .75){
          healthLengthMeter.setValue(engine.vision.hpConfirm);
          healthRedMeter.setValue(engine.vision.hpRed);
      }
      if(inGame){
          healthLengthMeter.setValue(engine.vision.hpConfirm);
          healthRedMeter.setValue(engine.vision.hpRed);
          healthYellowMeter.setValue(engine.vision.hpYellow);
          manaLengthMeter.setValue(engine.vision.manaConfirm);
          manaBlueMeter.setValue(engine.vision.manaBlue);
          manaYellowMeter.setValue(engine.vision.manaYellow);
          staminaLengthMeter.setValue(engine.vision.staminaConfirm);
          staminaGreenMeter.setValue(engine.vision.staminaGreen);
          staminaYellowMeter.setValue(engine.vision.staminaYellow);
      }
    }

    healthY == oldHealthY ? null : effects.push(new adjRect(0, healthY, 320, healthHeight, "red"));
    oldHealthY = healthY;
    healthHeight == oldHealthHeight ? null : effects.push(new adjRect(0, healthY, 320, healthHeight, "red"));
    oldHealthHeight = healthHeight;
    staminaY == oldStaminaY ? null : effects.push(new adjRect(0, staminaY, 320, staminaHeight, "green"));
    oldStaminaY = staminaY;
    staminaHeight == oldStaminaHeight ? null : effects.push(new adjRect(0, staminaY, 320, staminaHeight, "green"));
    oldStaminaHeight = staminaHeight;
    manaY == oldManaY ? null : effects.push(new adjRect(0, manaY, 320, manaHeight, "blue"));
    oldManaY = manaY;
    manaHeight == oldManaHeight ? null : effects.push(new adjRect(0, manaY, 320, manaHeight, "blue"));
    oldManaHeight = manaHeight;

    effects.forEach((ele, i) => {
        ele.draw();
        if (ele.lifetime <= 0){
            effects.splice(i, 1);
        }
    });

    window.requestAnimationFrame(update);
  }

    function inGameCheck(){
        if(inGame4Meter.value > .75 && !blockUpdates){
            effects.push(new healthBar());
        }
        if (inGame1Meter.value > .75 && inGame2Meter.value > .75 && inGame3Meter.value > .75 && !blockUpdates){
            inGame = true;
            effects.push(new manaBar());
            effects.push(new staminaBar());
            effects.push(new healthBar());
        } else {
            inGame = false;
        }
    }

    function healthEffect(){
        if(healthYellowMeter.value){
            effects.push(new statLoss(healthY, healthHeight, 0))
        }
    };

    function manaEffect(){
        if(manaYellowMeter.value){
            effects.push(new statLoss(manaY, manaHeight, 210))
        }
    };

    function staminaEffect(){
        if(staminaYellowMeter.value){
            effects.push(new statLoss(staminaY, staminaHeight, 60))
        }
    };

    function discoveryEffect(){
        if(discOrange1Meter.value > .9 && discOrange2Meter.value > .9 && discOrange3Meter.value > .9){
            discAnim = true;
            effects.push(new foundGraceEffect());
        } else {
            discAnim = false;
        }
    };

    function deathEffect(){
        if(diedRedMeter.value > .9 && healthRedMeter.value < .01 && !diedAnim){
            diedAnim = true;
            blockUpdates = true;
            effects = [];
            effects.push(new death());
        }
    };

    function legendEffect(){
        if(legendDMeter.value > .9 && legendEMeter.value > .9 && !enemyAnim){
            enemyAnim = true;
            blockUpdates = true;
            effects = [];
            effects.push(new enemyKilledEffect(true));
        }
    };

    function enemyEffect(){
        if(enemyEMeter.value > .9 && enemyE2Meter.value > .9 && !enemyAnim){
            blockUpdates = true;
            enemyAnim = true;
            effects = [];
            effects.push(new enemyKilledEffect(false));
        }
    };

    function statLoss(y, height, target){
        this.x = 0;
        this.y = y;
        this.height = height;
        this.target = target;
        this.hue = 60;
        this.lifetime = 20;
        this.alpha = 1;
        this.change = (this.target - this.hue) / 20;

        this.draw = function(){
            this.alpha = this.lifetime / 20;
            ctx.globalAlpha = this.alpha;
            drawRect(this.x, this.y, 320, this.height, `hsl(${this.hue}, 100%, 50%)`);
            this.hue += this.change;
            ctx.globalAlpha = 1;
            this.lifetime--;
        }
    };

    function healthBar(){
        this.x = 0;
        this.y = 0;
        this.height = 50;
        this.lifetime = 50;

        this.draw = function(){
            this.y = healthY;
            this.height = healthHeight;
            var width = healthRedMeter.value / healthLengthMeter.value * 320;
            drawRect(this.x, this.y, width, this.height, "red");

            if(!inGame && inGame4Meter.value == 0){
                this.lifetime = 0;
            }
        }
    }

    function manaBar(){
        this.x = 0;
        this.y = 50;
        this.height = 50;
        this.lifetime = 50;

        this.draw = function(){
            this.y = manaY;
            this.height = manaHeight;
            var width = manaBlueMeter.value / manaLengthMeter.value * 320;
            drawRect(this.x, this.y, width, this.height, "blue");

            if(!inGame){
                this.lifetime = 0;
            }
        }
    }

    function staminaBar(){
        this.x = 0;
        this.y = 100;
        this.height = 50;
        this.lifetime = 50;

        this.draw = function(){
            this.y = staminaY;
            this.height = staminaHeight;
            var width = staminaGreenMeter.value / staminaLengthMeter.value * 320;
            drawRect(this.x, this.y, width, this.height, "green");

            if(!inGame){
                this.lifetime = 0;
            }
        }
    }

  function Meter(count, callback) {
    this.size = count;
    this.value = 0;
    this.diff = 0;
    this.increased = false;
    this.decreased = false;
    var values = [];

    this.setValue = function (updatedValue) {
      values.push(updatedValue);
      if (values.length > this.size) {
        values.shift();
      }

      for (var i = 0; i < values.length - 1; i++) {
        if (values[i] !== values[i + 1]) return;
      }

      if (this.value !== values[0]) {
        this.diff = Math.abs(this.value - values[0]);
        this.increased = this.value < values[0];
        this.decreased = this.value > values[0];
        this.value = values[0];
        callback();
      }
    };
  }

  function copyScreen(alpha) {
    let lightness = new Int8Array(engine.zone.lightness);
    let sat = new Int8Array(engine.zone.saturation);
    let hue = new Int16Array(engine.zone.hue);

    for (var iZone = 0; iZone < 560; iZone++) {
        ctx.fillStyle =
          "hsla(" +
          hue[iZone] +
          "," +
          sat[iZone] +
          "%," +
          lightness[iZone] *keyScreenBrightness * 0.01  +
          "%, " +
          alpha
          +
          ")";
      
      var iRow = Math.floor(iZone / 28);
      var iCol = iZone % 28;
      var iWidth = 320 / 28;
      var iHeight = 200 / 20;
      var iZx = iCol * iWidth;
      var iZy = iRow * iHeight;

      ctx.fillRect(iZx, iZy, iWidth, iHeight);
    }
  }

  function foundGraceEffect(){
    this.lifetime = 100;
    effects.push(new DrawPulseStroke(160, 100, 5, 9, 30, "gold"));
    setTimeout(()=>{effects.push(new DrawPulseStroke(160, 100, 5, 8, 25, "gold"))}, 100);
    setTimeout(()=>{effects.push(new DrawPulseStroke(160, 100, 5, 7, 20, "gold"))}, 200);
    setTimeout(()=>{effects.push(new DrawPulseStroke(160, 100, 5, 6, 15, "gold"))}, 300);
    setTimeout(()=>{effects.push(new DrawPulseStroke(160, 100, 5, 5, 10, "gold"))}, 400);
    this.draw = function(){
      ctx.beginPath();
      ctx.fillStyle = "yellow";
      ctx.globalAlpha = this.lifetime / 200;
      ctx.fillRect(0, 0, 320, 200);
      ctx.globalAlpha = 1;
      this.lifetime --;
    }
  }

  function DrawPulseStroke(x,y,radius,speed,lineWidth,color){
        this.x = x;
        this.y = y;
        this.radius = radius;
        this.speed = speed;
        this.lineWidth = lineWidth;
        this.color = color;
        this.lifetime = 10;
        this.draw = function(){
          ctx.beginPath();
          ctx.strokeStyle = this.color;
          ctx.lineWidth = this.lineWidth;
          ctx.arc(this.x,this.y,this.radius, 0, 2* Math.PI)
          ctx.stroke();
          this.radius += speed;
          if (this.radius > 200){
            this.lifetime = 0;
          }
        }
    };

  function death(){
    this.start = Date.now();
    this.elapsed = 0;
    this.lifetime = 1000;
    this.draw = function(){
      this.elapsed = Date.now() - this.start;
      if(this.elapsed < 1000){
        this.index = Math.floor(this.elapsed/100);
        ctx.globalAlpha = .2;
        for(i = 0; i <= this.index; i++){
          DrawCircle(160, 100, 20 * i, "red");
        }
        ctx.globalAlpha = 1;
      } else {
        DrawCircle(160, 100, 200, "black")
        for(let i = 0; i < 3; i++){
          effects.push(new movingParticle(320 * Math.random(), 200, 1, "white", false))
        }
        this.lifetime-=10;
        if (this.lifetime <= 0){
            diedAnim = false;
            setTimeout(()=>{blockUpdates = false},5000)
        }
      }
    }
  }

  function enemyKilledEffect(legend){
    this.lifetime = 10;
    this.colors = legend? ["blue", "cyan", "white"] : ["orange", "yellow", "white"];
    this.start = Date.now();
    this.draw = function(){
      this.elapsed = Date.now() - this.start;
      for(let i = 0; i < 3; i++){
          effects.push(new movingParticle(320 * Math.random(), 200, 1, this.colors[0], true));
        }
      if(this.elapsed > 250){
        for(let i = 0; i < 2; i++){
          effects.push(new movingParticle(220 * Math.random() + 50, 200, 3, this.colors[1], true));
        }
      }
      if(this.elapsed > 1000){
        for(let i = 0; i < 1; i++){
          effects.push(new movingParticle(120 * Math.random() + 100, 200, 5, this.colors[2], true));
        }
      }
      if(this.elapsed > 5000){
        this.lifetime = 0;
        enemyAnim = false;
        setTimeout(()=>{blockUpdates = false},5000)
      }
    }
  }

  function movingParticle(x, y, speed, color, up){
    this.x = x;
    this.y = y;
    this.speed = speed;
    this.color = color;
    this.radius = Math.random() * 30;
    this.vy = 8 * Math.random() + this.speed;
    this.vx = up? 0 : 3 * Math.random() + this.speed;
    this.lifetime = 10;

    this.draw = function(){
      DrawCircle(this.x, this.y, this.radius, this.color);
      this.x += this.vx;
      this.y -= this.vy;
      if(this.y < 0){
        this.lifetime = 0;
      }
    }
  };

    function drawRect(x, y, width, height, color){
        ctx.beginPath();
        ctx.fillStyle = color;
        ctx.fillRect(x,y,width,height)
        ctx.fill();
    }

    function adjRect(x, y, width, height, color){
        this.x = x;
        this.y = y;
        this.width = width;
        this.height = height;
        this.color = color;
        this.lifetime = 30;

        this.draw = function(){
            ctx.beginPath();
            ctx.fillStyle = color;
            ctx.fillRect(x,y,width,height)
            ctx.fill();
            this.lifetime--;
        }
    }

      function DrawCircle(x,y,radius,color){
        ctx.beginPath();
        ctx.fillStyle = color;
        ctx.arc(x,y,radius, 0, 2* Math.PI)
        ctx.fill();
      };

  window.requestAnimationFrame(update);
</script>
  