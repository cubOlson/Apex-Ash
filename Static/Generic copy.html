<head>
    <title>Basic Effects</title>
    <meta description="Basic Effects" />
    <meta publisher="SignalRgb" />

    <meta property="drX" label="Dr X-Coordinate" type="number" min="-200" max="200" default="-56"/>
    <meta property="drY" label="Dr Y-Coordinate" type="number" min="-200" max="200" default="-37"/>
    <meta property="drScale" label="Dr Scale" type="number" min="0" max="50" default="15"/>
    <meta property="sweepSpeed" label="Sweep Speed" type="number" min="0" max="100" default="50"/>

</head>
<body style="margin: 0; padding: 0; background: #000;">
  <canvas id="exCanvas" width="320" height="200"></canvas>
</body>
<script>
  canvas = document.getElementById('exCanvas');
  ctx = canvas.getContext('2d');
  var effects = [];

  var tones1Meter = new Meter(1, ()=>"");
  var tones2Meter = new Meter(1, ()=>"");
  var tones3Meter = new Meter(1, ()=>"");
  var tones4Meter = new Meter(1, ()=>"");
  var tones5Meter = new Meter(1, ()=>"");
  var tones6Meter = new Meter(1, ()=>"");

  function update(){
    drawRect(0,0, 320, 200, "black");
    
    var frequency = new Int8Array(engine.audio.freq)
    var tones1 = frequency.slice(0, 33);
    var reduced1 = tones1.reduce((a, b) => a + b, 0);
    var tones2 = frequency.slice(33, 66);
    var reduced2 = tones2.reduce((a, b) => a + b, 0);
    var tones3 = frequency.slice(66, 99);
    var reduced3 = tones3.reduce((a, b) => a + b, 0);
    var tones4 = frequency.slice(99, 132);
    var reduced4 = tones4.reduce((a, b) => a + b, 0);
    var tones5 = frequency.slice(132, 165);
    var reduced5 = tones5.reduce((a, b) => a + b, 0);
    var tones6 = frequency.slice(165, 198);
    var reduced6 = tones6.reduce((a, b) => a + b, 0);
    
    tones1Meter.setValue(reduced1);
    tones2Meter.setValue(reduced2);
    tones3Meter.setValue(reduced3);
    tones4Meter.setValue(reduced4);
    tones5Meter.setValue(reduced5);
    tones6Meter.setValue(reduced6);

    if(tones1Meter.increased && tones1Meter.value > 200){
      effects.push(new audioCube("red", 1));
    }
    if(tones2Meter.increased && tones2Meter.value > 200){
      effects.push(new audioCube("orange", 2));
    }
    if(tones3Meter.increased && tones3Meter.value > 200){
      effects.push(new audioCube("yellow", 3));
    }
    if(tones4Meter.increased && tones4Meter.value > 200){
      effects.push(new audioCube("green", 4));
    }
    if(tones3Meter.increased && tones3Meter.value > 200){
      effects.push(new audioCube("blue", 5));
    }
    if(tones4Meter.increased && tones4Meter.value > 200){
      effects.push(new audioCube("purple", 6));
    }


    effects.forEach((ele, i) => {
        ele.draw();
        if(ele.lifetime <= 0){
          effects.splice(i, 1);
        }
      });

    for (let i = 0; i < frequency.length; i++){
      drawRect(i * 1.6, 200, 1.6, -frequency[i] * 2, "white")
    }

    window.requestAnimationFrame(update);
  }

  function audioCube(color, zone){

      this.lifetime = 10;
      this.y = 200;
      this.color = color;
      // this.x = zone == 1 ? Math.random() * 53 : 
      //   zone == 2 ? Math.random() * 53 + 53 : 
      //   zone == 3 ? Math.random() * 53 + 106 : 
      //   zone == 4 ? Math.random() * 53 + 159 :
      //   zone == 5 ? Math.random() * 53 + 212 : Math.random() * 53 + 265;
      this.x = zone == 1 ? 0 : 
        zone == 2 ? 53 : 
        zone == 3 ? 106 : 
        zone == 4 ? 159 :
        zone == 5 ? 212 : 265;

      this.draw = function(){
        ctx.globalAlpha = .5;
        ctx.fillStyle = this.color;
        ctx.fillRect(this.x, this.y, 53, 53);
        ctx.globalAlpha = 1;
        this.y-=10;
        if(this.y < -30){
          this.lifetime = 0;
        }
      }
    }

  function Meter(count, callback) {
    this.size = count;
    this.value = 0;
    this.diff = 0;
    this.increased = false;
    this.decreased = false;
    var values = [];

    this.setValue = function (updatedValue) {
      values.push(updatedValue);
      if (values.length > this.size) {
        values.shift();
      }

      for (var i = 0; i < values.length - 1; i++) {
        if (values[i] !== values[i + 1]) return;
      }

      if (this.value !== values[0]) {
        this.diff = Math.abs(this.value - values[0]);
        this.increased = this.value < values[0];
        this.decreased = this.value > values[0];
        this.value = values[0];
        callback();
      }
    };
  }

    function DrawCircle(x,y,radius,color){
        ctx.beginPath();
        ctx.fillStyle = color;
        ctx.arc(x,y,radius, 0, 2* Math.PI)
        ctx.fill();
    };

    function DrawStroke(x,y,radius,color){
        ctx.beginPath();
        ctx.strokeStyle = color;
        ctx.arc(x,y,radius, 0, 2* Math.PI)
        ctx.stroke();
    };

    function drawRect(x, y, height, width, color){
      ctx.beginPath();
      ctx.fillStyle = color;
      ctx.fillRect(x, y, height, width);
    }

  window.requestAnimationFrame(update);
</script>
  