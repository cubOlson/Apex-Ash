<head>
  <title>Lightsaber Test</title>
  <meta description="Basic Effects" />
  <meta publisher="SignalRgb" />

  <meta property="scaleX" label="Horizontal Scaling" type="number" min="0" max="100" default="50" />
  <meta property="scaleY" label="Vertical Scaling" type="number" min="0" max="100" default="50" />
  <meta property="posX" label="Horizontal Positioning" type="number" min="0" max="100" default="50" />
  <meta property="posY" label="Vertical Positioning" type="number" min="0" max="100" default="50" />
  <meta property="backgroundFade" label="Background fade" type="number" min="0" max="100" default="100" />
  <meta property="hitFlash" label="Hit flash" type="boolean" default="0" />
  <meta property="swordStyle" label="Sword style" type="boolean" default="0" />
  <meta property="speed" label="Lightsaber Speed" type="number" min="0" max="100" default="50" />
  <meta property="saber1" label="Lightsaber 1 Color" type="color" min="0" max="360" default="#FF0000" />
  <meta property="saber2" label="Lightsaber 2 Color" type="color" min="0" max="360" default="#0000FF" />

</head>

<body style="margin: 0; padding: 0; background: #000;">
  <canvas id="exCanvas" width="320" height="200"></canvas>
</body>
<script>
  canvas = document.getElementById('exCanvas');
  ctx = canvas.getContext('2d');
  var flashEffects = [];
  var effects = [];
  var moveset = [slash1, slash2, stab1, stab2, feint1]
  var old = 0;
  var start = Date.now()

  function update() {
    var elapsed = Date.now() - start;

    if (effects.length < 1) {
      // effects.push(new feint1(saber1, saber2))
      var index = Math.floor(Math.random() * 3.99);
      index == old ? index >= moveset.length - 1 ? index-- : index++ : null;
      effects.push(new moveset[index](saber1, saber2))
      old = index;
    }

    if(elapsed > 2000 / speed){
      ctx.globalAlpha = backgroundFade / 100;
      DrawRect(0, 0, 320, 200, "black");
      ctx.globalAlpha = 1;
  
      flashEffects.forEach((ele, i) => {
        ele.draw();
        if (ele.lifetime <= 0) {
          flashEffects.splice(i, 1);
        }
      });
  
      effects.forEach((ele, i) => {
        ele.draw();
        if (ele.lifetime <= 0) {
          effects.splice(i, 1);
        }
      });
      start = Date.now();
    }

    window.requestAnimationFrame(update);
  }

  function slash1(color1, color2) {
    this.elapsed = 0;
    this.light1 = new lightsaber(80, 140, color1, 0);
    this.light2 = new lightsaber(200, 140, color2, 0);
    this.lifetime = 10;
    this.count = 0;
    this.draw = function () {
      ctx.save()
      ctx.transform(scaleX / 50, 0, 0, scaleY / 50, -160 + (posX * 320 / 100) + (50 - scaleX) * 3.1, -100 + (posY * 200 / 100) + (50 - scaleY) * 2.4);
      if (this.elapsed < 10) {
        this.light1.x -= 1;
        this.light1.rotation = .1;
        this.light2.x += 1;
        this.light2.rotation = -.1;
      } else if (this.elapsed < 40) {
        if (this.count == 0) {
          flashEffects.push(new contact(this.x, this.y))
          this.count++
        }
        this.light1.y += Math.sin(Date.now() / 100);
        this.light1.rotation = 0;
        this.light2.y += Math.sin(Date.now() / 100);
        this.light2.rotation = 0;
      } else if (this.elapsed < 50) {
        this.light1.x -= 7;
        this.light1.y -= 3;
        this.light1.rotation = .1;
        this.light2.x += 1;
        this.light2.y -= 8;
        this.light2.rotation = .3;
      } else if (this.elapsed < 60) {
        if (this.count == 1) {
          setTimeout(() => {flashEffects.push(new contact(this.x, this.y)) }, 100)
          this.count++
        }
        this.light1.x += 5;
        this.light1.y -= 7;
        this.light1.rotation = .05;
        this.light2.x -= 1;
        this.light2.y += 6;
        this.light2.rotation = -.5;
      } else if (this.elapsed < 70) {
        this.light1.x += 0;
        this.light1.y += 9.5;
        this.light1.rotation = -.25;
        this.light2.x -= 1;
        this.light2.y += 1.5;
        this.light2.rotation = .3;
      } else {
        this.light1.rotation = 0;
        this.light2.rotation = 0;
        this.light1.draw();
        this.light2.draw();
        ctx.restore()
        this.lifetime = 0;
        return
      }

      this.elapsed++;

      this.light1.draw();
      this.light2.draw();
      ctx.restore()
    }
  };

  function slash2(color1, color2) {
    this.elapsed = 0;
    this.light1 = new lightsaber(80, 140, color1, 0);
    this.light2 = new lightsaber(200, 140, color2, 0);
    this.lifetime = 10;
    this.count = 0;
    this.draw = function () {
      ctx.save()
      ctx.transform(scaleX / 50, 0, 0, scaleY / 50, -160 + (posX * 320 / 100) + (50 - scaleX) * 3.1, -100 + (posY * 200 / 100) + (50 - scaleY) * 2.4);

      if (this.elapsed < 20) {
        this.light1.x -= 3;
        this.light1.rotation = .2;
        this.light2.x += 2;
        this.light2.y -= 5;
        this.light2.rotation = .1;
      } else if (this.elapsed < 25) {
        if (this.count == 0) {
          setTimeout(() => {flashEffects.push(new contact(this.x, this.y)) }, 100)
          this.count++
        }
        this.light1.y -= 10;
        this.light1.x += 10
        this.light1.rotation = 0;
        this.light2.x -= 10
        this.light2.y += 10;
        this.light2.rotation = 0;
      } else if (this.elapsed < 40) {
        this.light1.y -= 1;
        this.light1.x += 1
        this.light1.rotation = -.8;
        this.light2.x -= 1
        this.light2.y += 1
        this.light2.rotation = -.8;
      } else if (this.elapsed < 50) {
        if (this.count == 1) {
          setTimeout(() => {flashEffects.push(new contact(this.x, this.y)) }, 100)
          this.count++
        }
        this.light1.y += 1;
        this.light1.x -= 1
        this.light1.rotation = .4;
        this.light2.x += 1
        this.light2.y -= 1
        this.light2.rotation = .4;
      } else if (this.elapsed < 75) {
        this.light1.rotation = .2;
        this.light1.y += 2
        this.light2.rotation = -.03;
        this.light2.y += 2
      } else {
        this.light1.rotation = 0;
        this.light2.rotation = 0;
        this.light1.draw();
        this.light2.draw();
        ctx.restore()
        this.lifetime = 0;
        return
      }

      this.elapsed++;

      this.light1.draw();
      this.light2.draw();
      ctx.restore()
    }
  };

  function feint1(color1, color2) {
    this.elapsed = 0;
    this.light1 = new lightsaber(80, 140, color1, 0);
    this.light2 = new lightsaber(200, 140, color2, 0);
    this.lifetime = 10;
    this.count = 0;
    this.draw = function () {
      ctx.save()
      ctx.transform(scaleX / 50, 0, 0, scaleY / 50, -160 + (posX * 320 / 100) + (50 - scaleX) * 3.1, -100 + (posY * 200 / 100) + (50 - scaleY) * 2.4);

      if (this.elapsed < 15) {
        this.light1.x -= 1;
        this.light1.y -= 5;
        this.light1.rotation = -.09;
        this.light2.x += 1;
        this.light2.y -= 5;
        this.light2.rotation = .09;
      } else if (this.elapsed < 25) {
        this.light1.y += 5;
        this.light1.rotation = .85;
        this.light2.y += 5;
        this.light2.rotation = -.85;
      } else {
        this.light1.rotation = 0;
        this.light2.rotation = 0;
        this.light1.draw();
        this.light2.draw();
        ctx.restore()
        this.lifetime = 0;
        return
      }

      this.elapsed++;

      this.light1.draw();
      this.light2.draw();
      ctx.restore()
    }
  };

  function stab1(color1, color2) {
    this.elapsed = 0;
    this.light1 = new lightsaber(80, 140, color1, 0);
    this.light2 = new lightsaber(200, 140, color2, 0);
    this.lifetime = 10;
    this.count = 0;
    this.draw = function () {
      ctx.save()
      ctx.transform(scaleX / 50, 0, 0, scaleY / 50, -160 + (posX * 320 / 100) + (50 - scaleX) * 3.1, -100 + (posY * 200 / 100) + (50 - scaleY) * 2.4);

      if (this.elapsed < 20) {
        this.light1.x -= 4;
        this.light1.y -= 3;
        this.light1.rotation = .431;
        this.light2.x += 3;
        this.light2.rotation = -.04;
      } else if (this.elapsed < 35) {
        this.light1.y += .5
        this.light1.x -= 2
        this.light1.rotation = 0;
        this.light2.y -= 1
        this.light2.rotation = 0;
      } else if (this.elapsed < 40) {
        this.light1.x += 40
        this.light1.rotation = -.1;
        this.light2.x -= 5
        this.light2.rotation = .15;
      } else if (this.elapsed < 50) {
        if(this.count == 0){
          flashEffects.push(new contact())
          this.count++;
        }
        this.light1.rotation = 0;
        this.light2.rotation = 0;
      } else if (this.elapsed < 60) {
        if(this.count == 1){
          setTimeout(()=>{flashEffects.push(new contact())}, 100)
          this.count++;
        }
        this.light1.rotation = .08;
        this.light1.x -= 20
        this.light2.x -= 4
        this.light2.y += 3
        this.light2.rotation = -.3;
      } else if (this.elapsed < 65) {
        this.light1.rotation = 0;
        this.light2.rotation = 0;
      } else if (this.elapsed < 75) {
        this.light1.rotation = -.3;
        this.light1.x += 10
        this.light1.y += 8
        this.light2.rotation = .4;
      } else {
        this.light1.rotation = 0;
        this.light2.rotation = 0;
        this.light1.draw();
        this.light2.draw();
        ctx.restore()
        this.lifetime = 0;
        return
      }

      this.elapsed++;

      this.light1.draw();
      this.light2.draw();
      ctx.restore()
    }
  };

  function stab2(color1, color2) {
    this.elapsed = 0;
    this.light1 = new lightsaber(80, 140, color1, 0);
    this.light2 = new lightsaber(200, 140, color2, 0);
    this.lifetime = 10;
    this.count = 0;
    this.draw = function () {
      ctx.save()
      ctx.transform(scaleX / 50, 0, 0, scaleY / 50, -160 + (posX * 320 / 100) + (50 - scaleX) * 3.1, -100 + (posY * 200 / 100) + (50 - scaleY) * 2.4);

      if (this.elapsed < 15) {
        this.light1.x -= 2;
        this.light1.y -= 5;
        this.light1.rotation = -.1;
        this.light2.x -= 2;
        this.light2.rotation = -.04;
      } else if (this.elapsed < 25) {
        if(this.count == 0){
          setTimeout(()=>{flashEffects.push(new contact())}, 100)
          this.count++;
        }
        this.light1.x += 2;
        this.light1.y += 5;
        this.light1.rotation = .45;
        this.light2.x += 10;
        this.light2.y -= 5;
        this.light2.rotation = -.15;
      } else if (this.elapsed < 35) {
        this.light1.x -= 1;
        this.light1.y -= 1;
        this.light1.rotation = 0;
        this.light2.x += 1;
        this.light2.y -= 1;
        this.light2.rotation = 0;
      } else if (this.elapsed < 42.5) {
        if(this.count == 1){
          setTimeout(()=>{flashEffects.push(new contact())}, 100)
          this.count++;
        }
        this.light1.x += 5;
        this.light1.rotation = -.45;
        this.light2.x -= 20;
        this.light2.rotation = .09;
      } else if (this.elapsed < 55) {
        this.light1.x -= 2;
        this.light1.rotation = .1;
        this.light2.x += 15;
        this.light2.rotation = 0;
      } else if (this.elapsed < 62.5) {
        this.light1.x -= 3;
        this.light1.y += 9;
        this.light1.rotation = -.3;
        this.light2.x -= 25;
        this.light2.rotation = -.1;
      } else if (this.elapsed < 67.5) {
        this.light1.x += 1;
        this.light1.y -= 3;
        this.light1.rotation = 0;
        this.light2.x += 10;
        this.light2.rotation = 0;
      } else if (this.elapsed < 75) {
        this.light1.x += 4;
        this.light1.y -= 6;
        this.light1.rotation = .32;
        this.light2.x += 9;
        this.light2.y += 8;
        this.light2.rotation = .365;
      } else {
        this.light1.rotation = 0;
        this.light2.rotation = 0;
        this.light1.draw();
        this.light2.draw();
        ctx.restore()
        this.lifetime = 0;
        return
      }

      this.elapsed++;

      this.light1.draw();
      this.light2.draw();
      ctx.restore()
    }
  };

  function lightsaber(x, y, color, rotation) {
    this.x = x;
    this.y = y;
    this.color = color;
    this.rotation = rotation;
    this.rotate = 0;
    this.draw = function () {
      ctx.save();
      ctx.translate(this.x + 20, this.y);
      ctx.rotate(this.rotate);
      ctx.translate(-this.x - 20, -this.y);
      ctx.globalAlpha = Math.abs(Math.sin(Date.now() / 10))
      if (swordStyle) {
        DrawRect(this.x, this.y, 40, -110, this.color);
        DrawCircle(this.x + 20, this.y - 110, 20, this.color)
      }

      ctx.globalAlpha = 1;
      DrawRect(this.x + 12.5, this.y, 15, -100, swordStyle ? "white" : `${this.color}`);
      DrawCircle(this.x + 20.5, this.y - 100, 7.5, swordStyle ? "white" : `${this.color}`)
      ctx.restore();
      this.rotate += this.rotation;
    }
  };

  function contact() {
    this.lifetime = 10;
    this.alpha = .2;
    this.color1 = hexToRgb(saber1)
    this.color2 = hexToRgb(saber2)
    this.r = (this.color1.r + this.color2.r) / 2;
    this.g = (this.color1.g + this.color2.g) / 2;
    this.b = (this.color1.b + this.color2.b) / 2;
    this.draw = function () {
      ctx.globalAlpha = this.alpha;
      if (hitFlash) {
        DrawRect(0, 0, 320, 200, `white`)
        DrawRect(0, 0, 320, 200, `rgb(${this.r}, ${this.g}, ${this.b})`)
      }
      ctx.globalAlpha = 1;
      this.alpha > 0 ? this.alpha -= .04 : this.lifetime = 0;
    }
  }

  function DrawPath(x, y, path, color) {
    ctx.fillStyle = color;
    ctx.save();
    ctx.translate(x, y);
    let ex = new Path2D(path);
    ctx.fill(ex);
    ctx.restore();
  };

  function DrawCircle(x, y, radius, color) {
    ctx.beginPath();
    ctx.fillStyle = color;
    ctx.arc(x, y, radius, 0, 2 * Math.PI)
    ctx.fill();
  };

  function DrawStroke(x, y, radius, color, stroke) {
    ctx.beginPath();
    ctx.strokeStyle = color;
    ctx.lineWidth = stroke;
    ctx.arc(x, y, radius, 0, 2 * Math.PI)
    ctx.stroke();
  };

  function DrawRect(x, y, width, height, color) {
    ctx.beginPath();
    ctx.fillStyle = color;
    ctx.fillRect(x, y, width, height);
  };

  function DrawHex(x, y, color, size) {
    ctx.beginPath();
    for (var i = 0; i < 7; i++) {
      ctx.lineTo(x + size * Math.cos(2 * Math.PI / 6 * i), y + size * 0.9 * Math.sin(2 * Math.PI / 6 * i));
    }
    ctx.fillStyle = color;
    ctx.fill();
    ctx.strokeStyle = "black"
    ctx.stroke()
  };

  function hexToRgb(hex) {
    var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
      r: parseInt(result[1], 16),
      g: parseInt(result[2], 16),
      b: parseInt(result[3], 16)
    } : null;
  }

  window.requestAnimationFrame(update);
</script>