<head>
  <title>Destiny 2 Production</title>
  <meta description="Go on an adventure with metering and ambiance effects" />
  <meta publisher="SignalRGB" />

  <meta property="keyScreenBrightness" label="Ambience brightness" type="number" min="0" max="100" default="100" />
  <meta property="gameMode" label="Game mode" type="combobox" values="Campaign/Vanguard,Crucible,Gambit"
    default="Campaign/Vanguard" />
  <meta property="grenadeOn" label="Grenade Effect" type="boolean" default="1" />
  <meta property="meleeOn" label="Melee Effect" type="boolean" default="1" />
  <meta property="classOn" label="Class Effect" type="boolean" default="1" />
  <meta property="ultimateOn" label="Ultimate Effect" type="boolean" default="1" />
  <meta property="ammoOn" label="Ammo Change Effect" type="boolean" default="1" />
  <meta property="deathOn" label="Death Effect" type="boolean" default="1" />
  <meta property="resultOn" label="Crucible Win/Loss" type="boolean" default="1" />

  <meta meter="inGame" tags="Destiny 2" type="area" x="0.2021" y="0.8981" width="0.0085" height=".001" h="0-360"
    s="0-30" l="70-100">
  <resolution size="3440x1440" x="0.1887" y="0.9007" width="0.0085" height=".001" />
  <resolution size="1920x1200" x="0.2417" y="0.8546" width="0.0085" height=".001" />
  <resolution size="1680x1050" x="0.2417" y="0.8546" width="0.0085" height=".001" />
  <resolution size="1440x900" x="0.2417" y="0.8546" width="0.0085" height=".001" />
  </meta>
  <meta meter="ab1Orange" tags="Destiny 2" type="area" x="0.0667968" y="0.869444" width="0.002" height=".04" h="0-30"
    s="60-90" l="65-100">
  <resolution size="3440x1440" x="0.0497" y="0.8701" width="0.002" height=".04" />
  <resolution size="1920x1200" x="0.0667" y="0.8296" width="0.002" height=".04" />
  <resolution size="1680x1050" x="0.0667" y="0.8296" width="0.002" height=".04" />
  <resolution size="1440x900" x="0.0667" y="0.8296" width="0.002" height=".04" />
  </meta>
  <meta meter="ab2Orange" tags="Destiny 2" type="area" x="0.10117" y="0.869444" width="0.002" height=".04" h="0-30"
    s="60-90" l="65-100">
  <resolution size="3440x1440" x="0.075" y="0.8674" width="0.002" height=".04" />
  <resolution size="1920x1200" x="0.101" y="0.8259" width="0.002" height=".04" />
  <resolution size="1680x1050" x="0.101" y="0.8259" width="0.002" height=".04" />
  <resolution size="1440x900" x="0.101" y="0.8259" width="0.002" height=".04" />
  </meta>
  <meta meter="ab3Orange" tags="Destiny 2" type="area" x="0.136328" y="0.8645" width="0.002" height=".04" h="0-30"
    s="60-90" l="65-100">
  <resolution size="3440x1440" x="0.1003" y="0.8632" width="0.002" height=".04" />
  <resolution size="1920x1200" x="0.1354" y="0.8231" width="0.002" height=".04" />
  <resolution size="1680x1050" x="0.1354" y="0.8231" width="0.002" height=".04" />
  <resolution size="1440x900" x="0.1354" y="0.8231" width="0.002" height=".04" />
  </meta>
  <meta meter="ab1Purple" tags="Destiny 2" type="area" x="0.0667968" y="0.869444" width="0.002" height=".04" h="250-360"
    s="15-55" l="25-65">
  <resolution size="3440x1440" x="0.0497" y="0.8701" width="0.002" height=".04" />
  <resolution size="1920x1200" x="0.0667" y="0.8296" width="0.002" height=".04" />
  <resolution size="1680x1050" x="0.0667" y="0.8296" width="0.002" height=".04" />
  <resolution size="1440x900" x="0.0667" y="0.8296" width="0.002" height=".04" />
  </meta>
  <meta meter="ab2Purple" tags="Destiny 2" type="area" x="0.10117" y="0.869444" width="0.002" height=".04" h="250-360"
    s="15-55" l="25-65">
  <resolution size="3440x1440" x="0.075" y="0.8674" width="0.002" height=".04" />
  <resolution size="1920x1200" x="0.101" y="0.8259" width="0.002" height=".04" />
  <resolution size="1680x1050" x="0.101" y="0.8259" width="0.002" height=".04" />
  <resolution size="1440x900" x="0.101" y="0.8259" width="0.002" height=".04" />
  </meta>
  <meta meter="ab3Purple" tags="Destiny 2" type="area" x="0.136328" y="0.8645" width="0.002" height=".04" h="250-360"
    s="15-55" l="25-65">
  <resolution size="3440x1440" x="0.1003" y="0.8632" width="0.002" height=".04" />
  <resolution size="1920x1200" x="0.1354" y="0.8231" width="0.002" height=".04" />
  <resolution size="1680x1050" x="0.1354" y="0.8231" width="0.002" height=".04" />
  <resolution size="1440x900" x="0.1354" y="0.8231" width="0.002" height=".04" />
  </meta>
  <meta meter="ab1Blue" tags="Destiny 2" type="area" x="0.0667968" y="0.869444" width="0.002" height=".04" h="145-195"
    s="25-60" l="50-90">
  <resolution size="3440x1440" x="0.0497" y="0.8701" width="0.002" height=".04" />
  <resolution size="1920x1200" x="0.0667" y="0.8296" width="0.002" height=".04" />
  <resolution size="1680x1050" x="0.0667" y="0.8296" width="0.002" height=".04" />
  <resolution size="1440x900" x="0.0667" y="0.8296" width="0.002" height=".04" />
  </meta>
  <meta meter="ab2Blue" tags="Destiny 2" type="area" x="0.10117" y="0.869444" width="0.002" height=".04" h="145-195"
    s="25-60" l="50-90">
  <resolution size="3440x1440" x="0.075" y="0.8674" width="0.002" height=".04" />
  <resolution size="1920x1200" x="0.101" y="0.8259" width="0.002" height=".04" />
  <resolution size="1680x1050" x="0.101" y="0.8259" width="0.002" height=".04" />
  <resolution size="1440x900" x="0.101" y="0.8259" width="0.002" height=".04" />
  </meta>
  <meta meter="ab3Blue" tags="Destiny 2" type="area" x="0.136328" y="0.8645" width="0.002" height=".04" h="145-195"
    s="25-60" l="50-90">
  <resolution size="3440x1440" x="0.1003" y="0.8632" width="0.002" height=".04" />
  <resolution size="1920x1200" x="0.1354" y="0.8231" width="0.002" height=".04" />
  <resolution size="1680x1050" x="0.1354" y="0.8231" width="0.002" height=".04" />
  <resolution size="1440x900" x="0.1354" y="0.8231" width="0.002" height=".04" />
  </meta>
  <meta meter="ab1White" tags="Destiny 2" type="area" x="0.070703" y="0.87569" width="0.01875" height=".0277777"
    h="0-360" s="0-25" l="75-100">
  <resolution size="3440x1440" x="0.0561" y="0.884" width="0.009" height=".0271" />
  <resolution size="1920x1200" x="0.755" y="0.8398" width="0.01875" height=".0277777" />
  <resolution size="1680x1050" x="0.755" y="0.8398" width="0.01875" height=".0277777" />
  <resolution size="1440x900" x="0.755" y="0.8398" width="0.01875" height=".0277777" />
  </meta>
  <meta meter="ab2White" tags="Destiny 2" type="area" x="0.10759" y="0.8701" width="0.016906" height=".0277777"
    h="0-360" s="0-25" l="75-100">
  <resolution size="3440x1440" x="0.0826" y="0.8792" width="0.009" height=".0271" />
  <resolution size="1920x1200" x="0.1115" y="0.837" width="0.01875" height=".0277777" />
  <resolution size="1680x1050" x="0.1115" y="0.837" width="0.01875" height=".0277777" />
  <resolution size="1440x900" x="0.1115" y="0.837" width="0.01875" height=".0277777" />
  </meta>
  <meta meter="ab3White" tags="Destiny 2" type="area" x="0.1402" y="0.87597" width="0.01875" height=".027777" h="0-360" 
  s="0-25" l="75-100">
  <resolution size="3440x1440" x="0.107" y="0.8778" width="0.009" height=".0271" />
  <resolution size="1920x1200" x="0.1432" y="0.8343" width="0.01875" height=".0277777" />
  <resolution size="1680x1050" x="0.1432" y="0.8343" width="0.01875" height=".0277777" />
  <resolution size="1440x900" x="0.1432" y="0.8343" width="0.01875" height=".0277777" />
  </meta>
  <meta meter="ultIcon" tags="Destiny 2" type="area" x="0.0363281" y="0.82569" width="0.004" height=".001" h="20-90"
    s="30-80" l="60-100">
  <resolution size="3440x1440" x="0.0448" y="0.8521" width="0.004" height=".001" />
  <resolution size="1920x1200" x="0.583" y="0.813" width="0.004" height=".001" />
  <resolution size="1680x1050" x="0.583" y="0.813" width="0.004" height=".001" />
  <resolution size="1440x900" x="0.583" y="0.813" width="0.004" height=".001" />
  </meta>
  <meta meter="ultWhite" tags="Destiny 2" type="area" x="0.0364" y="0.8472" width="0.015" height=".015" h="0-360" 
  s="0-25" l="75-100">
  <resolution size="3440x1440" x="0.027" y="0.8479" width="0.015" height=".015" />
  <resolution size="1920x1200" x="0.0354" y="0.8102" width="0.015" height=".015" />
  <resolution size="1680x1050" x="0.0354" y="0.8102" width="0.015" height=".015" />
  <resolution size="1440x900" x="0.0354" y="0.8102" width="0.015" height=".015" />
  </meta>
  <meta meter="ultFirstBar" tags="Destiny 2" type="area" x="0.297656" y="0.83402" width="0.003" height=".001" h="20-90"
    s="30-80" l="60-100">
  <resolution size="3440x1440" x="0.2221" y="0.8354" width="0.003" height=".001" />
  <resolution size="1920x1200" x="0.2979" y="0.7954" width="0.003" height=".001" />
  <resolution size="1680x1050" x="0.2979" y="0.7954" width="0.003" height=".001" />
  <resolution size="1440x900" x="0.2979" y="0.7954" width="0.003" height=".001" />
  </meta>
  <meta meter="ammoColorWhite" tags="Destiny 2" type="area" x="0.3015" y="0.8417" width="0.0005" height=".02" h="0-360"
    s="0-30" l="80-100">
  <resolution size="3440x1440" x="0.2249" y="0.8507" width="0.0005" height=".02" />
  <resolution size="1920x1200" x="0.301" y="0.8074" width="0.0005" height=".02" />
  <resolution size="1680x1050" x="0.301" y="0.8074" width="0.0005" height=".02" />
  <resolution size="1440x900" x="0.301" y="0.8074" width="0.0005" height=".02" />
  </meta>
  <meta meter="ammoColorPurple" tags="Destiny 2" type="area" x="0.3015" y="0.8417" width="0.0005" height=".02"
    h="250-280" s="25-50" l="75-100">
  <resolution size="3440x1440" x="0.2249" y="0.8507" width="0.0005" height=".02" />
  <resolution size="1920x1200" x="0.301" y="0.8074" width="0.0005" height=".02" />
  <resolution size="1680x1050" x="0.301" y="0.8074" width="0.0005" height=".02" />
  <resolution size="1440x900" x="0.301" y="0.8074" width="0.0005" height=".02" />
  </meta>
  <meta meter="ammoColorGreen" tags="Destiny 2" type="area" x="0.3015" y="0.8417" width="0.0005" height=".02"
    h="110-160" s="15-60" l="65-100">
  <resolution size="3440x1440" x="0.2249" y="0.8507" width="0.0005" height=".02" />
  <resolution size="1920x1200" x="0.301" y="0.8074" width="0.0005" height=".02" />
  <resolution size="1680x1050" x="0.301" y="0.8074" width="0.0005" height=".02" />
  <resolution size="1440x900" x="0.301" y="0.8074" width="0.0005" height=".02" />
  </meta>
  <meta meter="downedGhostRed" tags="Destiny 2" type="area" x="0.039453" y="0.0986111" width="0.006" height=".001"
    h="0-30" s="30-100" l="50-100">
  <resolution size="3440x1440" x="0.027" y="0.0757" width="0.006" height=".001" />
  </meta>
  <meta meter="downedWhite" tags="Destiny 2" type="area" x="0.238" y="0.1685" width="0.001" height=".001" h="0-360"
    s="0-10" l="90-100">
  <resolution size="3440x1440" x="0.2192" y="0.0882" width="0.001" height=".001" />
  </meta>
  <meta meter="downedWhiteG" tags="Destiny 2" type="area" x="0.10664" y="0.07569" width="0.001" height=".001" h="0-40"
    s="0-50" l="0-50">
  <resolution size="3440x1440" x="0.0017" y="0.1188" width="0.001" height=".001" />
  </meta>
  <meta meter="crucDeathR" tags="Destiny 2" type="area" x="0.0332" y="0.2614" width="0.005" height=".002" h="0-25"
    s="50-75" l="40-60">
  <resolution size="3440x1440" x="0.0244" y="0.2598" width="0.005" height=".002" />
  <resolution size="1920x1200" x="0.0328" y="0.2861" width="0.005" height=".002" />
  <resolution size="1680x1050" x="0.0328" y="0.2861" width="0.005" height=".002" />
  <resolution size="1440x900" x="0.0328" y="0.2861" width="0.005" height=".002" />
  </meta>
  <meta meter="crucDeathW" tags="Destiny 2" type="area" x="0.0322125" y="0.28819" width="0.005" height=".001" h="0-360"
    s="0-20" l="80-100">
  <resolution size="3440x1440" x="0.0227" y="0.2674" width="0.005" height=".001" />
  <resolution size="1920x1200" x="0.0302" y="0.2926" width="0.005" height=".001" />
  <resolution size="1680x1050" x="0.0302" y="0.2926" width="0.005" height=".001" />
  <resolution size="1440x900" x="0.0302" y="0.2926" width="0.005" height=".001" />
  </meta>
  <meta meter="crucDefeatG" tags="Destiny 2" type="area" x="0.4958" y="0.537" width="0.01" height=".001" h="20-90"
    s="0-25" l="50-100">
  <resolution size="3440x1440" x="0.4971" y="0.5375" width="0.01" height=".001" />
  <resolution size="1920x1200" x="0.4958" y="0.5333" width="0.01" height=".001" />
  <resolution size="1680x1050" x="0.4958" y="0.5333" width="0.01" height=".001" />
  <resolution size="1440x900" x="0.4958" y="0.5333" width="0.01" height=".001" />
  </meta>
  <meta meter="crucDefeatB1" tags="Destiny 2" type="area" x="0.4969" y="0.4315" width="0.005" height=".001" h="0-360"
    s="0-100" l="0-15">
  <resolution size="3440x1440" x="0.4971" y="0.4319" width="0.005" height=".001" />
  <resolution size="1920x1200" x="0.4958" y="0.438" width="0.005" height=".001" />
  <resolution size="1680x1050" x="0.4958" y="0.438" width="0.005" height=".001" />
  <resolution size="1440x900" x="0.4958" y="0.438" width="0.005" height=".001" />
  </meta>
  <meta meter="crucDefeatB2" tags="Destiny 2" type="area" x="0.4969" y="0.6185" width="0.003" height=".001" h="0-360"
    s="0-100" l="0-15">
  <resolution size="3440x1440" x="0.4971" y="0.6181" width="0.003" height=".001" />
  <resolution size="1920x1200" x="0.4958" y="0.6046" width="0.003" height=".001" />
  <resolution size="1680x1050" x="0.4958" y="0.6046" width="0.003" height=".001" />
  <resolution size="1440x900" x="0.4958" y="0.6046" width="0.003" height=".001" />
  </meta>
  <meta meter="crucVictoryW" tags="Destiny 2" type="area" x="0.4859" y="0.5046" width="0.001" height=".001" h="0-360"
    s="0-25" l="90-100">
  <resolution size="3440x1440" x="0.4948" y="0.4611" width="0.001" height=".001" />
  </meta>
  <meta meter="crucVictoryR" tags="Destiny 2" type="area" x="0.4885" y="0.5481" width="0.001" height=".001" h="0-25"
    s="75-100" l="60-90">
  <resolution size="3440x1440" x="0.5023" y="0.5576" width="0.01" height=".001" />
  </meta>
  <meta meter="crucVictoryB" tags="Destiny 2" type="area" x="0.4885" y="0.613" width="0.001" height=".001" h="0-180"
    s="0-100" l="0-20">
  <resolution size="3440x1440" x="0.4915" y="0.6097" width="0.004" height=".001" />
  </meta>
</head>

<body style="margin: 0; padding: 0; background: #000;">
  <canvas id="exCanvas" width="320" height="200"></canvas>
</body>

<script>
  var canvas, ctx;
  canvas = document.getElementById('exCanvas');
  ctx = canvas.getContext('2d');
  var width = 320;
  var height = 200;
  var stateHdlr = new StateHandler();
  var effects = [];
  var ab1Activated = false;
  var ab2Activated = false;
  var ab3Activated = false;
  var ultCharged = false;
  var downedPushed = false;
  var ultInUse = false;
  var inGame = false;
  var skull = "M8.05,64.93S-10.76,9.44,56.44,2.51c0,0,65.88,4.29,48.05,62.42,0,0,4,9.58-.66,18.5,0,0,6.27,9.9,1.65,12.22l4.62,8.91s-8.25,20.81-16.51,11.56c0,0-6.28-21.68-12.55,2.37,0,0,4.62,18.11-6.61,29l-4.29-2.31-3,5.94-3.31-4.29-3.3,4.29-4.12-2-4.14,2L49,147.5l-3,3.63-3.63-5.28-4.3,2.64s-3.63-9.91-6.27-11.23-5.62-14.86-.66-18.49-7.27-18.5-14.53.66c0,0-7.93,1-13.88-15.53l5-7.92s-3.64-4.63,1-10.24C8.71,85.74.45,73.85,8.05,64.93Z";
  var damageType = "purple";
  var InGameMeter = new timedMeter(15, GameStateHandler);

  var Ability1OrangeMeter = new timedMeter(15, grenadeHandler);
  var Ability2OrangeMeter = new timedMeter(15, meleeHandler);
  var Ability3OrangeMeter = new timedMeter(15, zoneHandler);
  var Ability1PurpleMeter = new timedMeter(15, grenadeHandler);
  var Ability2PurpleMeter = new timedMeter(15, meleeHandler);
  var Ability3PurpleMeter = new timedMeter(15, zoneHandler);
  var Ability1BlueMeter = new timedMeter(15, grenadeHandler);
  var Ability2BlueMeter = new timedMeter(15, meleeHandler);
  var Ability3BlueMeter = new timedMeter(15, zoneHandler);
  var Ability1WhiteMeter = new Meter(17, () => "");
  var Ability2WhiteMeter = new Meter(17, () => "");
  var Ability3WhiteMeter = new Meter(17, () => "");

  var UltimateIconMeter = new Meter(10, ultimateHandler);
  var UltimateBarMeter = new Meter(10, ultimateHandler);
  var UltimateWhiteMeter = new Meter(10, ultimateHandler);

  var AmmoColorPurpleMeter = new Meter(10, ammoTypeHandler);
  var AmmoColorWhiteMeter = new Meter(10, ammoTypeHandler);
  var AmmoColorGreenMeter = new Meter(10, ammoTypeHandler);

  var DownedGhostRedMeter = new Meter(20, downedHandler);
  var DownedGhostWhiteMeter = new Meter(20, downedHandler)
  var DownedWhiteGMeter = new Meter(20, downedHandler);

  var CrucibleDeathRedMeter = new Meter(5, crucibleDeathHandler);
  var CrucibleDeathWhiteMeter = new Meter(5, crucibleDeathHandler);
  var CrucibleDefeatGreyMeter = new Meter(10, crucibleDefeatHandler);
  var CrucibleDefeatBlack1Meter = new Meter(10, crucibleDefeatHandler);
  var CrucibleDefeatBlack2Meter = new Meter(10, crucibleDefeatHandler);
  var CrucibleVictoryRedMeter = new Meter(10, crucibleVictoryHandler);
  var CrucibleVictoryWhiteMeter = new Meter(10, crucibleVictoryHandler);
  var CrucibleVictoryBlackMeter = new Meter(10, crucibleVictoryHandler);


  function update() {
    InGameMeter.setValue(engine.vision.inGame);

    if (grenadeOn) {
      Ability1OrangeMeter.setValue(engine.vision.ab1Orange);
      Ability1PurpleMeter.setValue(engine.vision.ab1Purple);
      Ability1BlueMeter.setValue(engine.vision.ab1Blue);
      Ability1WhiteMeter.setValue(engine.vision.ab1White);
    }
    if (meleeOn) {
      Ability2OrangeMeter.setValue(engine.vision.ab2Orange);
      Ability2PurpleMeter.setValue(engine.vision.ab2Purple);
      Ability2BlueMeter.setValue(engine.vision.ab2Blue);
      Ability2WhiteMeter.setValue(engine.vision.ab2White);
    }
    if (classOn) {
      Ability3OrangeMeter.setValue(engine.vision.ab3Orange);
      Ability3PurpleMeter.setValue(engine.vision.ab3Purple);
      Ability3BlueMeter.setValue(engine.vision.ab3Blue);
      Ability3WhiteMeter.setValue(engine.vision.ab3White);
    }
    if (ammoOn) {
      AmmoColorPurpleMeter.setValue(engine.vision.ammoColorPurple);
      AmmoColorWhiteMeter.setValue(engine.vision.ammoColorWhite);
      AmmoColorGreenMeter.setValue(engine.vision.ammoColorGreen);
    }
    if (ultimateOn) {
      UltimateIconMeter.setValue(engine.vision.ultIcon);
      UltimateBarMeter.setValue(engine.vision.ultFirstBar);
      UltimateWhiteMeter.setValue(engine.vision.ultWhite);
    }

    if (gameMode == "Campaign/Vanguard") {
      if (deathOn) {
        DownedGhostRedMeter.setValue(engine.vision.downedGhostRed);
        DownedGhostWhiteMeter.setValue(engine.vision.downedWhite);
        DownedWhiteGMeter.setValue(engine.vision.downedWhiteG)
      }
    } else if (gameMode == "Crucible") {
      if (deathOn) {
        CrucibleDeathRedMeter.setValue(engine.vision.crucDeathR);
        CrucibleDeathWhiteMeter.setValue(engine.vision.crucDeathW);
      }
      if (resultOn) {
        CrucibleDefeatGreyMeter.setValue(engine.vision.crucDefeatG);
        CrucibleDefeatBlack1Meter.setValue(engine.vision.crucDefeatB1);
        CrucibleDefeatBlack2Meter.setValue(engine.vision.crucDefeatB2);
        CrucibleVictoryRedMeter.setValue(engine.vision.crucVictoryR);
        CrucibleVictoryWhiteMeter.setValue(engine.vision.crucVictoryW);
        CrucibleVictoryBlackMeter.setValue(engine.vision.crucVictoryB);
      }
    } else if (gameMode == "Gambit") {
      if (deathOn) {
        CrucibleDeathRedMeter.setValue(engine.vision.crucDeathR);
        CrucibleDeathWhiteMeter.setValue(engine.vision.crucDeathW);
      }
    };

    if (keyScreenBrightness > 5) {
      copyScreen(1);
    }

    for (let i = 0; i < effects.length; i++) {
      effects[i].draw();
      if (effects[i].lifetime <= 0) {
        effects.splice(i, 1);
      }
    };

    stateHdlr.Process();
    window.requestAnimationFrame(update);
  };


  function GameStateHandler() {
    if (InGameMeter.value == 1) {
      ClearEffects();
      setTimeout(() => {
        if (InGameMeter.value == 1 && (AmmoColorGreenMeter.value == 1 || AmmoColorPurpleMeter.value == 1 || AmmoColorWhiteMeter.value == 1)) {
          inGame = true;
        }
      }, 400);
    } else {
      ClearEffects();
      AfterClearCheck();
      inGame = false;
    }
  }

  function damageSetter(m1, m2, m3){
    var orange = m1
    var purple = m2
    var blue = m3

    if(orange.diff > purple.diff && orange.diff > blue.diff){
      damageType = "orange"
    } else if (purple.diff > orange.diff && purple.diff > blue.diff){
      damageType = "purple"
    } else if (blue.diff > orange.diff && blue.diff > purple.diff){
      damageType = "blue"
    } else if (orange.diff == purple.diff && orange.diff == 1){
      orange.elapsed < purple.elapsed ? damageType = "orange" : damageType = "purple";
    } else if (purple.diff == blue.diff && purple.diff == 1){
      purple.elapsed < blue.elapsed ? damageType = "purple" : damageType = "blue";
    } else if (blue.diff == orange.diff && blue.diff == 1){
      blue.elapsed < orange.elapsed ? damageType = "blue" : damageType = "orange";
    }
  }

  function ClearEffects() {
    effects.length = 0;
    downedPushed = false;
    ultInUse = false;

  }

  function AfterClearCheck() {
    downedHandler();
  }


  function grenadeHandler() {
    damageSetter(Ability1OrangeMeter, Ability1PurpleMeter, Ability1BlueMeter)
    if (inGame) {
      if (Ability1WhiteMeter.value > .15 && !ab1Activated) {
        ab1Activated = true;
        if (Ability1OrangeMeter.decreased && Ability1OrangeMeter.diff > .8) {
          effects.push(new grenade(damageType));
        }
        if (Ability1BlueMeter.decreased && Ability1BlueMeter.diff > .8) {
          effects.push(new grenade(damageType));
        }
        if (Ability1PurpleMeter.decreased && Ability1PurpleMeter.diff > .8) {
          effects.push(new grenade(damageType));
        }
        setTimeout(() => { ab1Activated = false }, 1000)
      }
    }
  }

  function meleeHandler() {
    damageSetter(Ability2OrangeMeter, Ability2PurpleMeter, Ability2BlueMeter)
    if (inGame) {
      if (Ability2WhiteMeter.value > .1 && !ab2Activated) {
        ab2Activated = true;
        if (Ability2OrangeMeter.decreased && Ability2OrangeMeter.diff > .8) {
          effects.push(new punch(damageType));
        }
        if (Ability2BlueMeter.decreased && Ability2BlueMeter.diff > .8) {
          effects.push(new punch(damageType));
        }
        if (Ability2PurpleMeter.decreased && Ability2PurpleMeter.diff > .8) {
          effects.push(new punch(damageType));
        }
        setTimeout(() => { ab2Activated = false }, 1000)
      }
    }
  }

  function zoneHandler() {
    damageSetter(Ability3OrangeMeter, Ability3PurpleMeter, Ability3BlueMeter)
    if (inGame) {
      if (Ability3WhiteMeter.value > .15 && !ab3Activated) {
        ab3Activated = true;
        if (Ability3OrangeMeter.decreased && Ability3OrangeMeter.diff > .8 && damageType == "orange") {
          effects.push(new classParticleHandler(flameParticle))
        }
        if (Ability3BlueMeter.decreased && Ability3BlueMeter.diff > .8 && damageType == "blue") {
          effects.push(new classParticleHandler(arcParticle))
        }
        if (Ability3PurpleMeter.decreased && Ability3PurpleMeter.diff > .8 && damageType == "purple") {
          effects.push(new classParticleHandler(voidParticle))
        }
        setTimeout(() => { ab3Activated = false }, 1000)
      }
    }
  }

  function ultimateHandler() {
    if (inGame) {
      if (UltimateIconMeter.value == 1 && UltimateBarMeter.value == 1 && UltimateWhiteMeter.value > .15 && !ultCharged) {
        effects.push(new ultimateCharged())
        ultCharged = true;
      }
      if (UltimateIconMeter.value == 1 && UltimateBarMeter.decreased && UltimateBarMeter.diff > .4 && UltimateWhiteMeter.value > .15 && ultCharged) {
        effects.push(new ultimateInUse(175))
        var ultInUse = true;
      }
      if (UltimateIconMeter.value == 0 && UltimateBarMeter.value == 0 && ultCharged) {
        effects.push(new ultimateDone())
        ultCharged = false;
      }
    }
  }

  function ammoTypeHandler() {
    if (inGame) {
      if (AmmoColorGreenMeter.value == 1 && AmmoColorGreenMeter.diff > .8 && !ultInUse) {
        effects.push(new ammoType("green"))
      }
      if (AmmoColorPurpleMeter.value == 1 && AmmoColorPurpleMeter.diff > .8 && !ultInUse) {
        effects.push(new ammoType("purple"))
      }
      if (AmmoColorWhiteMeter.value == 1 && AmmoColorWhiteMeter.diff > .8 && !ultInUse) {
        effects.push(new ammoType("white"))
      }
    }
  }

  function downedHandler() {
    if (DownedGhostRedMeter.value == 1 && DownedGhostWhiteMeter.value == 1 && DownedGhostRedMeter.increased && DownedWhiteGMeter.value == 1 && !downedPushed) {
      effects.push(new downed())
      downedPushed = true;
    }
  }

  function crucibleDeathHandler() {
    if (CrucibleDeathRedMeter.value > .7
      && CrucibleDeathWhiteMeter.value > .3
      && CrucibleDeathRedMeter.diff > .5
      && CrucibleDeathWhiteMeter.increased
      && !downedPushed) {
      effects.push(new downed())
      downedPushed = true;
    }
  }

  function crucibleVictoryHandler() {
    if (CrucibleVictoryBlackMeter.value == 1 && CrucibleVictoryRedMeter.value == 1 && CrucibleVictoryWhiteMeter.value == 1) {
      effects.push(new crucibleVictory())
    }
  }

  function crucibleDefeatHandler() {
    if (CrucibleDefeatBlack1Meter.value > .8 && CrucibleDefeatBlack2Meter.value > .8 && CrucibleDefeatGreyMeter.value > .8) {
      effects.push(new crucibleDefeat())
    }
  }

  function crucibleDefeat() {
    this.lifetime = 10;
    this.lightness1 = 100;
    this.lightness2 = 100;
    this.lightness3 = 100;
    this.alpha = 1;

    this.draw = function () {
      var grd = ctx.createLinearGradient(160, 0, 160, 200);
      grd.addColorStop(0, `hsl(0, 100%, ${this.lightness1}%)`);
      grd.addColorStop(.5, `hsl(0, 100%, ${this.lightness2}%)`);
      grd.addColorStop(1, `hsl(0, 100%, ${this.lightness3}%)`);
      this.lightness1 > 50 ? this.lightness1-- : this.lightness2 > 50 ? this.lightness2-- : this.lightness3 > 50 ? this.lightness3-- : null;
      this.lightness3 <= 50 ? this.alpha -= .01 : null;
      ctx.globalAlpha = this.alpha
      ctx.fillStyle = grd;
      ctx.fillRect(0, 0, 320, 200);
      renderPath(105, 15, skull, "white");
      DrawCircle(140, 90, 15, `hsl(0, 100%, ${this.lightness2}%)`)
      DrawCircle(180, 90, 15, `hsl(0, 100%, ${this.lightness2}%)`)
      ctx.globalAlpha = 1;
      this.alpha <= 0 ? this.lifetime = 0 : null;
    }
  }

  function crucibleVictory() {
    this.start = Date.now();
    this.lifetime = 10;
    this.effects = []
    this.hues = ["black", `hsl(0, 100%, 25%)`, "red", "white"]
    this.done = false;
    this.draw = function () {
      var elapsed = Date.now() - this.start;
      if (!this.done) {
        for (let i = 0; i < 4; i++) {
          setTimeout(() => { this.effects.push(new crucibleV(160, 150 - i * 25, 5, this.hues[i])) }, i * 200)
        }
        this.done = true;
      }
      if (elapsed < 2000) {
        this.effects.forEach((ele, i) => {
          ele.draw();
          if (ele.lifetime <= 0) {
            this.effects.splice(i, 1);
          }
        });
      } else {
        for (let i = 0; i < 40; i++) {
          effects.push(new downedParticle("red"))
          setTimeout(() => { effects.push(new downedParticle("white")) }, 300)
        }
        this.lifetime = 0;
      }
    }
  }

  function crucibleV(x, y, speed, color) {
    this.lifetime = 10;
    this.x = x;
    this.y = y - 200;
    this.goal = y;
    this.vy = speed;
    this.color = color;
    this.draw = function () {
      ctx.beginPath();
      ctx.moveTo(this.x - 100, this.y - 30)
      ctx.lineTo(this.x, this.y)
      ctx.lineTo(this.x + 100, this.y - 30)
      ctx.strokeStyle = this.color;
      ctx.lineWidth = 25;
      ctx.stroke()
      this.y < this.goal ? this.y += this.vy : null;
    }
  }

  function downed() {
    this.lifetime = 10;
    this.radius = 1;
    this.change = .001
    this.effects = [];

    this.draw = function () {
      drawRect(0, 0, 320, 200, "black");
      this.effects.forEach((ele, i) => {
        ele.draw();
        if (ele.lifetime <= 0) {
          this.effects.splice(i, 1);
        }
      });
      DrawCircle(160, 100, this.radius, "grey")
      ctx.globalAlpha = 1;
      this.radius += this.change;
      this.change += .01
      this.effects.push(new downedParticle("red"))
      if (this.radius >= 200) {
        this.lifetime = 0;
        downedPushed = false;
      }
    }
  }

  function downedParticle(color) {
    this.x = 160;
    this.y = 100;
    this.vx = (2 - Math.random() * 4) * 2;
    this.vy = (2 - Math.random() * 4) * 2;
    this.radius = 10 * Math.random() + 10;
    this.color = color;
    this.draw = function () {
      DrawCircle(this.x, this.y, this.radius, this.color);
      this.x += this.vx;
      this.y += this.vy;
    }
  }

  function ultimateDone() {
    this.start = Date.now();
    this.lifetime = 10;
    this.lightness1 = 50;
    this.lightness2 = 50;
    this.lightness3 = 50;
    this.alpha = 1;
    this.clear = true;

    this.draw = function () {
      var elapsed = Date.now() - this.start;
      var grd = ctx.createRadialGradient(160, 100, 100, 160, 100, 400);
      grd.addColorStop(0, `hsl(0, 100%, ${this.lightness1}%)`);
      grd.addColorStop(.5, `hsl(0, 100%, ${this.lightness2}%)`);
      grd.addColorStop(1, `hsl(0, 100%, ${this.lightness3}%)`);
      this.lightness1 > 0 ? this.lightness1-- : this.lightness2 > 0 ? this.lightness2-- : this.lightness3 > 0 ? this.lightness3-- : null;
      this.lightness3 <= 0 ? this.alpha -= .05 : null;
      ctx.globalAlpha = this.alpha
      ctx.fillStyle = grd;
      ctx.fillRect(0, 0, 320, 200);
      ctx.globalAlpha = 1;
      this.alpha <= 0 ? this.lifetime = 0 : null;
    }
  }

  function ultimateInUse(speed) {
    this.start = Date.now();
    this.lifetime = 10;
    this.speed = speed;
    this.hue = 60;
    this.draw = function () {
      var elapsed = Date.now() - this.start;
      if (elapsed > this.speed) {
        effects.push(new ultRect(45, 12, `hsl(${this.hue}, 100%, 50%)`));
        this.hue > 0 ? this.hue-- : null;
        this.start = Date.now()
      }
      if (UltimateIconMeter.value == 0) {
        this.lifetime = 0;
        var ultInUse = false;
      }
    }
  }

  function ultRect(height, speed, color) {
    this.lifetime = 10;
    this.y = 200;
    this.height = height;
    this.speed = speed;
    this.color = color;
    this.draw = function () {
      ctx.beginPath();
      ctx.fillStyle = this.color;
      ctx.fillRect(0, this.y, 320, this.height);
      this.y -= this.speed;
      if (this.y < -30) {
        this.lifetime = 0;
      }
    }
  }

  function ultimateCharged() {
    this.start = Date.now();
    this.radius = 5;
    this.count = 0;
    this.clear = true;
    this.x = 0;
    this.width = 160;
    this.lifetime = 10;
    this.draw = function () {
      var elapsed = Date.now() - this.start;
      if (elapsed < 200) {
        DrawCircle(160, 100, this.radius, "yellow");
      } else if (this.radius < 75) {
        DrawCircle(160, 100, this.radius, "yellow");
        this.radius += 5;
      } else if (this.x < 400) {
        DrawCircle(160, 100, this.radius, "yellow")
        drawRect(160 - this.x, 25, this.x, 150, "yellow");
        drawRect(160, 25, this.x, 150, "yellow");
        this.x += 15;
      } else if (this.width > 0) {
        drawRect(0, 25, this.width, 150, "yellow");
        drawRect(320 - this.width, 25, this.width, 150, "yellow");
        this.width -= 15;
      } else {
        this.lifetime = 0;
      }
    }
  }

  function ammoType(color) {
    this.start = 0;
    this.clear = true;
    this.elapsed = 0;
    this.color = color;
    this.lifetime = 10;
    this.y = 300;
    this.draw = function () {
      var xVar = Math.cos(Date.now() / 100) * 20
      drawRect(0, this.y, 320, 300, "black");
      for (let i = 0; i < 4; i++) {
        drawRect(60 + xVar + i * 50, this.y * 3 / 2 + 75, 30, 50, this.color);
      }
      if (this.y > 0) {
        this.y -= 15;
      } else if (this.y == 0 && this.elapsed < 450) {
        if (!this.start) {
          this.start = Date.now();
        }
        this.elapsed = Date.now() - this.start;
      } else {
        this.y -= 15;
      }
      if (this.y < -300) {
        this.lifetime = 0;
      }
    }
  }

  function classParticleHandler(cb) {
    this.start = Date.now();
    this.effects = [];
    this.lifetime = 20;
    this.y = 300;
    this.draw = function () {
      var elapsed = Date.now() - this.start;
      if (elapsed < 1500 && this.effects.length < 60) {
        this.effects.push(new cb())
      } else if (this.effects.length == 0) {
        this.lifetime = 0;
      }
      if (this.y > 0) {
        this.y -= 15;
      } else if (this.y == 0 && elapsed < 2000) {
        null;
      } else {
        this.y -= 15;
      }
      drawRect(0, this.y, 320, 300, "black");
      this.effects.forEach((ele, i) => {
        ele.draw();
        if (ele.lifetime <= 0) {
          this.effects.splice(i, 1);
        }
      });
    }
  }

  function flameParticle() {
    this.lifetime = 10;
    this.x = Math.random() * 320;
    this.y = 200;
    this.vx = Math.cos(Date.now() / 100) * 5;
    this.vy = Math.random() * 10 + 3;
    this.hue = Math.cos(Date.now()) * Math.random() * 30 + 35;
    this.draw = function () {
      this.vx = Math.cos(Date.now() / 75) * Math.random() * 10;
      DrawCircle(this.x, this.y, Math.random() * 10 + 10, `hsl(${this.hue}, 100%, ${Math.cos(Date.now() / 200) * Math.random() * 10 + 60}%)`)
      this.x += this.vx;
      this.y -= this.vy;
      if (this.y < 0) {
        this.lifetime = 0;
      }
    }
  }

  function voidParticle() {
    this.lifetime = 10;
    this.x = Math.random() * 320;
    this.y = Math.random() * 200;
    this.hue = Math.cos(Date.now()) * Math.random() * 30 + 290;
    this.radius = 1;
    this.start = Date.now();
    this.draw = function () {
      var elapsed = Date.now() - this.start;
      DrawCircle(this.x, this.y, this.radius, `hsl(${this.hue}, 100%, 50%)`)
      if (elapsed < 250) {
        this.radius += 4;
      } else {
        this.radius--;
        if (this.radius <= 0) {
          this.lifetime = 0;
        }
      }
    }
  }

  function arcParticle() {
    this.effects = []
    this.lifetime = 10;
    this.x = Math.random() * 320;
    this.y = 200;
    this.vx = Math.random() > .5 ? 16 : -16;
    this.vy = -16;
    this.change = 1;
    this.hue = Math.cos(Date.now()) * Math.random() * 30 + 215;
    this.start = Date.now();
    this.draw = function () {
      var elapsed = Date.now() - this.start;
      if (this.effects.length > 4) {
        this.effects.shift();
      }
      this.effects.forEach((ele) => {
        DrawCircle(ele[0], ele[1], 10, `hsl(${this.hue}, 100%, 50%)`)
      });
      DrawCircle(this.x, this.y, 15, `hsl(${this.hue}, 100%, 50%)`)
      this.effects.push([this.x, this.y]);
      if (elapsed > 50) {
        this.start = Date.now();
        this.change ? this.change = 0 : this.change = 1;
      }
      if (this.change) {
        this.x += this.vx;
      } else {
        this.y += this.vy;
      }
      if (this.x > 320 || this.x < 0 || this.y > 200 || this.y < 0) {
        this.lifetime = 0;
      }
    }
  }

  function grenade(color) {
    this.color = color;
    this.start = Date.now();
    this.radius = 15;
    this.lifetime = 10;
    this.y = 300;
    this.done = false;
    this.draw = function () {
      var elapsed = Date.now() - this.start;
      if (this.y > 0) {
        this.y -= 15;
      } else if (this.y == 0 && elapsed < 1000) {
        this.y = 0;
      }
      drawRect(0, this.y, 320, 300, "black");
      if (elapsed < 400) {
        DrawCircle(160, 100, this.radius, this.color);
        this.radius += 10;
      } else if (elapsed < 600) {
        DrawCircle(160, 100, this.radius, "white");
        this.radius -= 20;
        this.radius <= 0 ? this.radius = .01 : null;
      } else {
        if(!this.done){
          setTimeout(()=>{this.lifetime = 0}, 1000)
          for (let i = 0; i < 35; i++) {
            effects.push(new explosionParticle(160, 100, 50, this.color))
          }
          setTimeout(() => {
            for (let i = 0; i < 35; i++) {
              effects.push(new explosionParticle(160, 100, 50, this.color))
            }
          }, 200)
          this.done = true;
        }
        this.y -= 10;
      }
    }
  }

  function explosionParticle(x, y, min, color) {
    this.x = x;
    this.y = y;
    this.vx = Math.random() * -min + min / 2;
    this.vy = Math.random() * -min + min / 2;
    this.min = min;
    this.color = color;
    this.lifetime = 10;
    this.draw = function () {
      DrawCircle(this.x, this.y, Math.random() * 10 + 10, this.color)
      this.x += this.vx;
      this.y += this.vy;
      if (this.x > 320 || this.x < 0 || this.y > 200 || this.y < 0) {
        this.lifetime = 0;
      }
    }
  }

  function punch(color) {
    this.color = color;
    this.start = Date.now();
    this.y = 200;
    this.lifetime = 10;
    this.drew = false;
    this.draw = function () {
      var elapsed = Date.now() - this.start;
      ctx.globalAlpha = .75;
      drawRect(0, 0, 320, 200, "black")
      ctx.globalAlpha = 1;
      drawRect(120, this.y, 70, 70, "white")
      drawRect(170, this.y + 30, 35, 30, "white")
      drawRect(130, this.y + 30, 50, 120, "white")
      if (this.y > 65) {
        this.y -= 20;
      } else {
        if (!this.drew) {
          this.drew = true;
          effects.push(new expandingRing(160, 100, 15, this.color))
          setTimeout(() => { effects.push(new expandingRing(160, 100, 10, this.color)) }, 200)
        }
        setTimeout(() => { this.lifetime = 0 }, 200)
      }
    }
  }

  function expandingRing(x, y, speed, color) {
    this.x = x;
    this.y = y;
    this.speed = speed;
    this.radius = 1;
    this.color = color;
    this.draw = function () {
      DrawStroke(this.x, this.y, this.radius, this.color, 40)
      this.radius += this.speed;
      if (this.radius > 200) {
        this.lifetime = 0;
      }
    }
  }

  function renderPath(x, y, path, color) {
    ctx.fillStyle = color;
    ctx.save();
    ctx.translate(x, y);
    let ex = new Path2D(path);
    ctx.fill(ex);
    ctx.restore();
  }

  function DrawCircle(x, y, radius, color) {
    ctx.beginPath();
    ctx.fillStyle = color;
    ctx.arc(x, y, radius, 0, 2 * Math.PI)
    ctx.fill();
  };

  function DrawStroke(x, y, radius, color, stroke) {
    ctx.beginPath();
    ctx.strokeStyle = color;
    ctx.lineWidth = stroke;
    ctx.arc(x, y, radius, 0, 2 * Math.PI)
    ctx.stroke();
  };

  function drawRect(x, y, height, width, color) {
    ctx.beginPath();
    ctx.fillStyle = color;
    ctx.fillRect(x, y, height, width);
  }

  function copyScreen(alpha) {
    var shine = engine.vision.ShineMeter
    let lightness = new Int8Array(engine.zone.lightness);
    let sat = new Int8Array(engine.zone.saturation);
    let hue = new Int16Array(engine.zone.hue);
    for (var iZone = 0; iZone < 560; iZone++) {
      var iRow = Math.floor(iZone / 28);
      var iCol = iZone % 28;
      var iWidth = 320 / 28;
      var iHeight = 200 / 20;
      var iZx = iCol * iWidth;
      var iZy = iRow * iHeight;
      ctx.fillStyle =
        "hsla(" +
        hue[iZone] +
        "," +
        sat[iZone] +
        "%," +
        lightness[iZone] * keyScreenBrightness / 100 +
        "%, " +
        `${alpha}` +
        ")";

      ctx.fillRect(iZx, iZy, iWidth, iHeight);
    }

  }

  function StateHandler() {
    var stack = [];
    var state = null;

    var updateState = function () {
      if (stack.length > 0) {
        state = stack[stack.length - 1];
      } else {
        state = null;
      }
    };

    this.Push = function (newState) {
      stack.push(newState);
      updateState();
    };

    this.Pop = function () {
      stack.pop();
      updateState();
    };

    this.Process = function () {
      if (state != null) {
        state.Process();
      }
    };
  }

  function Meter(size, callback) {
    this.size = size;
    this.value = 0;
    this.diff = 0;
    this.increased = false;
    this.decreased = false;
    var values = [];

    this.setValue = function (updatedValue) {
      values.push(updatedValue);
      if (values.length > this.size) {
        values.shift();
      }

      for (var i = 0; i < values.length - 1; i++) {
        if (values[i] !== values[i + 1]) return;
      }
      if (this.value !== values[0]) {
        this.diff = Math.abs(this.value - values[0]);
        this.increased = this.value < values[0];
        this.decreased = this.value > values[0];
        this.value = values[0];
        callback();
      }
    };
  }

  function timedMeter(size, callback) {
    this.size = size;
    this.value = 0;
    this.diff = 0;
    this.increased = false;
    this.decreased = false;
    this.start = Date.now();
    this.elapsed = 0;
    var values = [];

    this.setValue = function (updatedValue) {
      values.push(updatedValue);
      this.elapsed = Date.now() - this.start;
      if (values.length > this.size) {
        values.shift();
      }

      for (var i = 0; i < values.length - 1; i++) {
        if (values[i] !== values[i + 1]) return;
      }
      if (this.value !== values[0]) {
        this.diff = Math.abs(this.value - values[0]);
        this.increased = this.value < values[0];
        this.decreased = this.value > values[0];
        this.value = values[0];
        this.start = Date.now();
        callback();
      }
    };
  }

  window.requestAnimationFrame(update);
</script>