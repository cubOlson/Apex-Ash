<head>
    <title>Destiny 2 Production</title>
    <meta description="Go on an adventure with metering and ambiance effects" />
    <meta publisher="SignalRGB" />

    <meta property="gameMode" label="Game mode" type="combobox"
    values="Campaign/Vanguard,Crucible,Gambit" default="Campaign/Vanguard" />

  
    <meta meter="inGame" tags="Destiny 2" type="area" x="0.3525" y="0.8729" width="0.0085" height=".001" h="0-360" s="0-30" l="70-100">
    </meta>
    <meta meter="ab1Orange" tags="Destiny 2" type="area" x="0.1852" y="0.8465" width="0.002" height=".04" h="0-30" s="60-90" l="65-100">
    </meta>
    <meta meter="ab2Orange" tags="Destiny 2" type="area" x="0.2105" y="0.8431" width="0.002" height=".04" h="0-30" s="60-90" l="65-100">
    </meta>
    <meta meter="ab3Orange" tags="Destiny 2" type="area" x="0.2363" y="0.8396" width="0.002" height=".04" h="0-30" s="60-90" l="65-100">
    </meta>
    <meta meter="ab1Purple" tags="Destiny 2" type="area" x="0.1852" y="0.8465" width="0.002" height=".04" h="250-360" s="15-50" l="25-65">
    </meta>
    <meta meter="ab2Purple" tags="Destiny 2" type="area" x="0.2105" y="0.8431" width="0.002" height=".04" h="250-360" s="15-50" l="25-65">
    </meta>
    <meta meter="ab3Purple" tags="Destiny 2" type="area" x="0.2363" y="0.8396" width="0.002" height=".04" h="250-360" s="15-50" l="25-65">
    </meta>
    <meta meter="ab1Blue" tags="Destiny 2" type="area" x="0.1852" y="0.8465" width="0.002" height=".04" h="145-195" s="25-60" l="50-90">
    </meta>
    <meta meter="ab2Blue" tags="Destiny 2" type="area" x="0.2105" y="0.8431" width="0.002" height=".04" h="145-195" s="25-60" l="50-90">
    </meta>
    <meta meter="ab3Blue" tags="Destiny 2" type="area" x="0.2363" y="0.8396" width="0.002" height=".04" h="145-195" s="25-60" l="50-90">
    </meta>
    <meta meter="ab1White" tags="Destiny 2" type="area" x="0.1898" y="0.8542" width="0.0122" height=".0271" h="0-360" s="0-25" l="80-100">
    </meta>
    <meta meter="ab2White" tags="Destiny 2" type="area" x="0.216" y="0.8514" width="0.0122" height=".0271" h="0-360" s="0-25" l="80-100">
    </meta>
    <meta meter="ab3White" tags="Destiny 2" type="area" x="0.2416" y="0.8507" width="0.0122" height=".0271" h="0-360" s="0-25" l="80-100">
    </meta>
    <meta meter="ultIcon" tags="Destiny 2" type="area" x="0.1791" y="0.8292" width="0.004" height=".001" h="20-90" s="30-80" l="60-100">
    </meta>
    <meta meter="ultFirstBar" tags="Destiny 2" type="area" x="0.3587" y="0.8118" width="0.003" height=".001" h="20-90" s="30-80" l="60-100">
    </meta>
    <meta meter="ammoColorWhite" tags="Destiny 2" type="area" x="0.361" y="0.8257" width="0.0005" height=".02" h="0-360" s="0-20" l="80-100">
    </meta>
    <meta meter="ammoColorPurple" tags="Destiny 2" type="area" x="0.361" y="0.8257" width="0.0005" height=".02" h="250-280" s="25-50" l="75-100">
    </meta>
    <meta meter="ammoColorGreen" tags="Destiny 2" type="area" x="0.361" y="0.8257" width="0.0005" height=".02" h="120-150" s="25-50" l="75-100">
    </meta>
    <meta meter="downedGhostRed" tags="Destiny 2" type="area" x="0.1852" y="0.0993" width="0.006" height=".001" h="0-30" s="30-100" l="50-100">
    </meta>
    <meta meter="downedWhite" tags="Destiny 2" type="area" x="0.3052" y="0.1653" width="0.001" height=".001" h="0-360" s="0-50" l="60-100">
    </meta>
    <meta meter="crucDeathR" tags="Destiny 2" type="area" x="0.1601" y="0.2815" width="0.005" height=".002" h="0-25" s="50-75" l="40-60">
    </meta>
    <meta meter="crucDeathW" tags="Destiny 2" type="area" x="0.16" y="0.2889" width="0.005" height=".001" h="0-360" s="0-20" l="80-100">
    </meta>
    <meta meter="crucDefeatG" tags="Destiny 2" type="area" x="0.5151" y="0.5472" width="0.01" height=".001" h="45-90" s="0-25" l="50-100">
    </meta>
    <meta meter="crucDefeatB1" tags="Destiny 2" type="area" x="0.4968" y="0.4326" width="0.005" height=".001" h="0-360" s="0-100" l="0-15">
    </meta>
    <meta meter="crucDefeatB2" tags="Destiny 2" type="area" x="0.5" y="0.6188" width="0.003" height=".001" h="0-360" s="0-100" l="0-15">
    </meta>
    <meta meter="crucScoreR" tags="Destiny 2" type="area" x="0.5058" y="0.0625" width="0.0619" height=".0001" h="0-30" s="50-75" l="50-75">
    </meta>
    <meta meter="crucScoreB" tags="Destiny 2" type="area" x="0.432" y="0.0625" width="0.0619" height=".0001" h="200-220" s="40-60" l="50-75">
    </meta>
    <meta meter="crucVictoryW" tags="Destiny 2" type="area" x="0.4948" y="0.4611" width="0.001" height=".001" h="0-360" s="0-25" l="90-100">
    </meta>
    <meta meter="crucVictoryR" tags="Destiny 2" type="area" x="0.5023" y="0.5576" width="0.01" height=".001" h="0-25" s="75-100" l="60-90">
    </meta>
    <meta meter="crucVictoryB" tags="Destiny 2" type="area" x="0.4915" y="0.6097" width="0.004" height=".001" h="0-180" s="80-100" l="0-25">
    </meta>
    <meta meter="gambitPrimeval1" tags="Destiny 2" type="area" x="0.3371" y="0.1174" width="0.125" height=".0001" h="35-50" s="70-100" l="70-100">
    </meta>
    <meta meter="gambitPrimeval2" tags="Destiny 2" type="area" x="0.5392" y="0.1174" width="0.125" height=".0001" h="35-50" s="70-100" l="70-100">
    </meta>
  
  </head>
  
  <body style="margin: 0; padding: 0; background: #000;">
    <canvas id="exCanvas" width="320" height="200"></canvas>
  </body>
  
  <script>
    var canvas, ctx;
    canvas = document.getElementById('exCanvas');
    ctx = canvas.getContext('2d');
    var width = 320;
    var height = 200;
    var stateHdlr = new StateHandler();
    var effects = [];
    var ab1Activated = false;
    var ab2Activated = false;
    var ab3Activated = false;
    var ultCharged = false;
    var ultInUse = false;

    var InGameMeter = new Meter(10, ()=>"");

    var Ability1OrangeMeter = new Meter(15, grenadeHandler);
    var Ability2OrangeMeter = new Meter(15, meleeHandler);
    var Ability3OrangeMeter = new Meter(15, zoneHandler);
    var Ability1PurpleMeter = new Meter(15, grenadeHandler);
    var Ability2PurpleMeter = new Meter(15, meleeHandler);
    var Ability3PurpleMeter = new Meter(15, zoneHandler);
    var Ability1BlueMeter = new Meter(15, grenadeHandler);
    var Ability2BlueMeter = new Meter(15, meleeHandler);
    var Ability3BlueMeter = new Meter(15, zoneHandler);
    var Ability1WhiteMeter = new Meter(17, ()=>"");
    var Ability2WhiteMeter = new Meter(17, ()=>"");
    var Ability3WhiteMeter = new Meter(17, ()=>"");

    var UltimateIconMeter = new Meter(10, ultimateHandler);
    var UltimateBarMeter = new Meter(10, ultimateHandler);

    var AmmoColorPurpleMeter = new Meter(10, ammoTypeHandler);
    var AmmoColorWhiteMeter = new Meter(10, ammoTypeHandler);
    var AmmoColorGreenMeter = new Meter(10, ammoTypeHandler);

    var DownedGhostRedMeter = new Meter(20, downedHandler);
    var DownedGhostWhiteMeter = new Meter(20, downedHandler);

    var CrucibleDeathRedMeter = new Meter(10, crucibleDeathHandler);
    var CrucibleDeathWhiteMeter = new Meter(10, crucibleDeathHandler);
    var CrucibleDefeatGreyMeter = new Meter(10, crucibleDefeatHandler);
    var CrucibleDefeatBlack1Meter = new Meter(10, crucibleDefeatHandler);
    var CrucibleDefeatBlack2Meter = new Meter(10, crucibleDefeatHandler);
    var CrucibleScoreRedMeter = new Meter(15, crucibleScoreHandler);
    var CrucibleScoreBlueMeter = new Meter(15, crucibleScoreHandler);
    var CrucibleVictoryRedMeter = new Meter(10, crucibleVictoryHandler);
    var CrucibleVictoryWhiteMeter = new Meter(10, crucibleVictoryHandler);
    var CrucibleVictoryBlackMeter = new Meter(10, crucibleVictoryHandler);

    var GambitPrim1Meter = new Meter (10, primevalHandler);
    var GambitPrim2Meter = new Meter (10, primevalHandler);

  
    function update() {
      InGameMeter.setValue(engine.vision.inGame);

      if(InGameMeter.value == 1){
        Ability1OrangeMeter.setValue(engine.vision.ab1Orange);
        Ability2OrangeMeter.setValue(engine.vision.ab2Orange);
        Ability3OrangeMeter.setValue(engine.vision.ab3Orange);
        Ability1PurpleMeter.setValue(engine.vision.ab1Purple);
        Ability2PurpleMeter.setValue(engine.vision.ab2Purple);
        Ability3PurpleMeter.setValue(engine.vision.ab3Purple);
        Ability1BlueMeter.setValue(engine.vision.ab1Blue);
        Ability2BlueMeter.setValue(engine.vision.ab2Blue);
        Ability3BlueMeter.setValue(engine.vision.ab3Blue);
        Ability1WhiteMeter.setValue(engine.vision.ab1White);
        Ability2WhiteMeter.setValue(engine.vision.ab2White);
        Ability3WhiteMeter.setValue(engine.vision.ab3White);
        AmmoColorPurpleMeter.setValue(engine.vision.ammoColorPurple);
        AmmoColorWhiteMeter.setValue(engine.vision.ammoColorWhite);
        AmmoColorGreenMeter.setValue(engine.vision.ammoColorGreen);
        UltimateIconMeter.setValue(engine.vision.ultIcon);
        UltimateBarMeter.setValue(engine.vision.ultFirstBar);
      };
      
      if(gameMode == "Campaign/Vanguard"){
        DownedGhostRedMeter.setValue(engine.vision.downedGhostRed);
        DownedGhostWhiteMeter.setValue(engine.vision.downedWhite);
      } else if(gameMode == "Crucible"){
        CrucibleDeathRedMeter.setValue(engine.vision.crucDeathR);
        CrucibleDeathWhiteMeter.setValue(engine.vision.crucDeathW);
        CrucibleDefeatGreyMeter.setValue(engine.vision.crucDefeatG);
        CrucibleDefeatBlack1Meter.setValue(engine.vision.crucDefeatB1);
        CrucibleDefeatBlack2Meter.setValue(engine.vision.crucDefeatB2);
        CrucibleVictoryRedMeter.setValue(engine.vision.crucVictoryR);
        CrucibleVictoryWhiteMeter.setValue(engine.vision.crucVictoryW);
        CrucibleVictoryBlackMeter.setValue(engine.vision.crucVictoryB);
        if(engine.vision.crucScoreR > .01 && engine.vision.crucScoreB > .01){
          CrucibleScoreRedMeter.setValue(engine.vision.crucScoreR);
          CrucibleScoreBlueMeter.setValue(engine.vision.crucScoreB);
        }
      } else if (gameMode == "Gambit"){
        CrucibleDeathRedMeter.setValue(engine.vision.crucDeathR);
        CrucibleDeathWhiteMeter.setValue(engine.vision.crucDeathW);
        if(engine.vision.gambitPrimeval1 > .01 && engine.vision.gambitPrimeval2 > .01){
          GambitPrim1Meter.setValue(engine.vision.gambitPrimeval1);
          GambitPrim2Meter.setValue(engine.vision.gambitPrimeval2);
        }
      };

        copyScreen(1);
  
      for (let i = 0; i < effects.length; i++) {
        effects[i].draw();
        if (effects[i].lifetime <= 0) {
          effects.splice(i, 1);
        }
      };
  
      stateHdlr.Process();
      window.requestAnimationFrame(update);
    };

    function grenadeHandler(){
      if(Ability1WhiteMeter.value > .15 && !ab1Activated){
        ab1Activated = true;
        if(Ability1OrangeMeter.decreased && Ability1OrangeMeter.diff > .5){
          effects.push(new grenade("orange"));
        } 
        if(Ability1BlueMeter.decreased && Ability1BlueMeter.diff > .5){
          effects.push(new grenade("blue"));
        } 
        if(Ability1PurpleMeter.decreased && Ability1PurpleMeter.diff > .5){
          effects.push(new grenade("purple"));
        }
        setTimeout(()=>{ab1Activated = false}, 1000)
      }
    }

    function meleeHandler(){
      if(Ability2WhiteMeter.value > .15 && !ab2Activated){
        ab2Activated = true;
        if(Ability2OrangeMeter.decreased && Ability2OrangeMeter.diff > .8){
          effects.push(new punch("orange"));
        } 
        if(Ability2BlueMeter.decreased && Ability2BlueMeter.diff > .8){
          effects.push(new punch("blue"));
        } 
        if(Ability2PurpleMeter.decreased && Ability2PurpleMeter.diff > .8){
          effects.push(new punch("purple"));
        }
        setTimeout(()=>{ab2Activated = false}, 1000)
      }
    }

    function zoneHandler(){
      if(Ability3WhiteMeter.value > .15 && !ab3Activated){
        ab3Activated = true;
        if(Ability3OrangeMeter.decreased && Ability3OrangeMeter.diff > .8){
          effects.push(new classParticleHandler(flameParticle))
        } 
        if(Ability3BlueMeter.decreased && Ability3BlueMeter.diff > .8){
          effects.push(new classParticleHandler(arcParticle))
        } 
        if(Ability3PurpleMeter.decreased && Ability3PurpleMeter.diff > .8){
          effects.push(new classParticleHandler(voidParticle))
        }
        setTimeout(()=>{ab3Activated = false}, 1000)
      }
    }

    function ultimateHandler(){
      if(UltimateIconMeter.value == 1 && UltimateBarMeter.value == 1 && !ultCharged){
        effects.push(new ultimateCharged())
        ultCharged = true;
      } else if (UltimateIconMeter.value == 1 && UltimateBarMeter.value == 0 && ultCharged && !ultInUse){
        effects.push(new ultimateInUse())
        ultInUse = true;
      } else if (UltimateIconMeter.value == 0 && UltimateBarMeter.value == 0 && ultCharged && ultInUse){
        effects.push(new ultimateDone())
        ultCharged = false;
        ultInUse = false;
      }
    }

    function ammoTypeHandler(){
      if(AmmoColorGreenMeter.value == 1 && AmmoColorGreenMeter.diff > .8 && !ultInUse){
        effects.push(new ammoType("green"))
      }
      if(AmmoColorPurpleMeter.value == 1 && AmmoColorPurpleMeter.diff > .8 && !ultInUse){
        effects.push(new ammoType("purple"))
      }
      if(AmmoColorWhiteMeter.value == 1 && AmmoColorWhiteMeter.diff > .8 && !ultInUse){
        effects.push(new ammoType("white"))
      }
    }

    function downedHandler(){
      if(DownedGhostRedMeter.value == 1 && DownedGhostWhiteMeter.value == 1 && DownedGhostRedMeter.increased){
        console.log("Downed " + Date.now())
      }
    }

    function crucibleDeathHandler(){
      if(CrucibleDeathRedMeter.value > .7 
      && CrucibleDeathWhiteMeter.value > .3 
      && CrucibleDeathRedMeter.increased 
      && CrucibleDeathRedMeter.diff > .5 
      && CrucibleDeathWhiteMeter.increased){
        console.log("PVP DEAD " + Date.now())
      }
    }

    function crucibleScoreHandler(){
      var blue = CrucibleScoreBlueMeter.value ? CrucibleScoreBlueMeter.value : 0;
      var red = CrucibleScoreRedMeter.value ? CrucibleScoreRedMeter.value : 0;
      if(blue > red){
        console.log("BLUE WINNING " + Date.now())
      } else if (red > blue){
        console.log("RED WINNING " + Date.now())
      }
    }

    function crucibleVictoryHandler(){
      if(CrucibleVictoryBlackMeter.value == 1 && CrucibleVictoryRedMeter.value == 1 && CrucibleVictoryWhiteMeter.value == 1){
        console.log("CRUCIBLE VICTORY " + Date.now())
      }
    }

    function crucibleDefeatHandler(){
      if(CrucibleDefeatBlack1Meter.value > .8 && CrucibleDefeatBlack2Meter.value > .8 && CrucibleDefeatGreyMeter.value > .8){
        console.log("CRUCIBLE DEFEAT " + Date.now())
      }
    }

    function primevalHandler(){
      if(GambitPrim1Meter.value < GambitPrim2Meter.value){
        console.log("Gambit YOU WINNING " + Date.now())
      } else if (GambitPrim2Meter.value < GambitPrim1Meter.value){
        console.log("GAMBIT LOSING " + Date.now())
      }
    }

    function ultimateDone(){
      this.start = Date.now();
      this.lifetime = 10;
      this.lightness1 = 50;
      this.lightness2 = 50;
      this.lightness3 = 50;
      this.alpha = 1;
      
      this.draw = function(){
        var elapsed = Date.now() - this.start;
        var grd = ctx.createRadialGradient(160,100,100,160,100,400);
        grd.addColorStop(0, `hsl(0, 100%, ${this.lightness1}%)`);
        grd.addColorStop(.5, `hsl(0, 100%, ${this.lightness2}%)`);
        grd.addColorStop(1, `hsl(0, 100%, ${this.lightness3}%)`);
        this.lightness1 > 0 ? this.lightness1-- : this.lightness2 > 0 ? this.lightness2-- : this.lightness3 > 0 ? this.lightness3-- : null;
        this.lightness3 <= 0 ? this.alpha -= .05 : null;
        ctx.globalAlpha = this.alpha
        ctx.fillStyle = grd;
        ctx.fillRect(0, 0, 320, 200);
        ctx.globalAlpha = 1;
        this.alpha <= 0 ? this.lifetime = 0 : null;
      }
    }

    function ultimateInUse(speed){
    this.start = Date.now();
    this.lifetime = 10;
    this.speed = speed;
    this.hue = 60;
    this.draw = function(){
      var elapsed = Date.now() - this.start;
      if(elapsed > this.speed){
        effects.push(new ultRect(45, 12, `hsl(${this.hue}, 100%, 50%)`));
        this.hue > 0 ? this.hue--: null;
        this.start = Date.now()
      }
      if(!ultInUse){
          this.lifetime = 0;
        }
    }
  }

    function ultRect(height, speed, color){
      this.lifetime = 10;
      this.y = 200;
      this.height = height;
      this.speed = speed;
      this.color = color;
      this.draw = function(){
        ctx.beginPath();
        ctx.fillStyle = this.color;
        ctx.fillRect(0, this.y, 320, this.height);
        this.y-=this.speed;
        if(this.y < -30){
          this.lifetime = 0;
        }
      }
    }

    function ultimateCharged(){
      this.start = Date.now();
      this.radius = 5;
      this.count = 0;
      this.x = 0;
      this.width = 160;
      this.lifetime = 10;
      this.draw = function(){
        var elapsed = Date.now() - this.start;
        if(elapsed < 200){
          DrawCircle(160, 100, this.radius, "yellow");
        } else if (this.radius < 75){
          DrawCircle(160, 100, this.radius, "yellow");
          this.radius+=5;
        } else if (this.x < 400){
            DrawCircle(160, 100, this.radius, "yellow")
            drawRect(160 - this.x, 25, this.x, 150, "yellow");
            drawRect(160, 25, this.x, 150, "yellow");
            this.x+=15;
        } else if (this.width > 0){
            drawRect(0, 25, this.width, 150, "yellow");
            drawRect(320 - this.width, 25, this.width, 150, "yellow");
            this.width -= 15;
        } else {
          this.lifetime = 0;
        }
      }
    }

    function ammoType(color){
      this.start = 0;
      this.elapsed = 0;
      this.color = color;
      this.lifetime = 10;
      this.y = 300;
      this.draw = function(){
        var xVar = Math.cos(Date.now() / 100) * 20
        drawRect(0, this.y, 320, 300, "black");
        for(let i = 0; i < 4; i++){
          drawRect(60 + xVar + i * 50, this.y * 3 / 2 + 75, 30, 50, this.color);
        }
        if(this.y > 0){
          this.y -= 15;
        } else if (this.y == 0 && this.elapsed < 450){
          if(!this.start){
            this.start = Date.now();
          }
          this.elapsed = Date.now() - this.start;
        } else {
          this.y -= 15;
        }
        if(this.y < -300){
          this.lifetime = 0;
        }
      }
    }

    function classParticleHandler(cb){
      this.start = Date.now();
      this.effects = [];
      this.lifetime = 20;
      this.draw = function(){
        var elapsed = Date.now() - this.start;
        if(elapsed < 1500 && this.effects.length < 50){
          this.effects.push(new cb())
        } else if (this.effects.length == 0){
          this.lifetime = 0;
        }
        this.effects.forEach((ele, i) => {
          ele.draw();
          if(ele.lifetime <= 0){
            this.effects.splice(i, 1);
          }
        });
      }
    }

  function flameParticle(){
    this.lifetime = 10;
    this.x = Math.random() * 320;
    this.y = 200;
    this.vx = Math.cos(Date.now() / 100) * 5;
    this.vy = Math.random() * 10 + 3;
    this.hue = Math.cos(Date.now()) * Math.random() * 30 + 35;
    this.draw = function(){
      this.vx = Math.cos(Date.now() / 75) * Math.random() * 10;
      DrawCircle(this.x, this.y, Math.random() * 10 + 10, `hsl(${this.hue}, 100%, ${Math.cos(Date.now() / 200) * Math.random() * 10 + 60}%)`)
      this.x += this.vx;
      this.y-= this.vy;
      if(this.y < 0){
        this.lifetime = 0;
      }
    }
  }

  function voidParticle(){
    this.lifetime = 10;
    this.x = Math.random() * 320;
    this.y = Math.random() * 200;
    this.hue = Math.cos(Date.now()) * Math.random() * 30 + 290;
    this.radius = 1;
    this.start = Date.now();
    this.draw = function(){
      var elapsed = Date.now() - this.start;
      DrawCircle(this.x, this.y, this.radius, `hsl(${this.hue}, 100%, 50%)`)
      if(elapsed < 250){
        this.radius+=4;
      } else {
        this.radius--;
        if(this.radius <= 0){
          this.lifetime = 0;
        }
      }
    }
  }

  function arcParticle(){
    this.effects = []
    this.lifetime = 10;
    this.x = Math.random() * 320;
    this.y = 200;
    this.vx = Math.random() > .5 ? 16 : -16;
    this.vy = -16;
    this.change = 1;
    this.hue = Math.cos(Date.now()) * Math.random() * 30 + 215;
    this.start = Date.now();
    this.draw = function(){
      var elapsed = Date.now() - this.start;
      if(this.effects.length > 4){
        this.effects.shift();
      }
      this.effects.forEach((ele) => {
        DrawCircle(ele[0], ele[1], 10, `hsl(${this.hue}, 100%, 50%)`)
      });
      DrawCircle(this.x, this.y, 15, `hsl(${this.hue}, 100%, 50%)`)
      this.effects.push([this.x, this.y]);
      if(elapsed > 50){
        this.start = Date.now();
        this.change ? this.change = 0 : this.change = 1;
      }
      if(this.change){
        this.x += this.vx;
      } else {
        this.y += this.vy;
      }
      if(this.x > 320 || this.x < 0 || this.y > 200 || this.y < 0){
        this.lifetime = 0;
      }
    }
  }

    function grenade(color){
      this.color = color;
      this.start = Date.now();
      this.radius = 15;
      this.lifetime = 10;
      this.draw = function(){
        var elapsed = Date.now() - this.start;
        if(elapsed < 400){
          DrawCircle(160, 100, this.radius, this.color);
          this.radius+=10;
        } else if (elapsed < 600){
          DrawCircle(160, 100, this.radius, "white");
          this.radius-=20;
          this.radius <= 0 ? this.radius = .01 : null;
        } else {
          this.lifetime = 0;
          for(let i = 0; i < 35; i++){
            effects.push(new explosionParticle(160, 100, 50, this.color))
          }
          setTimeout(()=>{          
            for(let i = 0; i < 35; i++){
              effects.push(new explosionParticle(160, 100, 50, this.color))
            }
          }, 200)
        }
      }
    }

    function explosionParticle(x, y, min, color){
      this.x = x;
      this.y = y;
      this.vx = Math.random() * -min + min/2;
      this.vy = Math.random() * -min + min/2;
      this.min = min;
      this.color = color;
      this.lifetime = 10;
      this.draw = function(){
        DrawCircle(this.x, this.y, Math.random() * 10 + 10, this.color)
        this.x += this.vx;
        this.y += this.vy;
        if(this.x > 320 || this.x < 0 || this.y > 200 || this.y < 0){
          this.lifetime = 0;
        }
      }
    }

    function punch(color){
    this.color = color;
    this.start = Date.now();
    this.y = 200;
    this.lifetime = 10;
    this.drew = false;
    this.draw = function(){
      var elapsed = Date.now() - this.start;
      ctx.globalAlpha = .6;
      drawRect(0, 0, 320, 200, "black")
      ctx.globalAlpha = 1;
      drawRect(120, this.y, 70, 70, "white")
      drawRect(170, this.y + 30, 35, 30, "white")
      drawRect(130, this.y + 30, 50, 120, "white")
      if(this.y > 65){
        this.y-=20;
      } else {
        if (!this.drew){
          this.drew = true;
          effects.push(new expandingRing(160, 100, 15, this.color))
          setTimeout(()=>{effects.push(new expandingRing(160, 100, 10, this.color))}, 200)
        }
        setTimeout(()=>{this.lifetime = 0}, 200)
      }
    }
  }

  function expandingRing(x, y, speed, color){
    this.x = x;
    this.y = y;
    this.speed = speed;
    this.radius = 1;
    this.color = color;
    this.draw = function(){
      DrawStroke(this.x, this.y, this.radius, this.color, 40)
      this.radius += this.speed;
      if(this.radius > 200){
        this.lifetime = 0;
      }
    }
  }

    function DrawCircle(x,y,radius,color){
        ctx.beginPath();
        ctx.fillStyle = color;
        ctx.arc(x,y,radius, 0, 2* Math.PI)
        ctx.fill();
    };

    function DrawStroke(x, y, radius, color, stroke){
        ctx.beginPath();
        ctx.strokeStyle = color;
        ctx.lineWidth = stroke;
        ctx.arc(x,y,radius, 0, 2* Math.PI)
        ctx.stroke();
    };

    function drawRect(x, y, height, width, color){
      ctx.beginPath();
      ctx.fillStyle = color;
      ctx.fillRect(x, y, height, width);
    }
  
  function copyScreen(alpha) {
  
  var shine = engine.vision.ShineMeter
  let lightness = new Int8Array(engine.zone.lightness);
  let sat = new Int8Array(engine.zone.saturation);
  let hue = new Int16Array(engine.zone.hue);
  for (var iZone = 0; iZone < 560; iZone++) {
      var iRow = Math.floor(iZone / 28);
      var iCol = iZone % 28;
      var iWidth = 320 / 28;
      var iHeight = 200 / 20;
      var iZx = iCol * iWidth;
      var iZy = iRow * iHeight;
      ctx.fillStyle =
          "hsla(" +
          hue[iZone] +
          "," +
          sat[iZone] +
          "%," +
          lightness[iZone] +
          "%, " +
          `${alpha}` +
          ")";
  
      ctx.fillRect(iZx, iZy, iWidth, iHeight);
  }
  
  }
  
    function StateHandler() {
      var stack = [];
      var state = null;
  
      var updateState = function () {
        if (stack.length > 0) {
          state = stack[stack.length - 1];
        } else {
          state = null;
        }
      };
  
      this.Push = function (newState) {
        stack.push(newState);
        updateState();
      };
  
      this.Pop = function () {
        stack.pop();
        updateState();
      };
  
      this.Process = function () {
        if (state != null) {
          state.Process();
        }
      };
    }
  
    function Meter(size, callback) {
              this.size = size;
              this.value = 0;
              this.diff = 0;
              this.increased = false;
              this.decreased = false;
              var values = [];
  
              this.setValue = function (updatedValue) {
                  values.push(updatedValue);
                  if (values.length > this.size) {
                      values.shift();
                  }
  
                  for (var i = 0; i < values.length - 1; i++) {
                      if (values[i] !== values[i + 1]) return;
                  }
                  if (this.value !== values[0]) {
                      this.diff = Math.abs(this.value - values[0]);
                      this.increased = this.value < values[0];
                      this.decreased = this.value > values[0];
                      this.value = values[0];
                      callback();
                  }
              };
          }

    window.requestAnimationFrame(update);
  </script>