<head>
  <title>Fish Tank</title>
  <meta description="A school of fish swimming around your RGB devices." />
  <meta publisher="SignalRGB" />
  <meta
    property="fishCount"
    label="Number of fish"
    type="number"
    min="1"
    max="10"
    default="5"
  />
  <meta
    property="speed"
    label="Fish speed"
    type="number"
    min="0"
    max="100"
    default="50"
  />
  <meta
    property="bg"
    label="Background Color"
    type="color"
    min="0"
    max="360"
    default="#001326"
  />
  <meta
    property="tapEffects"
    label="Keypress Effect"
    type="boolean"
    default="1"
  />
  <meta
    property="bubbleColor"
    label="Bubble Color"
    type="color"
    min="0"
    max="360"
    default="#40e6ff"
  />
</head>

<body style="margin: 0; padding: 0">
  <canvas id="exCanvas" width="320" height="200"></canvas>
</body>

<script>
  var c = document.getElementById("exCanvas");
  var ctx = c.getContext("2d");
  var width = 320;
  var height = 200;
  var hue = 1;

  const fish1 =
    "M82.78,90.09c2.66.45,8.09-3.16,8.09-3.16C105,72,127.44,41.78,152.1,35.68c4.36-1.08-3.39-27.74-17.4-33.87a5.84,5.84,0,0,1-1.37-.68c.1-.25,16.78-.45,35.65,5.75,13.72,4.5,25.19,12.37,36.67,18.48.6.32,4.41,3.83,4.35,4.12-.34,1.5-44.92-7.65.68.24,52.47,9.08,90.5,48.36,89.29,55.72-3.28,20-39.8,44.75-75.43,48.16-3.69.36-2.68,3.14-8.94,8.5-2.57,2.21-4,5.07-11,9.84-6.63,4.51-18.11,8.4-18.64,7.92-.88-.81,12-12.86,15.36-23.72.57-1.88-4.48-1.09-5.23-1-14.07,2-29.36-.66-43.07-3.49-30.34-6.27-43.84-25-66.93-24.44C71,107.58,57,123.92,43.43,138.67,38.7,152,20.4,171,22.85,164c6-17,6.57-41.85,6-59.92C27.79,73.39,9.29,43.87.94,35.22,5.55,31.52,47.79,84.24,82.78,90.09Z";
  const fish2 =
    "M48.3,70l-11.77.44c-1-1-12.48-11.4-21.47-9.09C2.58,64.53,2,85.28,1.94,87.41c-.14,8.3,2.4,22.31,9.84,24,17.74,4,16.25-2.54,23.85-7.75,3.91-2.68,8.64-.35,11.18,0C51.89,104.34,57,108,57,108c-.38,3.78-1.56,4-3.1,10.36-1.45,6-.55,9.53.42,12.37a9.9,9.9,0,0,0,5.21,5.44c2.71,1.2,8.42,3.13,16.77.37a66.26,66.26,0,0,1,12.53-3.13c2.59-.43,3.57-4.08,9.46-4.24,5.56-.16,9.79,2.43,12.23,3.57-2.74,7.16-2.1,14.34,1.93,18.34,4.46,4.43,11.5,3.43,15.36,2.83,12.82-2,22.36-11.32,28.24-17.3,1.47-1.49,6.19-1.7,7-1.91,42.49-11.18,58-32.08,58.51-49.06a17.16,17.16,0,0,0-.3-4c-1.48-7.38-6.64-16.52-49.93-40.31-2.64-1.45.22-.28-.52-2-13.12-30.26-45.43-30-52.35-26.8-8.25,3.78-8.21,16.39-8.25,29.67a50.88,50.88,0,0,1-12.29,3.69s-4.62-1.88-5.37-2.23c-13.77-6.46-27.1-11.81-33.39-6-14.46,13.42.33,25.08.45,26.84";
  const fish3 =
    "M185.68,7c2.34-.44,32.42,6.71,34.88,8.52,4.4,3.26,1.81,9.66,4.32,15.06,9,4.32,16.72,4.1,34,12.22,14,6.61,22.57,17.64,30.71,28.18a71.13,71.13,0,0,1,7.6,12.52c1.92,4,2.88,6.09,2.82,8.2-.17,6-7.06,10.1-14.45,14.6-32,19.49-30,19.51-36.07,21.62-13,4.53-15.2,3.93-20.57,5.81-2.34.82-7.36-1.11-7.36-1.11a12.8,12.8,0,0,0-1.14,1.26c-8,10.14-20.3,33.9-32.5,31.12-5.88-1.34-17.44-2.2-11.36-28.86.15-.63-1.05-.34-1.61-.47-21.9-4.88-33-8.94-39.35-7.45-19.68,4.62-25,11.3-39.35,10.43-12.93-.77-30.06-7.3-32.5-18.33-6-27,21.93-16.06,20.27-21.92-1-3.6-10.46-5-18.33-3.72C57.48,96,49.2,107,34.07,111.52c-3.65,1.1-14.31,13-26.23-1.49C2.47,103.52.74,94.62,0,74-.81,51.21,3.11,45.75,5,43.55c5.46-6.36,13.16-7.91,16.1-8.5C46.42,30,69.59,56.73,71.79,59.35c10.68,2.15,13.2,1.15,13.71,0,1.57-3.48-15.2-.9-15-20.13.07-8.8,10.31-17.1,18.63-20.27,15.92-6.06,33.09,2.86,39.06,6,2.25,1.18,4.07,2.29,5.36,3.13l6.41.15,5.07-3";
  const fish4 =
    "M7.84,22.23A23.27,23.27,0,0,1,18.42,21C38.93,23.72,44,55.54,63.89,57.56,69.87,58.17,76,56,76,54.88c0-1.34-9.13-.32-11.33-4.48-.87-1.64-1-4.74,16-25.19,8.7-10.49,12.62-14.38,18.19-18,6.65-4.36,10-6.55,13.57-6,10.7,1.73,6.22,23,21.31,37.86,12.7,12.51,25.76,7.16,44.87,25.2,6.08,5.73,7.67,9,7.64,12.22-.09,10.06-15.49,18.94-27.46,23-43.53,14.61-37.75,2.27-36.82,14,1.19,15.06-11.78,41.84-16.7,41.89-3.23,0-4.27-10.12-10.14-14.31-2.08-1.49-1.19,9.84-21.16,11.18-3,.2-3.13-3.73,3.28-34.44,17.78-1.71,22.08-3.87,22.21-5.66.21-3.15-12.53-3.35-18.79-13.42-4.23-6.81-3.26-14.53-6.11-14.9-1.18-.16-2.6,1-4.62,4.47-6,10.32-3.59,17.32-6.56,25.34-1.5,4-7.16,8.66-18.48,17.89-17.73,14.44-23.9,14.7-27.73,13.86-2.35-.51-4.22-.92-5.37-2.53C4.71,133,39.93,99.26,35,93.63,32.67,91,24.7,97.83,16,93.78c-6.26-2.92-8.83-9.6-9.24-10.73-3.36-9.12,2.87-13.3.29-24.45-1.56-6.76-4.28-7.06-5.55-13C-.29,37.1,3.45,28.78,7.84,22.23Z";
  const fish5 =
    "M109.65,103.92c-1.58-2.44-43.5,29.35-86.76,25-10.62-1.06-16.3-3.79-19-8.27-5.89-9.76,7.46-19.35,8.27-40.47.84-21.76-12.56-31-6-43.38,3.53-6.68,11.22-11.17,18.34-12.3C46.91,21,58.3,51.78,88.86,57.63c14.69,2.82,27.74-1.29,35.77-4.69-3.94,1.14-13.12,3.16-22.13-1.12C85.94,44,80.23,19.74,87.52,7.32c8.24-14,36.94-19.48,63.72-1.34l6.93-4,6.94,3.13,5.14-4,3.58,3.6,5.36-7.16L184.11,1l6.49-8.25L198-3.41l5.39-3.8L208-3.86l8.05-6,5.81,7.82L227-7.43,232-.5l5.82-4.92,3.13.44,3.57,8.73,6.94-5.59,5.36,14.75,5.15-1.11c.68,2.3-.95,13.63,5.14,12.52,24.37-4.48,117.39,59.17,115.6,69.09-.42,2.32-5.74,4.19-5.14,5.59s6.85-.83,8.05.89c1.84,2.65-6.82,17.69-16.55,20.35-42.48,11.63-49.86,10.51-73.86,21.77-2.56,1.19-14.6,1.64-14.6,1.64-1,1.71-9.78,1.47-9.92,1.86-.73,2-21.37,56.63-30.41,55.68-3.13-.33-30.86-37.35-9.84-59.26,7.89-8.23-22.16-6-33.1-3.35l-5.81,9.17-10.06.44-10.73,6.93-9.84.68-4.25-4.92L150,155.12a11.94,11.94,0,0,0-4.57-5.14c-10.24-5.9-23.1,11.52-40.47,10.06-11.62-1-24.07-10.27-25.27-19.9C77.56,123.07,111,106,109.65,103.92Z";
  const fish6 =
    "M15.74,33.26c18.37-11.19,62.4,9.88,97.94,8.5,1.75-.07,7.83-.37,8.94-3.36,2.56-6.87-25-17.68-23.7-30.63,1-9.83,17.61-11.78,17.66-19,.09-12.95-53.28-20.61-52.77-25.26.47-4.2,45.59-13.2,97.72,1.79,63,18.1,121.6,67,160.77,93.24L325,60.32c16.68,11.05,19.4,11.68,20.57,13.19,7.4,9.53-31.77,72.85-123.2,131.25-46.23,29.53-87.42,46.05-87.88,45.17-.65-1.26,80.41-42,78-47.18S126.33,228.4,126.2,228s43.38-19.68,74.46-39.36c7.44-4.71-16.42-14.31-19-15.2-46-15.92-102.75,60-111.35,52.55-5.33-4.64,10.8-10,37.56-63.51,17-34-29.51,21.69,14.76-72.22,9.1-19.31-78.95,36.36-106,18.56C-3.86,95.35-3,44.71,15.74,33.26Z";
  const fish7 =
    "M-42.4,14.93-14,79.7l-40.25,70.5,82.73-42.7c43.37,2.93,53.69,5,53.67,6.48,0,2.16-22.86-1.16-30.41,10.29-9.75,14.79,9.5,61.11,26.61,53.21,80.49-37.11,15.82-35.14,42.93-28.17,61,15.69,52.93-11.85,53.66,1.79.67,12.52-8.64,36.08-4.69,38.46s20.57-3.36,39.35-34.21a20.69,20.69,0,0,1,7.93-7.88s-9.14,6.62-7.33,6.94c23.55,4.07,65.37-1.75,65.37-1.75,33.76,8.66,89.9-30.34,86.53-60.59C360.49,77.62,336,58.53,282.27,30.35,266.28,22,236.21,12,217,11.57c-.29,0-18.14-28.9-19.9-29.07,0,0-.36-4.93-9.84-11.18-13.06-8.61-3.15-5.54-15.87-9.84C116.71-57,33.52,21.94,42.8,44.66c3.31,8.12,18.4,9,17.88,13.87Z";
  const fish8 =
    "M13.73,33.71c7.37-5.36,21-2.7,68.42,32.64,2.31,1.73,14.45.54,14.76-1.34.21-1.34-5.41-3.38-10.29-4.92,9.1-13.79,15.72-16.25,20.13-15.87,4.14.35,7.49,3.33,8.94,2C118.11,44,110,34.6,112.34,31.7c3-3.67,18.5,8.2,43.37,13.86,12.31,2.8,12,.7,23.93,3.13,20,4.1,49.66,16,49.19,27.5-.5,12.44-18.56,23.26-38.9,33.32-7.12,3.52,2.81,16.54-3.13,23.25-1.71,1.93-4.7,4.2-6.49,3.36-3.7-1.74,2.17-14.62-2.91-19.46-4-3.77-14.22-2.86-17,.9-17,23-37.94,30-40,28.4-1.34-1,4.3-9.65,2-11.63-1.64-1.42-5.91,1.82-6.71.89-1.61-1.85,15.61-15,13.42-20.57-3.63-9.28-59.14,5.47-60.6.45-1-3.47,24.89-12.34,23.7-17.22-.72-3-12.43-7.2-20.79-2.46-18.56,10.51-43.79,29.14-58.36,23.93-5.27-1.88-9.85-6.49-10.29-11.18C1.73,97,36,94.83,37.2,82.68c.84-8.4-14.42-11.41-21.68-30.19C15,51.16,9.45,36.81,13.73,33.71Z";
  const fish9 =
    "M1,111.3C-1.92,105.76,12,99,14.62,80.66,17.68,59.18,1.82,45.85,6.8,40.42c5.67-6.2,26.1,11.3,65.73,20.34,23.43,5.35,44.86,5.75,45.17,4,.25-1.41-13.69-4.28-13.41-6.26.32-2.38,20.77-1.27,30.41-.9,49.63,1.95,101.13-4,101.29-8.49,0-1.21-3.6-3.08-21.24-5.82l42.7-36.67c11.86,9.72,49.84,34,53.22,34.21,119.91,6.55,197.41,29.71,197.54,36.45.05,2.4-13.22,4.91-12.84,6.71s12.65,0,12.84.89c.35,1.67,4.82,12.08-102.73,26.61l-25.94,21.91c-1-9.76-3.38-20.14-7.38-18.55-33.76,13.41-45.56-.31-84.74,6.7l-13.64,11.85-4.48-3.57c-8.19,9.7-18.35,19.58-24.82,17-7.58-3,2-26.38-11.85-30.19-19.45-5.36-44.42-4.76-53.88-2-31.73,9.24-43.09,27-56.35,21.24-9.85-4.31-6.16-15.26-15.43-24.59C81.26,85.41,7.71,124.13,1,111.3Z";

  var rainbow = [
    "hsl(0,100%,50%)",
    "hsl(30,100%,50%)",
    "hsl(60,100%,50%)",
    "hsl(90,100%,50%)",
    "hsl(120,100%,50%)",
    "hsl(150,100%,50%)",
    "hsl(180,100%,50%)",
    "hsl(210,100%,50%)",
    "hsl(240,100%,50%)",
    "hsl(270,100%,50%)",
    "hsl(300,100%,50%)",
    "hsl(330,100%,50%)",
  ];

  const randomColor = (() => {
    "use strict";

    const randomInt = (min, max) => {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    };

    return () => {
      var h = randomInt(0, 360);
      var s = randomInt(42, 98);
      var l = randomInt(40, 90);
      return `hsl(${h},${s}%,${l}%`;
    };
  })();

  let effects = [];
  let bubbles = [];

  let fishCountMeter = new Meter(1, refreshFishCount);

  function onCanvasTapped(x, y) {
    if (tapEffects) {
      bubbles.push(new Bubble(x, y));
    }
  }

  function Bubble(x, y) {
    this.x = x;
    this.y = y;
    this.speed = 1.5;
    this.complete = false;
    this.frames = 0;
    this.diameter = Math.random() * 10 + 5;

    this.Draw = function () {
      ctx.fillStyle = bubbleColor + "44";
      ctx.strokeStyle = bubbleColor + "77";
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.arc(this.x, this.y, this.diameter, 0, 2 * Math.PI);
      ctx.fill();
      ctx.stroke();
      this.y--;

      this.frames++;
    };

    this.IsFinished = function () {
      if (this.frames > 100) {
        tapActive = false;
        return true;
      } else {
        return false;
      }
    };
  }

  function update() {
    fishCountMeter.setValue(fishCount);

    if (effects.length < fishCountMeter.value) {
      effects.push(new Fish(effects.length));
    }

    ctx.fillStyle = bg;
    ctx.fillRect(0, 0, width, height);

    for (i = 0; i < effects.length; i++) {
      effects[i].Draw();
    }

    for (j = 0; j < effects.length; j++) {
      if (effects[j].IsFinished()) {
        effects.splice(j, 1);
      }
    }

    for (i = 0; i < bubbles.length; i++) {
      bubbles[i].Draw();
    }

    for (j = 0; j < bubbles.length; j++) {
      if (bubbles[j].IsFinished()) {
        bubbles.splice(j, 1);
      }
    }

    window.requestAnimationFrame(update);
  }

  window.requestAnimationFrame(update);

  function refreshFishCount() {
    for (j = 0; j < effects.length; j++) {
      if (effects[j].id > fishCountMeter.value - 1) {
        effects.splice(j, 1);
      }
    }
  }

  function Fish(id) {
    this.id = id;
    this.complete = false;
    this.x = Math.random() * 250;
    this.y = Math.random() * 180;
    this.speed = Math.random() * 1 + 0.25;
    this.speedY =
      Math.random() *
      (Math.ceil(Math.random() * 1) * (Math.round(Math.random()) ? 1 : -1));

    this.id = id;

    this.direction = 0;

    this.Draw = function () {
      if (this.x > 360 && this.direction == 0) {
        this.direction = 1;
      } else if (this.x < 0) {
        this.direction = 0;
      }

      if (this.y > 200) {
        this.speedY = -Math.abs(this.speedY);
      } else if (this.y < 0) {
        this.speedY = Math.abs(this.speedY);
      }

      this.y += this.speedY * (speed / 50);

      if (this.direction == 0) {
        if (speed > 0) {
          this.x += this.speed * (speed / 50);
        }
        drawFish(this.id, this.x, this.y, false);
      } else if (this.direction == 1) {
        if (speed > 0) {
          this.x -= this.speed * (speed / 50);
        }
        drawFish(this.id, this.x, this.y, true);
      }
    };

    this.IsFinished = function () {
      return false;
    };
  }

  function drawFish(id, x, y, reverse) {
    var path = new Path2D(fish1);
    switch (id) {
      case 0:
        ctx.fillStyle = "#ff0000";
        path = new Path2D(fish1);
        break;
      case 1:
        var fishPath = new Path2D(fish2);
        var stripePath2 = new Path2D(
          "M98.32,46.38c1.78-3.26,14.21-7.77,12.08-3.73-18.64,35.33-7.31,78.71.89,90.19-3.55-.06-10.39,1.26-13-3.43C85.2,105.56,82.24,75.9,98.32,46.38Z"
        );
        var stripePath3 = new Path2D(
          "M37.06,70.53c1.41-2.92,11.44-3.41,10.13,0-6.5,17-1,34.12.6,33.54-3,1-8.82,3.49-10.73,0C32.73,96.17,32.14,80.66,37.06,70.53Z"
        );
        ctx.translate(x, y);
        if (reverse) {
          ctx.scale(-0.2, 0.2);
        } else {
          ctx.scale(0.2, 0.2);
        }
        ctx.fillStyle = "orange";
        ctx.fill(fishPath);
        ctx.fillStyle = "#ffffff";
        ctx.fill(stripePath2);
        ctx.fill(stripePath3);
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        path = new Path2D(
          "M172,42.5c2.15-2.33,10,1.78,8.2,4-20.87,26.08-13,66.93,1.64,83.18-2.1,1.53-6.51,5.12-9.09,2.68C155.57,116.14,143.34,73.66,172,42.5Z"
        );
        break;
      case 2:
        ctx.fillStyle = "#07FF00";
        path = new Path2D(fish3);
        break;
      case 3:
        ctx.fillStyle = "#ffff00";
        path = new Path2D(fish3);
        break;
      case 4:
        ctx.fillStyle = "#8200FF";
        path = new Path2D(fish4);
        break;
      case 5:
        ctx.fillStyle = "#00ffff";
        path = new Path2D(fish5);
        break;
      case 6:
        ctx.fillStyle = "#ffffff";
        path = new Path2D(fish6);
        break;
      case 7:
        ctx.fillStyle = "#0000ff";
        path = new Path2D(fish7);
        break;
      case 8:
        ctx.fillStyle = "#ff00ff";
        path = new Path2D(fish8);
        break;
      case 9:
        ctx.fillStyle = "#666666";
        path = new Path2D(fish9);
        break;
    }
    ctx.translate(x, y);
    if (reverse) {
      ctx.scale(-0.2, 0.2);
    } else {
      ctx.scale(0.2, 0.2);
    }
    ctx.fill(path);
    ctx.setTransform(1, 0, 0, 1, 0, 0);
  }

  function Meter(count, callback) {
    this.size = count;
    this.value = 0;
    this.diff = 0;
    this.increased = false;
    this.decreased = false;
    var values = [];

    this.setValue = function (updatedValue) {
      // Add and shift.
      values.push(updatedValue);
      if (values.length > this.size) {
        values.shift();
      }

      // Exit early if we've got a long-term match.
      for (var i = 0; i < values.length - 1; i++) {
        if (values[i] !== values[i + 1]) return;
      }

      // We got here, so we've got a matching value collection.
      if (this.value !== values[0]) {
        //var fromZero = this.value === 0;
        //var toZero = values[0] === 0;
        this.diff = Math.abs(this.value - values[0]);
        this.increased = this.value < values[0];
        this.decreased = this.value > values[0];
        this.value = values[0];
        callback();
      }
    };
  }
</script>
